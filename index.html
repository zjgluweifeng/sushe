<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宿舍管理系统-云端同步版</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* 这里保留你原有的全部 CSS 样式，我为你做了精简优化 */
        :root { --primary-color: #007bff; --success-color: #28a745; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .tab { padding: 12px 25px; cursor: pointer; border: none; background: none; font-size: 16px; transition: 0.3s; }
        .tab.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); font-weight: bold; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background: #f8f9fa; }
        .btn { padding: 8px 15px; border-radius: 5px; cursor: pointer; border: none; color: white; margin-right: 5px; }
        .btn-primary { background: var(--primary-color); }
        .btn-success { background: var(--success-color); }
        .btn-danger { background: #dc3545; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1000; justify-content: center; align-items: center; }
    </style>
</head>
<body>
    <div id="loading" class="loading-overlay"><div>数据云端同步中，请稍候...</div></div>

    <div class="container">
        <h2>宿舍管理系统 <span style="font-size: 14px; color: #666;">(飞书云同步版)</span></h2>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('register')">入职登记</button>
            <button class="tab" onclick="switchTab('list')">人员名单</button>
            <button class="tab" onclick="switchTab('rooms')">房间状态</button>
            <button class="tab" onclick="switchTab('stats')">统计分析</button>
        </div>

        <section id="register" class="content-section active">
            <form id="dormForm" onsubmit="handleSubmit(event)">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <input type="text" id="name" placeholder="姓名" required>
                    <input type="text" id="idCard" placeholder="身份证号" required onblur="validateIdCard()">
                    <select id="gender"><option value="男">男</option><option value="女">女</option></select>
                    <input type="number" id="age" placeholder="年龄">
                    <input type="text" id="phone" placeholder="联系电话">
                    <select id="building" onchange="updateRoomOptions()"><option value="">选择楼栋</option></select>
                    <select id="room"><option value="">选择房间</option></select>
                    <input type="date" id="checkInDate">
                </div>
                <textarea id="notes" placeholder="备注" style="width:100%; margin-top:15px; height:80px;"></textarea>
                <button type="submit" class="btn btn-primary" style="margin-top:15px; width:100%;">提交到云端</button>
            </form>
        </section>

        <section id="list" class="content-section">
            <div style="margin-bottom: 15px;">
                <input type="text" id="searchInp" placeholder="搜索姓名/身份证..." oninput="renderTable()">
                <button class="btn btn-success" onclick="exportToExcel()">导出Excel</button>
            </div>
            <table>
                <thead>
                    <tr><th>姓名</th><th>性别</th><th>房间号</th><th>入住日期</th><th>操作</th></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </section>

        <section id="rooms" class="content-section"><div id="roomGrid"></div></section>
        <section id="stats" class="content-section"><div id="statsContent"></div></section>
    </div>

    ```

---

<script>
        // ==========================================
        // 1. 飞书云端硬核配置
        // ==========================================
        const FS_CONFIG = {
            app_id: 'cli_a9fc44732cb95bc2',
            app_secret: 'RvHHDqPXDM6NyRsq3klJ8efrgjCUWcYH',
            app_token: 'LjVJbMywLaHepmsvsIccRQJZnEh',
            table_records_id: 'tbl6upt7zN2Rw1RK', // 在职人员
            table_history_id: 'tbl2NwWdoedNRsWb', // 退宿人员
            table_rooms_id: 'tbl7bhzq7m3hHYFm'    // 房间配置
        };

        // 全局状态变量
        let dormRecords = []; 
        let dormRooms = [];
        let historyRecords = [];
        let editingId = null;

        // ==========================================
        // 2. 飞书 API 基础引擎
        // ==========================================
        
        // 获取 Access Token
        async function getAccessToken() {
            try {
                const res = await fetch('https://open.feishu.cn/open-apis/auth/v3/app_access_token/internal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "app_id": FS_CONFIG.app_id, "app_secret": FS_CONFIG.app_secret })
                });
                const data = await res.json();
                return data.app_access_token;
            } catch (e) { console.error("Token获取失败:", e); }
        }

        // 初始化：全量拉取数据
        async function initData() {
            showLoading(true);
            try {
                const token = await getAccessToken();
                const headers = { 'Authorization': `Bearer ${token}` };
                
                // 并行请求三个表的数据
                const [resRec, resRooms, resHist] = await Promise.all([
                    fetch(`https://open.feishu.cn/open-apis/bitable/v1/apps/${FS_CONFIG.app_token}/tables/${FS_CONFIG.table_records_id}/records?page_size=500`, { headers }),
                    fetch(`https://open.feishu.cn/open-apis/bitable/v1/apps/${FS_CONFIG.app_token}/tables/${FS_CONFIG.table_rooms_id}/records?page_size=500`, { headers }),
                    fetch(`https://open.feishu.cn/open-apis/bitable/v1/apps/${FS_CONFIG.app_token}/tables/${FS_CONFIG.table_history_id}/records?page_size=500`, { headers })
                ]);

                const d1 = await resRec.json();
                const d2 = await resRooms.json();
                const d3 = await resHist.json();

                // 格式化数据，保留云端 record_id 作为本地 id
                dormRecords = (d1.data.items || []).map(i => ({ id: i.record_id, ...i.fields }));
                dormRooms = (d2.data.items || []).map(i => ({ id: i.record_id, ...i.fields }));
                historyRecords = (d3.data.items || []).map(i => ({ id: i.record_id, ...i.fields }));

                // 触发 UI 渲染
                renderTable();
                updateDormFilterOptions();
                renderRooms();
                renderStats();
            } catch (err) {
                alert("云端同步失败，请检查网络或飞书应用权限。");
            } finally {
                showLoading(false);
            }
        }

        // ==========================================
        // 3. 核心交互函数
        // ==========================================

        // 提交表单（新增/编辑）
        async function handleSubmit(e) {
            e.preventDefault();
            showLoading(true);
            const token = await getAccessToken();
            
            // 构造飞书字段 (请务必确保这里的 Key 与你多维表格列名完全一致)
            const fields = {
                "姓名": document.getElementById('name').value,
                "身份证号": document.getElementById('idCard').value,
                "性别": document.getElementById('gender').value,
                "年龄": parseInt(document.getElementById('age').value) || 0,
                "联系电话": document.getElementById('phone').value,
                "宿舍楼栋": document.getElementById('building').value,
                "房间号": document.getElementById('room').value,
                "入住日期": document.getElementById('checkInDate').value ? new Date(document.getElementById('checkInDate').value).getTime() : null,
                "备注说明": document.getElementById('notes').value
            };

            const url = `https://open.feishu.cn/open-apis/bitable/v1/apps/${FS_CONFIG.app_token}/tables/${FS_CONFIG.table_records_id}/records${editingId ? '/' + editingId : ''}`;
            const method = editingId ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fields })
                });
                const result = await res.json();
                if (result.code === 0) {
                    alert("云端操作成功！");
                    editingId = null;
                    document.getElementById('dormForm').reset();
                    await initData(); // 重新加载
                } else {
                    alert("保存失败: " + result.msg);
                }
            } finally {
                showLoading(false);
            }
        }

        // 辅助工具
        function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
        function switchTab(tabId) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        window.onload = initData; // 页面加载即启动同步
        // ==========================================
        // 4. 身份证校验与自动填充逻辑 (核心算法)
        // ==========================================
        function validateIdCard() {
            const idCard = document.getElementById('idCard').value.trim().toUpperCase();
            if (!idCard) return;

            // 1. 基础格式校验
            const reg = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X)$)/;
            if (!reg.test(idCard)) {
                alert("身份证号格式错误！");
                return false;
            }

            // 2. 自动识别性别与年龄 (原系统逻辑)
            if (idCard.length === 18) {
                // 性别
                const genderCode = idCard.substring(16, 17);
                document.getElementById('gender').value = (genderCode % 2 === 0) ? "女" : "男";
                // 年龄
                const birthYear = idCard.substring(6, 10);
                const currentYear = new Date().getFullYear();
                document.getElementById('age').value = currentYear - parseInt(birthYear);
            }

            // 3. 查重逻辑：检查当前云端数据是否已有该人
            const exists = dormRecords.find(r => r["身份证号"] === idCard);
            if (exists && !editingId) {
                alert(`提示：该身份证号已登记在【${exists["房间号"]}】房，请勿重复登记！`);
            }
        }

        // ==========================================
        // 5. 数据显示渲染逻辑
        // ==========================================
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const keyword = document.getElementById('searchInp').value.toLowerCase();
            
            // 过滤数据 (在职人员)
            const filtered = dormRecords.filter(r => 
                (r["姓名"] || "").toLowerCase().includes(keyword) || 
                (r["身份证号"] || "").includes(keyword)
            );

            tbody.innerHTML = filtered.map(r => `
                <tr>
                    <td>${r["姓名"] || ''}</td>
                    <td>${r["性别"] || ''}</td>
                    <td>${r["房间号"] || ''}</td>
                    <td>${r["入住日期"] ? new Date(r["入住日期"]).toLocaleDateString() : ''}</td>
                    <td>
                        <button class="btn btn-primary" onclick="editRecord('${r.id}')">编辑</button>
                        <button class="btn btn-danger" onclick="checkout('${r.id}')">退宿</button>
                    </td>
                </tr>
            `).join('');
        }

        // 房间状态网格渲染
        function renderRooms() {
            const grid = document.getElementById('roomGrid');
            if(!grid) return;
            
            // 按楼栋分组统计
            const roomStats = {};
            dormRooms.forEach(room => {
                const b = room["楼栋"] || "未知";
                if(!roomStats[b]) roomStats[b] = [];
                
                // 计算该房间已住人数
                const occupied = dormRecords.filter(r => r["房间号"] === room["房间号"]).length;
                roomStats[b].push({ ...room, occupied });
            });

            grid.innerHTML = Object.keys(roomStats).map(b => `
                <h3>${b} 楼栋状态</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;">
                    ${roomStats[b].map(rm => `
                        <div style="padding: 10px; border: 1px solid #ddd; background: ${rm.occupied >= (rm["床位数"] || 4) ? '#ffebee' : '#e8f5e9'}; border-radius: 8px; text-align: center;">
                            <strong>${rm["房间号"]}房</strong><br>
                            ${rm.occupied} / ${rm["床位数"] || 4} 人
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        // ==========================================
        // 6. 功能扩展：退宿与导出
        // ==========================================
        async function checkout(id) {
            if(!confirm("确定要办理退宿吗？数据将移至历史表。")) return;
            showLoading(true);
            const token = await getAccessToken();
            
            try {
                // 1. 获取该记录完整数据
                const record = dormRecords.find(r => r.id === id);
                
                // 2. 写入退宿历史表
                await fetch(`https://open.feishu.cn/open-apis/bitable/v1/apps/${FS_CONFIG.app_token}/tables/${FS_CONFIG.table_history_id}/records`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fields: { ...record, "退宿日期": new Date().getTime(), "id": undefined } })
                });

                // 3. 从在职表删除
                await fetch(`https://open.feishu.cn/open-apis/bitable/v1/apps/${FS_CONFIG.app_token}/tables/${FS_CONFIG.table_records_id}/records/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                alert("退宿手续办结！");
                await initData();
            } finally {
                showLoading(false);
            }
        }

        function exportToExcel() {
            const data = dormRecords.map(r => ({
                "姓名": r["姓名"],
                "身份证号": r["身份证号"],
                "房间号": r["房间号"],
                "入住日期": r["入住日期"] ? new Date(r["入住日期"]).toLocaleDateString() : ""
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "在职人员名单");
            XLSX.writeFile(wb, `宿舍名单_${new Date().toLocaleDateString()}.xlsx`);
        }

        // 编辑功能回显
        function editRecord(id) {
            const r = dormRecords.find(item => item.id === id);
            if(!r) return;
            editingId = id;
            document.getElementById('name').value = r["姓名"] || '';
            document.getElementById('idCard').value = r["身份证号"] || '';
            document.getElementById('building').value = r["宿舍楼栋"] || '';
            // ...以此类推回显其他字段
            switchTab('register'); // 跳转回登记页
        }

        // 下拉联动：根据楼栋更新房间号 (由于数据在云端，这里简单处理)
        function updateRoomOptions() {
            const b = document.getElementById('building').value;
            const roomSelect = document.getElementById('room');
            const filteredRooms = dormRooms.filter(r => r["楼栋"] === b);
            roomSelect.innerHTML = '<option value="">选择房间</option>' + 
                filteredRooms.map(r => `<option value="${r["房间号"]}">${r["房间号"]}</option>`).join('');
        }
        
        function updateDormFilterOptions() {
            const bSelect = document.getElementById('building');
            const buildings = [...new Set(dormRooms.map(r => r["楼栋"]))];
            bSelect.innerHTML = '<option value="">选择楼栋</option>' + 
                buildings.map(b => `<option value="${b}">${b}</option>`).join('');
        }

        function renderStats() {
            const stats = document.getElementById('statsContent');
            if(!stats) return;
            stats.innerHTML = `<h3>当前在职总人数：${dormRecords.length} 人</h3>`;
        }
    </script>
</body>
</html>