<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宿舍住宿人员管理系统</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* 动态渐变背景 */
        body { 
            font-family: 'Microsoft YaHei', Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh; 
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* 背景装饰元素 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            position: relative;
            z-index: 1;
        }
        
        /* 毛玻璃卡片效果 */
        .card { 
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        h1 { 
            color: #fff; 
            font-size: 32px; 
            margin-bottom: 20px; 
            text-align: center;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-weight: 700;
        }
        
        h2 { 
            color: #fff; 
            font-size: 24px; 
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        h3 { 
            color: rgba(255,255,255,0.95); 
            font-size: 18px; 
            margin: 20px 0 10px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* 按钮毛玻璃效果 */
        .btn { 
            padding: 12px 24px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
            white-space: nowrap;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.9), rgba(56, 142, 60, 0.9));
            color: white;
        }
        
        .btn-info { 
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.9), rgba(25, 118, 210, 0.9));
            color: white;
        }
        
        .btn-warning { 
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.9), rgba(245, 124, 0, 0.9));
            color: white;
        }
        
        .btn-danger { 
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.9), rgba(211, 47, 47, 0.9));
            color: white;
        }
        
        .btn-secondary { 
            background: linear-gradient(135deg, rgba(108, 117, 125, 0.9), rgba(73, 80, 87, 0.9));
            color: white;
        }
        
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* 标签页毛玻璃效果 */
        .tabs { 
            display: flex; 
            gap: 12px; 
            margin-bottom: 20px; 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch;
            padding: 5px;
        }
        
        .tab { 
            flex: 1;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 120px;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tab:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }
        
        .tab.active { 
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.9), rgba(25, 118, 210, 0.9));
            color: white;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
        }
        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        
        .form-group { display: flex; flex-direction: column; }
        
        .form-group label { 
            font-weight: 600; 
            margin-bottom: 8px; 
            font-size: 14px;
            color: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .form-group input, .form-group select, .form-group textarea { 
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            font-size: 14px;
            width: 100%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: #fff;
            transition: all 0.3s ease;
        }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.25);
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
        }
        
        .error { color: #ff6b6b; font-size: 12px; margin-top: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .success { color: #51cf66; font-size: 12px; margin-top: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 20px; }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 800px;
        }
        
        th, td { 
            padding: 14px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.95);
        }
        
        th { 
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        tr:hover { 
            background: rgba(255, 255, 255, 0.08);
        }
        
        .hidden { display: none !important; }
        
        .stats { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 20px; 
            margin-bottom: 20px;
        }
        
        .stat-card { 
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .stat-value { 
            font-size: 36px; 
            font-weight: 700; 
            margin: 10px 0;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        /* 模态框毛玻璃效果 */
        .modal { 
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 10px;
        }
        
        .modal.active { display: flex; }
        
        .modal-content { 
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 35px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
        }
        .checkbox-wrapper { display: flex; align-items: center; justify-content: center; }
        .checkbox-wrapper input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .batch-actions { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        .selected-count { background: #fff3cd; padding: 8px 15px; border-radius: 6px; font-weight: bold; color: #856404; font-size: 14px; }
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .bed-stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px; }
        .bed-stat-item { background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3; }
        .bed-stat-header { font-weight: bold; font-size: 16px; margin-bottom: 10px; color: #333; }
        .bed-stat-details { display: flex; justify-content: space-between; margin-top: 8px; font-size: 14px; }
        .bed-stat-label { color: #666; }
        .bed-stat-value { font-weight: bold; }
        .occupied { color: #f44336; }
        .available { color: #4CAF50; }
        .progress-bar { 
            width: 100%; 
            height: 10px; 
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 5px; 
            margin-top: 10px; 
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.25);
        }
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, rgba(76, 175, 80, 0.9), rgba(33, 150, 243, 0.9));
            transition: width 0.3s;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
        }
        .building-section { margin-bottom: 30px; }
        
        /* 平面图样式 */
        .floorplan-building { margin-bottom: 40px; }
        .floorplan-header { 
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white; 
            padding: 18px 24px; 
            border-radius: 15px 15px 0 0; 
            font-size: 20px; 
            font-weight: 700;
            text-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .floorplan-rooms { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
            gap: 20px; 
            padding: 25px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 0 0 15px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-top: none;
        }
        .room-card { 
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 12px; 
            padding: 18px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .room-card:hover { 
            transform: translateY(-6px); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            border-color: rgba(255, 255, 255, 0.5);
        }
        .room-card.full { 
            border-color: rgba(244, 67, 54, 0.6); 
            background: rgba(255, 235, 238, 0.2);
        }
        .room-card.empty { 
            border-color: rgba(76, 175, 80, 0.6); 
            background: rgba(232, 245, 233, 0.2);
        }
        .room-card.partial { 
            border-color: rgba(255, 152, 0, 0.6); 
            background: rgba(255, 243, 224, 0.2);
        }
        .room-number { 
            font-size: 22px; 
            font-weight: 700; 
            color: #fff;
            margin-bottom: 10px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .room-status { 
            font-size: 14px; 
            color: rgba(255, 255, 255, 0.85);
            margin-bottom: 8px;
            font-weight: 500;
        }
        .room-beds { 
            font-size: 13px; 
            color: rgba(255, 255, 255, 0.8);
        }
        .room-badge { 
            position: absolute; 
            top: 12px; 
            right: 12px; 
            padding: 6px 12px; 
            border-radius: 8px; 
            font-size: 11px; 
            font-weight: 700; 
            color: white;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .room-badge.full { background: rgba(244, 67, 54, 0.9); }
        .room-badge.empty { background: rgba(76, 175, 80, 0.9); }
        .room-badge.partial { background: rgba(255, 152, 0, 0.9); }
        
        /* 房间详情模态框样式 */
        .room-detail-modal .modal-content { max-width: 750px; }
        .resident-list { margin-top: 15px; }
        .resident-item { 
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            padding: 15px; 
            margin-bottom: 12px; 
            border-radius: 10px; 
            border-left: 4px solid rgba(33, 150, 243, 0.8);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .resident-name { 
            font-weight: 700; 
            font-size: 16px; 
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 8px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .resident-info { 
            font-size: 13px; 
            color: rgba(255, 255, 255, 0.8);
            display: flex; 
            gap: 15px; 
            flex-wrap: wrap; 
        }
        .bed-visual { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); 
            gap: 12px; 
            margin: 15px 0; 
        }
        .bed-item { 
            padding: 14px; 
            text-align: center; 
            border-radius: 10px; 
            font-size: 13px; 
            font-weight: 600;
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        .bed-item:hover {
            transform: scale(1.05);
        }
        .bed-item.occupied { 
            background: rgba(255, 235, 238, 0.3);
            border-color: rgba(244, 67, 54, 0.6);
            color: #fff;
            box-shadow: 0 0 15px rgba(244, 67, 54, 0.3);
        }
        .bed-item.empty { 
            background: rgba(232, 245, 233, 0.3);
            border-color: rgba(76, 175, 80, 0.6);
            color: #fff;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
        }
        
        /* 登录界面样式 */
        .login-container { 
            max-width: 480px; 
            margin: 100px auto; 
            padding: 0 20px;
        }
        
        .login-card { 
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 50px 40px;
            border-radius: 25px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.2);
        }
        
        .login-title { 
            text-align: center; 
            color: #fff; 
            margin-bottom: 30px; 
            font-size: 26px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .login-form { 
            display: flex; 
            flex-direction: column; 
            gap: 20px;
        }
        
        .login-form input { 
            padding: 15px 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            font-size: 15px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: #fff;
            transition: all 0.3s ease;
        }
        
        .login-form input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .login-form input:focus {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.25);
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
        }
        
        .login-form button { 
            padding: 15px;
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.9), rgba(25, 118, 210, 0.9));
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .login-form button:hover { 
            background: linear-gradient(135deg, rgba(25, 118, 210, 1), rgba(21, 101, 192, 1));
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(33,150,243,0.4);
        }
        
        /* 用户信息栏 */
        .user-info { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 20px 25px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .user-name { font-weight: bold; color: #333; }
        .user-role { background: #4CAF50; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px; margin-left: 10px; }
        .user-role.viewer { background: #FF9800; }
        .sync-status { display: flex; align-items: center; gap: 10px; }
        .sync-indicator { width: 10px; height: 10px; border-radius: 50%; background: #4CAF50; }
        .sync-indicator.syncing { background: #FF9800; animation: pulse 1s infinite; }
        .sync-indicator.error { background: #f44336; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* 移动端适配 */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .card { padding: 15px; }
            h1 { font-size: 20px; margin-bottom: 15px; }
            h2 { font-size: 18px; margin-bottom: 10px; }
            h3 { font-size: 16px; margin: 15px 0 8px 0; }
            .tabs { gap: 5px; padding-bottom: 5px; }
            .tab { padding: 10px 8px; font-size: 12px; min-width: 70px; }
            .form-grid { grid-template-columns: 1fr; gap: 10px; }
            .stats { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .stat-card { padding: 12px; }
            .stat-card > div:first-child { font-size: 12px; }
            .stat-value { font-size: 24px; }
            .btn { padding: 8px 12px; font-size: 12px; margin: 3px; }
            .toolbar { flex-direction: column; align-items: stretch; }
            .toolbar > * { width: 100%; margin: 5px 0; }
            .batch-actions { justify-content: flex-start; }
            .bed-stats-grid { grid-template-columns: 1fr; }
            table { min-width: 600px; font-size: 12px; }
            th, td { padding: 6px 4px; font-size: 12px; }
            .modal-content { padding: 20px; width: 95%; }
            .selected-count { font-size: 12px; padding: 6px 10px; }
        }
        
        @media (max-width: 480px) {
            body { padding: 5px; }
            .card { padding: 10px; border-radius: 8px; }
            h1 { font-size: 18px; margin-bottom: 10px; }
            h2 { font-size: 16px; margin-bottom: 8px; }
            h3 { font-size: 14px; margin: 10px 0 6px 0; }
            .tab { font-size: 11px; padding: 8px 5px; min-width: 60px; }
            .stat-card { padding: 10px; }
            .stat-card > div:first-child { font-size: 11px; }
            .stat-value { font-size: 20px; }
            .btn { padding: 6px 10px; font-size: 11px; margin: 2px; }
            table { min-width: 500px; font-size: 11px; }
            th, td { padding: 5px 3px; font-size: 11px; }
            .form-group label { font-size: 12px; }
            .form-group input, .form-group select, .form-group textarea { font-size: 12px; padding: 8px; }
            .bed-stat-header { font-size: 14px; }
            .bed-stat-details { font-size: 12px; }
        }
    </style>
</head>
<body>
    <!-- 登录界面 -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <!-- 公司抬头 -->
            <div style="text-align: center; margin-bottom: 35px;">
                <h1 style="font-size: 24px; color: #fff; margin-bottom: 10px; font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,0.2);"><i class="fas fa-building"></i> 江苏常阴沙现代农业发展有限公司</h1>
                <h2 style="font-size: 18px; color: rgba(255,255,255,0.9); font-weight: 500; text-shadow: 0 1px 5px rgba(0,0,0,0.15);"><i class="fas fa-home"></i> 住宿人员管理系统</h2>
            </div>
            
            <div class="login-form">
                <input type="text" id="loginUsername" placeholder="👤 用户名" onkeypress="if(event.key==='Enter')handleLogin()" />
                <input type="password" id="loginPassword" placeholder="🔒 密码" onkeypress="if(event.key==='Enter')handleLogin()" />
                <button onclick="handleLogin()"><i class="fas fa-sign-in-alt"></i> 登录</button>
            </div>
        </div>
    </div>

    <!-- 初始设置Modal -->
    <div id="initialSetupModal" class="modal">
        <div class="modal-content">
            <h2>🔐 首次使用设置</h2>
            <p style="color: #666; margin: 15px 0;">请为管理员账号设置安全密码</p>
            <div class="form-group">
                <label>管理员用户名</label>
                <input type="text" id="setupAdminUsername" value="admin" readonly style="background: #f5f5f5;">
            </div>
            <div class="form-group">
                <label>管理员密码 *</label>
                <input type="password" id="setupAdminPassword" placeholder="至少6位字符">
            </div>
            <div class="form-group">
                <label>确认密码 *</label>
                <input type="password" id="setupAdminPasswordConfirm" placeholder="再次输入密码">
            </div>
            <hr style="margin: 20px 0;">
            <div class="form-group">
                <label>查看者用户名</label>
                <input type="text" id="setupViewerUsername" value="viewer" readonly style="background: #f5f5f5;">
            </div>
            <div class="form-group">
                <label>查看者密码 *</label>
                <input type="password" id="setupViewerPassword" placeholder="至少6位字符">
            </div>
            <div class="form-group">
                <label>确认密码 *</label>
                <input type="password" id="setupViewerPasswordConfirm" placeholder="再次输入密码">
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="completeInitialSetup()">完成设置</button>
            </div>
            <div style="margin-top: 15px; padding: 10px; background: #f0f8ff; border-radius: 6px; font-size: 12px;">
                <strong>提示：</strong>请妥善保管您的密码，设置完成后将无法查看默认密码
            </div>
        </div>
    </div>

    <!-- 主应用界面 -->
    <div id="mainApp" class="hidden">
    <div class="container">
        <!-- 公司抬头 - 置顶 -->
        <div class="card" id="companyHeader">
            <h1>江苏常阴沙现代农业发展有限公司</h1>
            <h2 style="text-align: center; color: #666; margin-top: 10px;">住宿人员管理系统</h2>
        </div>

        <!-- 用户信息栏 -->
        <div class="user-info">
            <div>
                <span class="user-name" id="currentUserName">用户</span>
                <span class="user-role" id="currentUserRole">角色</span>
            </div>
            <div class="sync-status">
                <span id="syncStatusText">未同步</span>
                <span class="sync-indicator" id="syncIndicator"></span>
                <button class="btn btn-info" onclick="syncData()" id="syncBtn"><i class="fas fa-sync-alt"></i> 同步数据</button>
                <button class="btn btn-info" onclick="showImport()"><i class="fas fa-file-upload"></i> 批量导入</button>
                <button class="btn btn-primary" onclick="exportExcel()"><i class="fas fa-file-download"></i> 导出Excel</button>
                <button class="btn btn-secondary" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> 退出</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('register')"><i class="fas fa-user-plus"></i> 人员登记</button>
            <button class="tab" onclick="switchTab('list')"><i class="fas fa-users"></i> 人员列表</button>
            <button class="tab" onclick="switchTab('checkout')"><i class="fas fa-user-minus"></i> 退宿人员</button>
            <button class="tab" onclick="switchTab('rooms')"><i class="fas fa-door-open"></i> 房间管理</button>
            <button class="tab" onclick="switchTab('floorplan')"><i class="fas fa-map"></i> 宿舍平面图</button>
            <button class="tab" onclick="switchTab('stats')"><i class="fas fa-chart-line"></i> 数据概览</button>
            <button class="tab" onclick="switchTab('settings')"><i class="fas fa-cog"></i> 系统设置</button>
        </div>

        <!-- 登记表单 -->
        <div id="registerTab" class="card">
            <h2 id="formTitle">新增人员登记</h2>
            <div id="adminOnlyMessage" class="hidden" style="padding: 20px; background: #fff3cd; border-radius: 6px; text-align: center;">
                ⚠️ 只有管理员才能进行人员登记操作
            </div>
            <form onsubmit="handleSubmit(event)" id="registerForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>姓名 *</label>
                        <input type="text" id="name" required>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label>身份证号 *</label>
                        <input type="text" id="idCard" maxlength="18" required oninput="validateIdCard()">
                        <span id="idError" class="error hidden"></span>
                        <span id="idSuccess" class="success hidden"></span>
                    </div>
                    <div class="form-group">
                        <label>性别</label>
                        <input type="text" id="gender" readonly>
                    </div>
                    <div class="form-group">
                        <label>出生日期</label>
                        <input type="text" id="birthDate" readonly>
                    </div>
                    <div class="form-group">
                        <label>年龄</label>
                        <input type="text" id="age" readonly>
                    </div>
                    <div class="form-group">
                        <label>联系电话 *</label>
                        <input type="tel" id="phone" required>
                    </div>
                    <div class="form-group" style="grid-column: span 3;">
                        <label>家庭地址</label>
                        <input type="text" id="address">
                    </div>
                    <div class="form-group">
                        <label>民族</label>
                        <input type="text" id="ethnicity">
                    </div>
                    <div class="form-group">
                        <label>来源单位</label>
                        <input type="text" id="sourceUnit">
                    </div>
                    <div class="form-group">
                        <label>入职部门</label>
                        <input type="text" id="department">
                    </div>
                    <div class="form-group">
                        <label>宿舍楼栋</label>
                        <select id="building" onchange="updateRoomOptions()">
                            <option value="">请选择楼栋</option>
                            <option value="宿舍二楼">宿舍二楼</option>
                            <option value="宿舍三楼">宿舍三楼</option>
                            <option value="办公三楼">办公三楼</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>房间号</label>
                        <select id="room">
                            <option value="">请先选择楼栋</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>床位号</label>
                        <input type="text" id="bed">
                    </div>
                    <div class="form-group">
                        <label>入住日期</label>
                        <input type="date" id="checkInDate">
                    </div>
                    <div class="form-group">
                        <label>紧急联系人</label>
                        <input type="text" id="emergencyContact">
                    </div>
                    <div class="form-group">
                        <label>紧急联系电话</label>
                        <input type="tel" id="emergencyPhone">
                    </div>
                    <div class="form-group">
                        <label>离职日期</label>
                        <input type="date" id="resignDate">
                    </div>
                    <div class="form-group">
                        <label>交割手续</label>
                        <select id="handover">
                            <option value="">请选择</option>
                            <option value="已完成">已完成</option>
                            <option value="未完成">未完成</option>
                            <option value="进行中">进行中</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: span 3;">
                        <label>备注说明</label>
                        <textarea id="notes" rows="3"></textarea>
                    </div>
                </div>
                <button type="submit" class="btn btn-info" id="submitBtn">💾 确定保存</button>
                <button type="button" class="btn btn-warning hidden" id="cancelBtn" onclick="cancelEdit()">取消编辑</button>
            </form>
        </div>

        <!-- 人员列表 -->
        <div id="listTab" class="card hidden">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                <h2 style="margin: 0;">在住人员列表</h2>
                <input type="text" id="search" placeholder="搜索姓名、身份证号、电话..." style="flex:1;max-width:300px;padding:10px;border:1px solid #ddd;border-radius:6px;" oninput="filterRecords()">
                <select id="dormFilter" style="padding:10px;border:1px solid #ddd;border-radius:6px;min-width:200px;" onchange="filterRecords()">
                    <option value="">全部宿舍</option>
                </select>
                <div class="batch-actions" id="batchActions" style="display:none;">
                    <span class="selected-count">已选择 <span id="selectedCount">0</span> 条</span>
                    <button class="btn btn-warning" onclick="batchCheckout()"><i class="fas fa-sign-out-alt"></i> 批量退宿</button>
                    <button class="btn btn-danger" onclick="batchDelete()"><i class="fas fa-trash-alt"></i> 批量删除</button>
                    <button class="btn btn-secondary" onclick="clearSelection()"><i class="fas fa-times"></i> 取消选择</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th style="width:50px;">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </div>
                        </th>
                        <th>序号</th>
                        <th>姓名</th>
                        <th>性别</th>
                        <th>年龄</th>
                        <th>电话</th>
                        <th>部门</th>
                        <th>宿舍</th>
                        <th>入住日期</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <!-- 退宿人员 -->
        <div id="checkoutTab" class="card hidden">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                <h2 style="margin: 0;">退宿人员列表</h2>
                <input type="text" id="searchCheckout" placeholder="搜索姓名、身份证号、电话..." style="flex:1;max-width:400px;padding:10px;border:1px solid #ddd;border-radius:6px;" oninput="filterCheckoutRecords()">
                <div class="batch-actions" id="batchActionsCheckout" style="display:none;">
                    <span class="selected-count">已选择 <span id="selectedCountCheckout">0</span> 条</span>
                    <button class="btn btn-danger" onclick="batchDeleteCheckout()">🗑️ 批量删除</button>
                    <button class="btn btn-secondary" onclick="clearSelectionCheckout()">取消选择</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th style="width:50px;">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="selectAllCheckout" onchange="toggleSelectAllCheckout()">
                            </div>
                        </th>
                        <th>序号</th>
                        <th>姓名</th>
                        <th>性别</th>
                        <th>电话</th>
                        <th>部门</th>
                        <th>原宿舍</th>
                        <th>入住日期</th>
                        <th>退宿日期</th>
                        <th>离职日期</th>
                        <th>交割手续</th>
                        <th>退宿原因</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="checkoutTableBody"></tbody>
            </table>
        </div>

        <!-- 房间管理 -->
        <div id="roomsTab" class="card hidden">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                <h2 style="margin: 0;">房间管理</h2>
                <button class="btn btn-primary" onclick="showAddRoom()">➕ 添加房间</button>
                <div class="batch-actions" id="batchActionsRooms" style="display:none;">
                    <span class="selected-count">已选择 <span id="selectedCountRooms">0</span> 条</span>
                    <button class="btn btn-danger" onclick="batchDeleteRooms()">🗑️ 批量删除</button>
                    <button class="btn btn-secondary" onclick="clearSelectionRooms()">取消选择</button>
                </div>
            </div>
            
            <div id="roomsContainer"></div>
        </div>

        <!-- 宿舍平面图 -->
        <div id="floorplanTab" class="card hidden">
            <h2>宿舍平面图</h2>
            <p style="color: #666; margin-bottom: 20px;">点击房间查看详细入住情况</p>
            <div id="floorplanContainer"></div>
        </div>

        <!-- 数据概览 -->
        <div id="statsTab" class="card hidden">
            <h2>数据总览</h2>
            <div class="stats">
                <div class="stat-card">
                    <div>总人次</div>
                    <div class="stat-value" style="color:#2196F3;" id="total">0</div>
                </div>
                <div class="stat-card">
                    <div>在住人数</div>
                    <div class="stat-value" style="color:#4CAF50;" id="active">0</div>
                </div>
                <div class="stat-card">
                    <div>已退宿</div>
                    <div class="stat-value" style="color:#FF9800;" id="checkout">0</div>
                </div>
                <div class="stat-card">
                    <div>楼层数</div>
                    <div class="stat-value" style="color:#9C27B0;" id="buildings">0</div>
                </div>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div>总房间数</div>
                    <div class="stat-value" style="color:#00BCD4;" id="totalRooms">0</div>
                </div>
                <div class="stat-card">
                    <div>总床位数</div>
                    <div class="stat-value" style="color:#FF5722;" id="totalBeds">0</div>
                </div>
                <div class="stat-card">
                    <div>已入住床位</div>
                    <div class="stat-value" style="color:#f44336;" id="occupiedBeds">0</div>
                    <div style="font-size:12px;color:#666;margin-top:8px;">
                        普通 <span id="occupiedBedsNormal" style="font-weight:bold;color:#f44336;">0</span> | 
                        管理 <span id="occupiedBedsManager" style="font-weight:bold;color:#9C27B0;">0</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div>剩余床位</div>
                    <div class="stat-value" style="color:#4CAF50;" id="availableBeds">0</div>
                    <div style="font-size:12px;color:#666;margin-top:8px;">
                        普通 <span id="availableBedsNormal" style="font-weight:bold;color:#4CAF50;">0</span> | 
                        管理 <span id="availableBedsManager" style="font-weight:bold;color:#9C27B0;">0</span>
                    </div>
                </div>
            </div>

            <h2 style="margin-top: 30px; margin-bottom: 10px; color: #333; font-size: 22px;">📊 房型概况</h2>
            <div id="roomTypeStatsContainer"></div>

            <h2 style="margin-top: 40px; margin-bottom: 10px; color: #333; font-size: 22px;">🛏️ 床位使用情况</h2>
            <div id="bedStatsContainer"></div>
        </div>

        <!-- 新增：系统设置页 -->
        <div id="settingsTab" class="card hidden">
            <h2>系统设置</h2>
            <div class="form-grid" style="grid-template-columns: 1fr;">
                <div class="form-group">
                    <label>GitHub Token (用于数据同步)</label>
                    <input type="password" id="githubToken" placeholder="输入您的GitHub Personal Access Token">
                    <small style="color: #666;">创建Token: GitHub设置 → Developer settings → Personal access tokens → Generate new token (需要gist权限)</small>
                </div>
                <div class="form-group">
                    <label>Gist ID (留空将自动创建)</label>
                    <input type="text" id="gistId" placeholder="可选：输入现有Gist ID">
                </div>
                <div>
                    <button class="btn btn-primary" onclick="saveGitHubConfig()">保存配置</button>
                    <button class="btn btn-info" onclick="testGitHubConnection()">测试连接</button>
                </div>
            </div>
            
            <hr style="margin: 30px 0;" id="userManagementDivider">
            
            <div id="userManagementSection">
                <h3>用户管理</h3>
                <div id="adminOnlySettings" class="hidden" style="padding: 20px; background: #fff3cd; border-radius: 6px; text-align: center;">
                    ⚠️ 只有管理员才能管理用户
                </div>
                <div id="userManagement">
                    <p style="color: #666; margin-bottom: 15px;">管理员可以修改用户密码和权限</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>用户名</label>
                            <select id="manageUsername">
                                <option value="admin">admin (管理员)</option>
                                <option value="viewer">viewer (查看者)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>新密码</label>
                            <input type="password" id="newPassword" placeholder="输入新密码">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-warning" onclick="changePassword()" style="margin-top: 24px;">修改密码</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 导入模态框 -->
        <div id="importModal" class="modal">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">批量导入数据（支持多Sheet）</h3>
                    <button onclick="closeImport()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #999; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.3s;" onmouseover="this.style.backgroundColor='#f0f0f0'; this.style.color='#333';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#999';" title="关闭">&times;</button>
                </div>
                <p style="margin:15px 0;">请上传Excel文件，支持以下两种格式：</p>
                <p style="margin:5px 0;color:#2196F3;">✅ <strong>推荐：</strong>包含3个Sheet的完整数据表格（在职人员、退宿人员、房间管理）</p>
                <p style="margin:5px 0;color:#666;">✅ 单个Sheet的人员数据表格</p>
                <p style="margin:15px 0;color:#ff9800;font-weight:bold;">⚠️ 批量导入已关闭身份证号格式验证，可导入任意格式数据</p>
                <p style="margin:5px 0;color:#4CAF50;font-size:14px;">💡 提示：使用"导出Excel"功能导出的文件可以直接导入</p>
                <input type="file" accept=".xlsx,.xls" onchange="handleImport(event)" style="margin-bottom:15px;">
                <button class="btn btn-danger" onclick="closeImport()">关闭</button>
            </div>
        </div>

        <!-- 退宿人员导入模态框 -->
        <div id="importCheckoutModal" class="modal">
            <div class="modal-content">
                <h3>批量导入退宿人员</h3>
                <p style="margin:15px 0;">请上传Excel文件,支持包含以下列:姓名、身份证号、联系电话、部门、退宿日期、退宿原因等信息</p>
                <p style="margin:15px 0;color:#ff9800;font-weight:bold;">⚠️ 批量导入已关闭身份证号格式验证,可导入任意格式数据</p>
                <input type="file" accept=".xlsx,.xls" onchange="handleImportCheckout(event)" style="margin-bottom:15px;">
                <button class="btn btn-danger" onclick="closeImportCheckout()">关闭</button>
            </div>
        </div>

        <!-- 批量退宿模态框 -->
        <div id="batchCheckoutModal" class="modal">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">批量退宿</h3>
                    <button onclick="closeBatchCheckout()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #999; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.3s;" onmouseover="this.style.backgroundColor='#f0f0f0'; this.style.color='#333';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#999';" title="关闭">&times;</button>
                </div>
                <p style="margin:15px 0;">已选择 <strong id="batchCheckoutCount">0</strong> 人</p>
                <div class="form-group">
                    <label>退宿原因</label>
                    <textarea id="batchCheckoutReason" rows="3" placeholder="请输入退宿原因..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;"></textarea>
                </div>
                <div style="margin-top:20px;">
                    <button class="btn btn-warning" onclick="confirmBatchCheckout()">确定退宿</button>
                    <button class="btn btn-secondary" onclick="closeBatchCheckout()">取消</button>
                </div>
            </div>
        </div>

        <!-- 添加/编辑房间模态框 -->
        <div id="roomModal" class="modal">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 id="roomModalTitle" style="margin: 0;">添加房间</h3>
                    <button onclick="closeRoomModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #999; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.3s;" onmouseover="this.style.backgroundColor='#f0f0f0'; this.style.color='#333';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#999';" title="关闭">&times;</button>
                </div>
                <form onsubmit="saveRoom(event)">
                    <div class="form-group">
                        <label>楼栋 *</label>
                        <select id="roomBuilding" required>
                            <option value="">请选择楼栋</option>
                            <option value="宿舍二楼">宿舍二楼</option>
                            <option value="宿舍三楼">宿舍三楼</option>
                            <option value="办公三楼">办公三楼</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>房间号 *</label>
                        <input type="text" id="roomNumber" required placeholder="例如: 201">
                    </div>
                    <div class="form-group">
                        <label>床位数 *</label>
                        <input type="number" id="roomBeds" required min="1" placeholder="例如: 4">
                    </div>
                    <div class="form-group">
                        <label>备注</label>
                        <textarea id="roomNotes" rows="2" placeholder="可选填写房间备注信息"></textarea>
                    </div>
                    <div style="margin-top:20px;">
                        <button type="submit" class="btn btn-primary">保存</button>
                        <button type="button" class="btn btn-secondary" onclick="closeRoomModal()">取消</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 房间详情模态框 -->
        <div id="roomDetailModal" class="modal room-detail-modal">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 id="roomDetailTitle" style="margin: 0;">房间详情</h3>
                    <button onclick="closeRoomDetail()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #999; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.3s;" onmouseover="this.style.backgroundColor='#f0f0f0'; this.style.color='#333';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#999';" title="关闭">&times;</button>
                </div>
                <div id="roomDetailContent"></div>
                <div style="margin-top:20px;">
                    <button class="btn btn-secondary" onclick="closeRoomDetail()">关闭</button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        // ========== 全局变量 ==========
        let records = JSON.parse(localStorage.getItem('dormRecords') || '[]');
        let rooms = JSON.parse(localStorage.getItem('dormRooms') || '[]');
        let editingId = null;
        let editingRoomId = null;
        let selectedIds = new Set();
        let selectedCheckoutIds = new Set();
        let currentUser = null;
        let githubConfig = {
            token: '',
            gistId: ''
        };

        // ========== 用户认证系统 ==========
        const defaultUsers = {
            admin: { password: 'admin123', role: 'admin', name: '管理员' },
            viewer: { password: 'viewer123', role: 'viewer', name: '查看者' }
        };

        function checkFirstTimeUse() {
            // 从localStorage读取users数据
            const savedUsers = JSON.parse(localStorage.getItem('users') || '{}');
            
            // 检查是否有任何用户（从云端或本地加载的）
            const hasUsers = Object.keys(savedUsers).length > 0;
            
            // 只有在users对象为空（云端和本地都没有用户数据）时才需要设置密码
            if (!hasUsers) {
                // 显示设置界面让用户初始化系统
                openModal('setupModal');
                return true;
            }
            // 如果有用户数据（从云端或本地加载），直接返回false，不显示设置界面
            return false;
        }

        function showInitialSetup() {
            const modal = document.getElementById('initialSetupModal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        async function completeInitialSetup() {
            const adminPassword = document.getElementById('setupAdminPassword').value.trim();
            const adminPasswordConfirm = document.getElementById('setupAdminPasswordConfirm').value.trim();
            const viewerPassword = document.getElementById('setupViewerPassword').value.trim();
            const viewerPasswordConfirm = document.getElementById('setupViewerPasswordConfirm').value.trim();
            
            if (!adminPassword || !viewerPassword) {
                alert('请填写所有密码');
                return;
            }
            
            if (adminPassword.length < 6 || viewerPassword.length < 6) {
                alert('密码长度至少为6位');
                return;
            }
            
            if (adminPassword !== adminPasswordConfirm) {
                alert('管理员密码两次输入不一致');
                return;
            }
            
            if (viewerPassword !== viewerPasswordConfirm) {
                alert('查看者密码两次输入不一致');
                return;
            }
            
            const newUsers = {
                admin: { password: adminPassword, role: 'admin', name: '管理员' },
                viewer: { password: viewerPassword, role: 'viewer', name: '查看者' }
            };
            
            localStorage.setItem('users', JSON.stringify(newUsers));
            localStorage.setItem('systemInitialized', 'true');
            
            document.getElementById('initialSetupModal').classList.remove('active');
            document.getElementById('firstTimeSetup').classList.add('hidden');
            
            // 立即同步到云端
            const config = JSON.parse(localStorage.getItem('githubConfig') || '{}');
            if (config.token) {
                await syncToGitHub();
                alert('设置完成并已同步到云端！请使用新密码登录');
            } else {
                alert('设置完成！请使用新密码登录\n\n提示：建议在"系统设置"中配置GitHub同步，这样其他设备就能自动获取密码');
            }
            
            // 清空输入框
            document.getElementById('setupAdminPassword').value = '';
            document.getElementById('setupAdminPasswordConfirm').value = '';
            document.getElementById('setupViewerPassword').value = '';
            document.getElementById('setupViewerPasswordConfirm').value = '';
        }

        function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                alert('请输入用户名和密码');
                return;
            }
            
            // 获取已保存的用户，如果没有则使用默认用户
            const savedUsers = JSON.parse(localStorage.getItem('users') || JSON.stringify(defaultUsers));
            
            if (savedUsers[username] && savedUsers[username].password === password) {
                currentUser = {
                    username: username,
                    role: savedUsers[username].role,
                    name: savedUsers[username].name
                };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showMainApp();
            } else {
                alert('用户名或密码错误');
            }
        }

        function handleLogout() {
            console.log('=== handleLogout called ==='); // 调试日志
            if (confirm('确定要退出登录吗？')) {
                console.log('✓ User confirmed logout'); // 调试日志
                currentUser = null;
                localStorage.removeItem('currentUser');
                console.log('→ Calling showLoginScreen()...'); // 调试日志
                showLoginScreen();
            } else {
                console.log('✗ User cancelled logout'); // 调试日志
            }
        }

        function showLoginScreen() {
            console.log('=== showLoginScreen called ==='); // 调试日志
            
            // 获取元素
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            
            console.log('📍 Elements found:');
            console.log('  - loginScreen:', loginScreen ? '✓' : '✗'); // 调试日志
            console.log('  - mainApp:', mainApp ? '✓' : '✗'); // 调试日志
            
            console.log('📍 Before changes:');
            console.log('  - loginScreen classes:', loginScreen?.className); // 调试日志
            console.log('  - mainApp classes:', mainApp?.className); // 调试日志
            
            // 显示登录界面，隐藏主应用
            if (loginScreen) {
                loginScreen.classList.remove('hidden');
                loginScreen.style.display = ''; // 确保没有inline style覆盖
            }
            
            if (mainApp) {
                mainApp.classList.add('hidden');
            }
            
            console.log('📍 After changes:');
            console.log('  - loginScreen classes:', loginScreen?.className); // 调试日志
            console.log('  - mainApp classes:', mainApp?.className); // 调试日志
            
            // 清空登录表单
            const usernameInput = document.getElementById('loginUsername');
            const passwordInput = document.getElementById('loginPassword');
            if (usernameInput) usernameInput.value = '';
            if (passwordInput) passwordInput.value = '';
            
            // 重置所有标签页为默认状态
            document.querySelectorAll('.tab').forEach((t, i) => {
                if (i === 0) {
                    t.classList.add('active');
                } else {
                    t.classList.remove('active');
                }
            });
            
            // 隐藏所有内容卡片，只显示第一个（登记表单）
            document.querySelectorAll('.card').forEach(c => {
                if (!c.classList.contains('login-card') && 
                    !c.classList.contains('user-info') && 
                    c.id !== 'companyHeader') {
                    c.classList.add('hidden');
                }
            });
            
            // 显示登记表单
            const registerTab = document.getElementById('registerTab');
            if (registerTab) {
                registerTab.classList.remove('hidden');
            }
            
            console.log('=== showLoginScreen completed ==='); // 调试日志
        }

        function showMainApp() {
            console.log('=== showMainApp called ==='); // 调试日志
            
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            
            console.log('📍 Before changes:');
            console.log('  - loginScreen classes:', loginScreen?.className);
            console.log('  - mainApp classes:', mainApp?.className);
            
            // 隐藏登录界面
            if (loginScreen) {
                loginScreen.classList.add('hidden');
            }
            
            // 显示主应用
            if (mainApp) {
                mainApp.classList.remove('hidden');
            }
            
            console.log('📍 After changes:');
            console.log('  - loginScreen classes:', loginScreen?.className);
            console.log('  - mainApp classes:', mainApp?.className);
            
            // 更新用户信息
            const userNameElement = document.getElementById('currentUserName');
            const roleElement = document.getElementById('currentUserRole');
            
            if (userNameElement && currentUser) {
                userNameElement.textContent = currentUser.name;
            }
            
            if (roleElement && currentUser) {
                roleElement.textContent = currentUser.role === 'admin' ? '管理员' : '查看者';
                roleElement.className = 'user-role' + (currentUser.role === 'viewer' ? ' viewer' : '');
            }
            
            // 根据用户角色显示默认标签页
            console.log('→ Calling switchTab...');
            if (currentUser.role === 'viewer') {
                switchTab('list'); // viewer默认显示人员列表
            } else {
                switchTab('register'); // admin默认显示人员登记
            }
            
            updateUIPermissions();
            loadData();
            
            console.log('=== showMainApp completed ==='); // 调试日志
        }

        function updateUIPermissions() {
            if (!currentUser) return; // 如果没有当前用户，直接返回
            
            const isAdmin = currentUser.role === 'admin';
            
            // 控制人员登记标签的显示
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                if (tab.textContent.includes('人员登记') && !isAdmin) {
                    tab.style.display = 'none';
                }
            });
            
            // 控制人员登记表单
            const registerForm = document.getElementById('registerForm');
            const adminOnlyMessage = document.getElementById('adminOnlyMessage');
            
            if (registerForm && adminOnlyMessage) {
                if (!isAdmin) {
                    registerForm.classList.add('hidden');
                    adminOnlyMessage.classList.remove('hidden');
                } else {
                    registerForm.classList.remove('hidden');
                    adminOnlyMessage.classList.add('hidden');
                }
            }
            
            // 控制用户管理整个区域的显示（包括标题和分隔线）
            const userManagementSection = document.getElementById('userManagementSection');
            const userManagementDivider = document.getElementById('userManagementDivider');
            
            if (userManagementSection) {
                userManagementSection.style.display = isAdmin ? 'block' : 'none';
            }
            if (userManagementDivider) {
                userManagementDivider.style.display = isAdmin ? 'block' : 'none';
            }
            
            // 控制导出导入按钮
            const importBtn = document.querySelector('button[onclick="showImport()"]');
            const exportBtn = document.querySelector('button[onclick="exportExcel()"]');
            const syncBtn = document.getElementById('syncBtn');
            
            if (importBtn) {
                importBtn.style.display = isAdmin ? 'inline-block' : 'none';
            }
            if (exportBtn) {
                exportBtn.style.display = isAdmin ? 'inline-block' : 'none';
            }
            if (syncBtn) {
                syncBtn.style.display = isAdmin ? 'inline-block' : 'none';
            }
        }

        async function changePassword() {
            if (currentUser.role !== 'admin') {
                alert('只有管理员才能修改密码');
                return;
            }
            
            const username = document.getElementById('manageUsername').value;
            const newPassword = document.getElementById('newPassword').value.trim();
            
            if (!newPassword) {
                alert('请输入新密码');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('密码长度至少为6位');
                return;
            }
            
            const savedUsers = JSON.parse(localStorage.getItem('users') || JSON.stringify(defaultUsers));
            savedUsers[username].password = newPassword;
            localStorage.setItem('users', JSON.stringify(savedUsers));
            
            // 自动同步到云端
            const synced = await syncToGitHub();
            
            if (synced) {
                alert(`用户 ${username} 的密码已修改并同步到云端`);
            } else {
                alert(`用户 ${username} 的密码已修改（本地保存成功，但未同步到云端，请检查GitHub配置）`);
            }
            
            document.getElementById('newPassword').value = '';
        }

        // ========== GitHub数据同步 ==========
        function saveGitHubConfig() {
            const token = document.getElementById('githubToken').value.trim();
            const gistId = document.getElementById('gistId').value.trim();
            
            if (!token) {
                alert('请输入GitHub Token');
                return;
            }
            
            githubConfig = { token, gistId };
            localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
            alert('GitHub配置已保存');
        }

        async function testGitHubConnection() {
            const config = JSON.parse(localStorage.getItem('githubConfig') || '{}');
            if (!config.token) {
                alert('请先配置GitHub Token');
                return;
            }
            
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`连接成功！\n用户：${data.login}\n邮箱：${data.email || '未设置'}`);
                } else {
                    alert('连接失败，请检查Token是否正确');
                }
            } catch (error) {
                alert('连接失败：' + error.message);
            }
        }

        // 同步到GitHub的简化函数（用于密码修改等操作）
        async function syncToGitHub() {
            const config = JSON.parse(localStorage.getItem('githubConfig') || '{}');
            if (!config.token || !config.gistId) {
                console.log('GitHub未配置，跳过自动同步');
                return false;
            }
            
            try {
                // 获取用户数据
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                const systemInitialized = localStorage.getItem('systemInitialized') === 'true';
                
                const data = {
                    records: records,
                    rooms: rooms,
                    users: users,
                    systemInitialized: systemInitialized,
                    lastSync: new Date().toISOString()
                };
                
                // 更新现有Gist
                const updateResponse = await fetch(`https://api.github.com/gists/${config.gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: {
                            'dormitory-data.json': {
                                content: JSON.stringify(data, null, 2)
                            }
                        }
                    })
                });
                
                if (!updateResponse.ok) {
                    throw new Error('更新Gist失败');
                }
                
                console.log('✅ 密码已自动同步到云端');
                return true;
            } catch (error) {
                console.error('自动同步失败:', error);
                return false;
            }
        }

        async function syncData() {
            if (currentUser.role !== 'admin') {
                alert('只有管理员可以同步数据');
                return;
            }
            const config = JSON.parse(localStorage.getItem('githubConfig') || '{}');
            if (!config.token) {
                alert('请先在系统设置中配置GitHub Token');
                switchTab('settings');
                return;
            }
            
            updateSyncStatus('syncing', '同步中...');
            
            try {
                // 获取用户数据
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                const systemInitialized = localStorage.getItem('systemInitialized') === 'true';
                
                const data = {
                    records: records,
                    rooms: rooms,
                    users: users,  // 新增：同步用户密码
                    systemInitialized: systemInitialized,  // 新增：同步初始化状态
                    lastSync: new Date().toISOString()
                };
                
                let gistId = config.gistId;
                
                if (!gistId) {
                    // 创建新的Gist
                    const createResponse = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            description: '宿舍管理系统数据备份',
                            public: false,
                            files: {
                                'dormitory-data.json': {
                                    content: JSON.stringify(data, null, 2)
                                }
                            }
                        })
                    });
                    
                    if (!createResponse.ok) {
                        throw new Error('创建Gist失败');
                    }
                    
                    const createData = await createResponse.json();
                    gistId = createData.id;
                    
                    // 保存Gist ID
                    config.gistId = gistId;
                    localStorage.setItem('githubConfig', JSON.stringify(config));
                    document.getElementById('gistId').value = gistId;
                } else {
                    // 更新现有Gist
                    const updateResponse = await fetch(`https://api.github.com/gists/${gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            files: {
                                'dormitory-data.json': {
                                    content: JSON.stringify(data, null, 2)
                                }
                            }
                        })
                    });
                    
                    if (!updateResponse.ok) {
                        throw new Error('更新Gist失败');
                    }
                }
                
                updateSyncStatus('success', '同步成功');
                setTimeout(() => updateSyncStatus('idle', '已同步'), 2000);
            } catch (error) {
                console.error('同步失败:', error);
                updateSyncStatus('error', '同步失败');
                alert('数据同步失败：' + error.message);
            }
        }

        async function loadFromGitHub() {
            const config = JSON.parse(localStorage.getItem('githubConfig') || '{}');
            if (!config.token || !config.gistId) {
                return false;
            }
            
            try {
                const response = await fetch(`https://api.github.com/gists/${config.gistId}`, {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    return false;
                }
                
                const gist = await response.json();
                const fileContent = gist.files['dormitory-data.json'].content;
                const data = JSON.parse(fileContent);
                
                records = data.records || [];
                rooms = data.rooms || [];
                
                // 恢复用户数据和初始化状态
                if (data.users) {
                    localStorage.setItem('users', JSON.stringify(data.users));
                }
                if (data.systemInitialized) {
                    localStorage.setItem('systemInitialized', 'true');
                }
                
                // 同时保存到localStorage作为缓存
                localStorage.setItem('dormRecords', JSON.stringify(records));
                localStorage.setItem('dormRooms', JSON.stringify(rooms));
                
                updateSyncStatus('success', '已从云端加载');
                return true;
            } catch (error) {
                console.error('从GitHub加载失败:', error);
                return false;
            }
        }

        async function loadUsersFromGitHub() {
            const config = JSON.parse(localStorage.getItem('githubConfig') || '{}');
            if (!config.token || !config.gistId) {
                return false;
            }
            
            try {
                const response = await fetch(`https://api.github.com/gists/${config.gistId}`, {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    return false;
                }
                
                const gist = await response.json();
                const fileContent = gist.files['dormitory-data.json'].content;
                const data = JSON.parse(fileContent);
                
                // 只恢复用户数据和初始化状态
                if (data.users && Object.keys(data.users).length > 0) {
                    localStorage.setItem('users', JSON.stringify(data.users));
                    localStorage.setItem('systemInitialized', 'true');
                    console.log('✅ 已从云端加载用户数据');
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('从GitHub加载用户数据失败:', error);
                return false;
            }
        }

        function updateSyncStatus(status, text) {
            const indicator = document.getElementById('syncIndicator');
            const statusText = document.getElementById('syncStatusText');
            
            // 如果元素不存在，直接返回（可能在登录界面）
            if (!indicator || !statusText) {
                return;
            }
            
            indicator.className = 'sync-indicator';
            if (status === 'syncing') {
                indicator.classList.add('syncing');
            } else if (status === 'error') {
                indicator.classList.add('error');
            }
            
            statusText.textContent = text;
        }

        // ========== 数据加载 ==========
        async function loadData() {
            // 先尝试从GitHub加载
            const loaded = await loadFromGitHub();
            
            // 如果GitHub加载失败，从localStorage加载
            if (!loaded) {
                records = JSON.parse(localStorage.getItem('dormRecords') || '[]');
                rooms = JSON.parse(localStorage.getItem('dormRooms') || '[]');
            }
            
            // 加载GitHub配置
            const config = JSON.parse(localStorage.getItem('githubConfig') || '{}');
            if (config.token) {
                document.getElementById('githubToken').value = config.token;
            }
            if (config.gistId) {
                document.getElementById('gistId').value = config.gistId;
            }
            githubConfig = config;
        }

        function switchTab(tabOrEvent, tab) {
            // 兼容两种调用方式：switchTab('register') 或 switchTab(event, 'register')
            let targetTab;
            let sourceButton = null;
            
            if (typeof tabOrEvent === 'string') {
                // 直接传入tab名称
                targetTab = tabOrEvent;
                // 不依赖window.event，而是通过tab名称找到按钮
            } else if (tabOrEvent && tabOrEvent.target) {
                // 传入event对象
                targetTab = tab;
                sourceButton = tabOrEvent.target;
            } else {
                // 容错处理
                targetTab = tabOrEvent || tab;
            }
            
            // 移除所有标签的active状态
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            // 隐藏所有内容卡片（除了特殊的）
            document.querySelectorAll('.card').forEach(c => {
                // 不隐藏登录卡片、用户信息栏和公司抬头
                if (!c.classList.contains('login-card') && 
                    !c.classList.contains('user-info') && 
                    c.id !== 'companyHeader') {
                    c.classList.add('hidden');
                }
            });
            
            // 设置当前标签为active
            if (sourceButton) {
                // 如果有明确的按钮元素
                sourceButton.classList.add('active');
            } else {
                // 通过tab名称找到对应按钮
                document.querySelectorAll('.tab').forEach(t => {
                    const onclick = t.getAttribute('onclick');
                    if (onclick && onclick.includes("'" + targetTab + "'")) {
                        t.classList.add('active');
                    }
                });
            }
            
            // 显示对应的内容
            const tabElement = document.getElementById(targetTab + 'Tab');
            if (tabElement) {
                tabElement.classList.remove('hidden');
            }
            
            // 特定标签页的初始化操作
            if (targetTab === 'list') {
                clearSelection();
                updateDormFilterOptions();
                renderTable();
            }
            if (targetTab === 'checkout') {
                clearSelectionCheckout();
                renderCheckoutTable();
            }
            if (targetTab === 'rooms') {
                renderRooms();
                // 根据用户角色显示/隐藏添加房间按钮
                const addRoomBtn = document.querySelector('#roomsTab button.btn-primary');
                if (addRoomBtn) {
                    addRoomBtn.style.display = currentUser.role === 'admin' ? 'inline-block' : 'none';
                }
            }
            if (targetTab === 'floorplan') {
                renderFloorPlan();
            }
            if (targetTab === 'stats') {
                renderStats();
                renderRoomTypeStats();
                renderBedStats();
            }
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            const activeRecords = records.filter(r => !r.checkOutDate);
            const search = document.getElementById('search').value.toLowerCase();
            const dormFilter = document.getElementById('dormFilter').value;
            
            let filtered = activeRecords.filter(r => 
                r.name.toLowerCase().includes(search) || 
                r.idCard.includes(search) || 
                r.phone.includes(search)
            );
            
            // 应用宿舍筛选
            if (dormFilter) {
                filtered = filtered.filter(r => {
                    const dormKey = `${r.building || ''}-${r.room || ''}`;
                    return dormKey === dormFilter;
                });
            }
            
            if (selectAll) {
                filtered.forEach(r => selectedIds.add(r.id));
            } else {
                selectedIds.clear();
            }
            updateBatchActions();
            renderTable();
        }

        function toggleSelect(id) {
            if (selectedIds.has(id)) {
                selectedIds.delete(id);
            } else {
                selectedIds.add(id);
            }
            updateBatchActions();
            renderTable();
        }

        function updateBatchActions() {
            const count = selectedIds.size;
            document.getElementById('selectedCount').textContent = count;
            
            // 根据用户角色显示批量操作按钮
            const batchActionsDiv = document.getElementById('batchActions');
            if (count > 0) {
                batchActionsDiv.style.display = 'flex';
                // 如果是viewer，隐藏批量退宿和批量删除按钮
                if (currentUser.role === 'viewer') {
                    batchActionsDiv.innerHTML = `
                        <span class="selected-count">已选择 <span id="selectedCount">${count}</span> 条</span>
                        <button class="btn btn-secondary" onclick="clearSelection()">取消选择</button>
                        <span style="color:#999;margin-left:10px;">仅查看权限</span>
                    `;
                } else {
                    batchActionsDiv.innerHTML = `
                        <span class="selected-count">已选择 <span id="selectedCount">${count}</span> 条</span>
                        <button class="btn btn-warning" onclick="batchCheckout()">🚪 批量退宿</button>
                        <button class="btn btn-danger" onclick="batchDelete()">🗑️ 批量删除</button>
                        <button class="btn btn-secondary" onclick="clearSelection()">取消选择</button>
                    `;
                }
            } else {
                batchActionsDiv.style.display = 'none';
            }
            
            const activeRecords = records.filter(r => !r.checkOutDate);
            const search = document.getElementById('search').value.toLowerCase();
            const dormFilter = document.getElementById('dormFilter').value;
            
            let filtered = activeRecords.filter(r => 
                r.name.toLowerCase().includes(search) || 
                r.idCard.includes(search) || 
                r.phone.includes(search)
            );
            
            // 应用宿舍筛选
            if (dormFilter) {
                filtered = filtered.filter(r => {
                    const dormKey = `${r.building || ''}-${r.room || ''}`;
                    return dormKey === dormFilter;
                });
            }
            
            const allSelected = filtered.length > 0 && filtered.every(r => selectedIds.has(r.id));
            document.getElementById('selectAll').checked = allSelected;
        }

        function clearSelection() {
            selectedIds.clear();
            updateBatchActions();
            renderTable();
        }

        function batchDelete() {
            // 检查viewer权限
            if (currentUser.role === 'viewer') {
                alert('您没有权限批量删除记录');
                return;
            }
            
            if (selectedIds.size === 0) return;
            
            if (confirm(`确定删除选中的 ${selectedIds.size} 条记录吗?删除后无法恢复!`)) {
                records = records.filter(r => !selectedIds.has(r.id));
                localStorage.setItem('dormRecords', JSON.stringify(records));
                selectedIds.clear();
                updateBatchActions();
                renderTable();
                alert('批量删除成功!');
            }
        }

        function batchCheckout() {
            // 检查viewer权限
            if (currentUser.role === 'viewer') {
                alert('您没有权限批量退宿');
                return;
            }
            
            if (selectedIds.size === 0) return;
            
            document.getElementById('batchCheckoutCount').textContent = selectedIds.size;
            document.getElementById('batchCheckoutReason').value = '';
            document.getElementById('batchCheckoutModal').classList.add('active');
        }

        function closeBatchCheckout() {
            document.getElementById('batchCheckoutModal').classList.remove('active');
        }

        function confirmBatchCheckout() {
            const reason = document.getElementById('batchCheckoutReason').value.trim();
            
            if (!reason) {
                alert('请输入退宿原因!');
                return;
            }

            const checkoutDate = new Date().toLocaleDateString();
            const count = selectedIds.size;
            
            // 获取当前日期的YYYY-MM-DD格式（用于离职日期字段）
            const today = new Date();
            const resignDateFormat = today.getFullYear() + '-' + 
                                    String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                                    String(today.getDate()).padStart(2, '0');
            
            console.log('=== 批量退宿开始 ===');
            console.log('退宿日期:', checkoutDate);
            console.log('自动填充的离职日期格式:', resignDateFormat);
            
            records = records.map(r => {
                if (selectedIds.has(r.id)) {
                    // 如果没有离职日期,自动设置为今天的日期（YYYY-MM-DD格式）
                    const resignDate = r.resignDate || resignDateFormat;
                    console.log(`处理: ${r.name}, 原离职日期: ${r.resignDate || '无'}, 新离职日期: ${resignDate}`);
                    return {...r, checkOutDate: checkoutDate, checkOutReason: reason, resignDate: resignDate};
                }
                return r;
            });

            localStorage.setItem('dormRecords', JSON.stringify(records));
            console.log('=== 数据已保存到localStorage ===');
            
            selectedIds.clear();
            updateBatchActions();
            renderTable();
            renderCheckoutTable(); // 同时更新退宿人员表格
            closeBatchCheckout();
            alert(`批量退宿成功! 共 ${count} 人`);
        }

        function toggleSelectAllCheckout() {
            const selectAll = document.getElementById('selectAllCheckout').checked;
            const checkoutRecords = records.filter(r => r.checkOutDate);
            const search = document.getElementById('searchCheckout').value.toLowerCase();
            const filtered = checkoutRecords.filter(r => 
                r.name.toLowerCase().includes(search) || 
                r.idCard.includes(search) || 
                r.phone.includes(search)
            );
            
            if (selectAll) {
                filtered.forEach(r => selectedCheckoutIds.add(r.id));
            } else {
                selectedCheckoutIds.clear();
            }
            updateBatchActionsCheckout();
            renderCheckoutTable();
        }

        function toggleSelectCheckout(id) {
            if (selectedCheckoutIds.has(id)) {
                selectedCheckoutIds.delete(id);
            } else {
                selectedCheckoutIds.add(id);
            }
            updateBatchActionsCheckout();
            renderCheckoutTable();
        }

        function updateBatchActionsCheckout() {
            const count = selectedCheckoutIds.size;
            document.getElementById('selectedCountCheckout').textContent = count;
            
            // 根据用户角色显示批量操作按钮
            const batchActionsDiv = document.getElementById('batchActionsCheckout');
            if (count > 0) {
                batchActionsDiv.style.display = 'flex';
                // 如果是viewer，隐藏批量删除按钮
                if (currentUser.role === 'viewer') {
                    batchActionsDiv.innerHTML = `
                        <span class="selected-count">已选择 <span id="selectedCountCheckout">${count}</span> 条</span>
                        <button class="btn btn-secondary" onclick="clearSelectionCheckout()">取消选择</button>
                        <span style="color:#999;margin-left:10px;">仅查看权限</span>
                    `;
                } else {
                    batchActionsDiv.innerHTML = `
                        <span class="selected-count">已选择 <span id="selectedCountCheckout">${count}</span> 条</span>
                        <button class="btn btn-danger" onclick="batchDeleteCheckout()">🗑️ 批量删除</button>
                        <button class="btn btn-secondary" onclick="clearSelectionCheckout()">取消选择</button>
                    `;
                }
            } else {
                batchActionsDiv.style.display = 'none';
            }
            
            const checkoutRecords = records.filter(r => r.checkOutDate);
            const search = document.getElementById('searchCheckout').value.toLowerCase();
            const filtered = checkoutRecords.filter(r => 
                r.name.toLowerCase().includes(search) || 
                r.idCard.includes(search) || 
                r.phone.includes(search)
            );
            
            const allSelected = filtered.length > 0 && filtered.every(r => selectedCheckoutIds.has(r.id));
            document.getElementById('selectAllCheckout').checked = allSelected;
        }

        function clearSelectionCheckout() {
            selectedCheckoutIds.clear();
            updateBatchActionsCheckout();
            renderCheckoutTable();
        }

        function batchDeleteCheckout() {
            // 检查viewer权限
            if (currentUser.role === 'viewer') {
                alert('您没有权限批量删除退宿人员');
                return;
            }
            
            if (selectedCheckoutIds.size === 0) return;
            
            if (confirm(`确定删除选中的 ${selectedCheckoutIds.size} 条退宿记录吗?删除后无法恢复!`)) {
                records = records.filter(r => !selectedCheckoutIds.has(r.id));
                localStorage.setItem('dormRecords', JSON.stringify(records));
                selectedCheckoutIds.clear();
                updateBatchActionsCheckout();
                renderCheckoutTable();
                alert('批量删除成功!');
            }
        }

        function validateIdCard() {
            const id = document.getElementById('idCard').value.toUpperCase();
            document.getElementById('idCard').value = id;
            const err = document.getElementById('idError');
            const suc = document.getElementById('idSuccess');
            err.classList.add('hidden');
            suc.classList.add('hidden');

            if (id.length !== 18) {
                // 清空性别、年龄信息
                if (id.length === 0) {
                    document.getElementById('gender').value = '';
                    document.getElementById('birthDate').value = '';
                    document.getElementById('age').value = '';
                }
                return;
            }

            if (!/^\d{17}[\dX]$/.test(id)) {
                err.textContent = '身份证号格式错误';
                err.classList.remove('hidden');
                return;
            }

            const weights = [7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2];
            const codes = ['1','0','X','9','8','7','6','5','4','3','2'];
            let sum = 0;
            for (let i = 0; i < 17; i++) sum += parseInt(id[i]) * weights[i];
            if (id[17] !== codes[sum % 11]) {
                err.textContent = '身份证号校验码错误';
                err.classList.remove('hidden');
                return;
            }

            // 先提取性别、出生日期和年龄信息
            const gender = parseInt(id[16]) % 2 === 1 ? '男' : '女';
            const year = parseInt(id.substring(6, 10));
            const month = id.substring(10, 12);
            const day = id.substring(12, 14);
            const birthDate = `${year}-${month}-${day}`;
            const age = new Date().getFullYear() - year;
            
            // 自动填充性别、出生日期和年龄
            document.getElementById('gender').value = gender;
            document.getElementById('birthDate').value = birthDate;
            document.getElementById('age').value = age;

            // 检查该身份证号的历史记录（包括已退宿的）
            const historyRecords = records.filter(r => r.idCard === id && r.id !== editingId);
            const checkoutRecords = historyRecords.filter(r => r.checkOutDate);
            
            // 如果有离职历史，自动在备注中添加信息
            if (checkoutRecords.length > 0) {
                let historyText = `【离职历史】曾离职${checkoutRecords.length}次：`;
                checkoutRecords.forEach((record, index) => {
                    const resignDate = record.resignDate || record.checkOutDate || '未记录';
                    const checkoutReason = record.checkOutReason ? ` (原因：${record.checkOutReason})` : '';
                    historyText += `\n  ${index + 1}. 离职日期：${resignDate}${checkoutReason}`;
                });
                
                // 获取当前备注内容
                const currentNotes = document.getElementById('notes').value.trim();
                
                // 移除旧的离职历史信息（如果存在）
                let userNotes = currentNotes;
                if (currentNotes.includes('【离职历史】')) {
                    // 提取用户手动填写的部分（离职历史之后的内容）
                    const parts = currentNotes.split('【离职历史】');
                    if (parts.length > 1) {
                        const afterHistory = parts[1];
                        const nextSection = afterHistory.split(/\n\n[^\n]/);
                        if (nextSection.length > 1) {
                            // 找到离职历史后面的第一个双换行，那之后的是用户备注
                            const match = afterHistory.match(/\n\n(.+)/s);
                            userNotes = match ? match[1].trim() : '';
                        } else {
                            userNotes = '';
                        }
                    } else {
                        userNotes = parts[0].trim();
                    }
                }
                
                // 组合新的备注内容
                if (userNotes) {
                    document.getElementById('notes').value = historyText + '\n\n' + userNotes;
                } else {
                    document.getElementById('notes').value = historyText;
                }
            }

            // 检查是否有在职记录（未退宿的）
            const activeRecords = historyRecords.filter(r => !r.checkOutDate);
            if (activeRecords.length > 0) {
                err.textContent = '该身份证号已登记（当前在职）';
                err.classList.remove('hidden');
                return;
            }

            suc.textContent = checkoutRecords.length > 0 ? 
                `✓ 验证通过（检测到${checkoutRecords.length}次离职记录，已自动添加到备注）` : 
                '✓ 验证通过';
            suc.classList.remove('hidden');
        }

        function handleSubmit(e) {
            e.preventDefault();
            
            // 权限检查
            if (currentUser && currentUser.role !== 'admin') {
                alert('只有管理员才能添加或编辑人员');
                return;
            }
            
            const data = {
                id: editingId || Date.now(),
                name: document.getElementById('name').value,
                idCard: document.getElementById('idCard').value,
                gender: document.getElementById('gender').value,
                birthDate: document.getElementById('birthDate').value,
                age: document.getElementById('age').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                ethnicity: document.getElementById('ethnicity').value,
                sourceUnit: document.getElementById('sourceUnit').value,
                department: document.getElementById('department').value,
                building: document.getElementById('building').value,
                room: document.getElementById('room').value,
                bed: document.getElementById('bed').value,
                checkInDate: document.getElementById('checkInDate').value,
                emergencyContact: document.getElementById('emergencyContact').value,
                emergencyPhone: document.getElementById('emergencyPhone').value,
                resignDate: document.getElementById('resignDate').value,
                handover: document.getElementById('handover').value,
                notes: document.getElementById('notes').value,
                recordTime: new Date().toLocaleString()
            };

            if (editingId) {
                records = records.map(r => r.id === editingId ? data : r);
                alert('修改成功!');
            } else {
                records.push(data);
                alert('保存成功!');
            }

            localStorage.setItem('dormRecords', JSON.stringify(records));
            resetForm();
        }

        function resetForm() {
            document.querySelector('form').reset();
            document.getElementById('gender').value = '';
            document.getElementById('birthDate').value = '';
            document.getElementById('age').value = '';
            document.getElementById('idError').classList.add('hidden');
            document.getElementById('idSuccess').classList.add('hidden');
            document.getElementById('cancelBtn').classList.add('hidden');
            document.getElementById('formTitle').textContent = '新增人员登记';
            editingId = null;
            
            // 恢复表单字段的启用状态和提交按钮显示
            const formInputs = document.querySelectorAll('#registerForm input, #registerForm select, #registerForm textarea');
            formInputs.forEach(input => input.disabled = false);
            document.getElementById('submitBtn').style.display = 'inline-block';
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const search = document.getElementById('search').value.toLowerCase();
            const dormFilter = document.getElementById('dormFilter').value;
            const activeRecords = records.filter(r => !r.checkOutDate);
            
            let filtered = activeRecords.filter(r => 
                r.name.toLowerCase().includes(search) || 
                r.idCard.includes(search) || 
                r.phone.includes(search)
            );
            
            // 应用宿舍筛选
            if (dormFilter) {
                filtered = filtered.filter(r => {
                    const dormKey = `${r.building || ''}-${r.room || ''}`;
                    return dormKey === dormFilter;
                });
            }

            tbody.innerHTML = filtered.map((r, i) => `
                <tr>
                    <td>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" ${selectedIds.has(r.id) ? 'checked' : ''} onchange="toggleSelect(${r.id})">
                        </div>
                    </td>
                    <td>${i + 1}</td>
                    <td>${r.name}</td>
                    <td>${r.gender}</td>
                    <td>${r.age}</td>
                    <td>${r.phone}</td>
                    <td>${r.department || '-'}</td>
                    <td>${r.building || '-'}-${r.room || '-'}-${r.bed || '-'}</td>
                    <td>${r.checkInDate || '-'}</td>
                    <td>
                        ${currentUser.role === 'admin' ? `
                            <button class="btn btn-info" onclick="editRecord(${r.id})">编辑</button>
                            <button class="btn btn-warning" onclick="checkout(${r.id})">退宿</button>
                            <button class="btn btn-danger" onclick="deleteRecord(${r.id})">删除</button>
                        ` : `
                            <button class="btn btn-info" onclick="editRecord(${r.id})">查看</button>
                            <span style="color:#999;font-size:12px;">仅查看权限</span>
                        `}
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="10" style="text-align:center;padding:30px;color:#999;">暂无在住人员</td></tr>';
            
            updateBatchActions();
        }

        function updateDormFilterOptions() {
            const dormFilter = document.getElementById('dormFilter');
            const activeRecords = records.filter(r => !r.checkOutDate);
            
            // 获取所有唯一的宿舍组合
            const dormSet = new Set();
            activeRecords.forEach(r => {
                if (r.building && r.room) {
                    dormSet.add(`${r.building}-${r.room}`);
                }
            });
            
            // 按楼栋和房间号排序
            const dormList = Array.from(dormSet).sort((a, b) => {
                const [buildingA, roomA] = a.split('-');
                const [buildingB, roomB] = b.split('-');
                if (buildingA !== buildingB) {
                    return buildingA.localeCompare(buildingB);
                }
                return parseInt(roomA) - parseInt(roomB);
            });
            
            // 保存当前选中的值
            const currentValue = dormFilter.value;
            
            // 重新生成选项
            dormFilter.innerHTML = '<option value="">全部宿舍</option>';
            
            // 按楼栋分组
            const buildingGroups = {};
            dormList.forEach(dorm => {
                const [building, room] = dorm.split('-');
                if (!buildingGroups[building]) {
                    buildingGroups[building] = [];
                }
                buildingGroups[building].push(room);
            });
            
            // 生成分组的选项
            Object.keys(buildingGroups).sort().forEach(building => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = building;
                
                buildingGroups[building].forEach(room => {
                    const option = document.createElement('option');
                    const dormKey = `${building}-${room}`;
                    option.value = dormKey;
                    
                    // 统计该宿舍的人数
                    const count = activeRecords.filter(r => 
                        r.building === building && r.room === room
                    ).length;
                    
                    option.textContent = `${room}号房 (${count}人)`;
                    optgroup.appendChild(option);
                });
                
                dormFilter.appendChild(optgroup);
            });
            
            // 恢复之前的选中值（如果还存在）
            if (dormList.includes(currentValue)) {
                dormFilter.value = currentValue;
            }
        }

        function renderCheckoutTable() {
            const tbody = document.getElementById('checkoutTableBody');
            const search = document.getElementById('searchCheckout').value.toLowerCase();
            const checkoutRecords = records.filter(r => r.checkOutDate);
            const filtered = checkoutRecords.filter(r => 
                r.name.toLowerCase().includes(search) || 
                r.idCard.includes(search) || 
                r.phone.includes(search)
            );

            tbody.innerHTML = filtered.map((r, i) => `
                <tr>
                    <td>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" ${selectedCheckoutIds.has(r.id) ? 'checked' : ''} onchange="toggleSelectCheckout(${r.id})">
                        </div>
                    </td>
                    <td>${i + 1}</td>
                    <td>${r.name}</td>
                    <td>${r.gender}</td>
                    <td>${r.phone}</td>
                    <td>${r.department || '-'}</td>
                    <td>${r.building || '-'}-${r.room || '-'}-${r.bed || '-'}</td>
                    <td>${r.checkInDate || '-'}</td>
                    <td>${r.checkOutDate || '-'}</td>
                    <td>${r.resignDate || '-'}</td>
                    <td>${r.handover || '-'}</td>
                    <td>${r.checkOutReason || '-'}</td>
                    <td>
                        <button class="btn btn-info" onclick="editRecord(${r.id})">查看</button>
                        ${currentUser.role === 'admin' ? `
                            <button class="btn btn-danger" onclick="deleteRecord(${r.id})">删除</button>
                        ` : `
                            <span style="color:#999;font-size:12px;">仅查看权限</span>
                        `}
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="13" style="text-align:center;padding:30px;color:#999;">暂无退宿人员</td></tr>';
            
            updateBatchActionsCheckout();
        }

        function filterCheckoutRecords() {
            renderCheckoutTable();
        }

        function filterRecords() {
            renderTable();
        }

        function editRecord(id) {
            const record = records.find(r => r.id === id);
            editingId = id;
            Object.keys(record).forEach(key => {
                const el = document.getElementById(key);
                if (el) el.value = record[key] || '';
            });
            
            // 先设置楼栋，然后更新房间选项
            if (record.building) {
                document.getElementById('building').value = record.building;
                updateRoomOptions();
                // 设置房间号
                if (record.room) {
                    document.getElementById('room').value = record.room;
                }
            }
            
            // 根据用户角色设置标题和表单状态
            if (currentUser.role === 'viewer') {
                document.getElementById('formTitle').textContent = '查看人员信息（只读）';
                // 禁用所有表单字段
                const formInputs = document.querySelectorAll('#personForm input, #personForm select, #personForm textarea');
                formInputs.forEach(input => input.disabled = true);
                // 隐藏提交按钮
                document.getElementById('submitBtn').style.display = 'none';
            } else {
                document.getElementById('formTitle').textContent = '编辑人员信息';
                // 启用所有表单字段
                const formInputs = document.querySelectorAll('#personForm input, #personForm select, #personForm textarea');
                formInputs.forEach(input => input.disabled = false);
                // 显示提交按钮
                document.getElementById('submitBtn').style.display = 'inline-block';
            }
            
            document.getElementById('cancelBtn').classList.remove('hidden');
            switchTab('register');
        }

        function updateRoomOptions() {
            const buildingElement = document.getElementById('building');
            const roomSelect = document.getElementById('room');
            
            if (!buildingElement || !roomSelect) {
                return; // 元素不存在时直接返回
            }
            
            const building = buildingElement.value;
            
            // 清空现有选项
            roomSelect.innerHTML = '<option value="">请选择房间</option>';
            
            if (!building) {
                roomSelect.innerHTML = '<option value="">请先选择楼栋</option>';
                return;
            }
            
            // 获取该楼栋的所有房间
            const buildingRooms = rooms.filter(r => r.building === building);
            
            if (buildingRooms.length === 0) {
                roomSelect.innerHTML = '<option value="">该楼栋暂无房间配置</option>';
                return;
            }
            
            // 按房间号排序
            buildingRooms.sort((a, b) => {
                const numA = parseInt(a.room) || 0;
                const numB = parseInt(b.room) || 0;
                return numA - numB;
            });
            
            // 添加房间选项
            buildingRooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room.room;
                option.textContent = `${room.room}号房 (${room.beds}床位)`;
                roomSelect.appendChild(option);
            });
        }

        function cancelEdit() {
            resetForm();
        }

        function deleteRecord(id) {
            // 检查viewer权限
            if (currentUser.role === 'viewer') {
                alert('您没有权限删除记录');
                return;
            }
            
            if (confirm('确定删除该记录吗?删除后无法恢复!')) {
                records = records.filter(r => r.id !== id);
                localStorage.setItem('dormRecords', JSON.stringify(records));
                renderTable();
                renderCheckoutTable();
                alert('删除成功!');
            }
        }

        function checkout(id) {
            // 检查viewer权限
            if (currentUser.role === 'viewer') {
                alert('您没有权限操作退宿');
                return;
            }
            
            const reason = prompt('请输入退宿原因:');
            if (reason) {
                const checkoutDate = new Date().toLocaleDateString();
                
                // 获取当前日期的YYYY-MM-DD格式（用于离职日期字段）
                const today = new Date();
                const resignDateFormat = today.getFullYear() + '-' + 
                                        String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                                        String(today.getDate()).padStart(2, '0');
                
                records = records.map(r => {
                    if (r.id === id) {
                        // 如果没有离职日期，自动设置为今天的日期（YYYY-MM-DD格式）
                        const resignDate = r.resignDate || resignDateFormat;
                        console.log(`单个退宿: ${r.name}, 原离职日期: ${r.resignDate || '无'}, 新离职日期: ${resignDate}`);
                        return {...r, checkOutDate: checkoutDate, checkOutReason: reason, resignDate: resignDate};
                    }
                    return r;
                });
                
                localStorage.setItem('dormRecords', JSON.stringify(records));
                renderTable();
                renderCheckoutTable(); // 同时更新退宿人员表格
                alert('退宿登记成功!');
            }
        }

        function renderStats() {
            const active = records.filter(r => !r.checkOutDate);
            const buildings = [...new Set(records.map(r => r.building).filter(Boolean))];
            
            // 计算总房间数和总床位数
            const totalRooms = rooms.length;
            const totalBeds = rooms.reduce((sum, room) => sum + (parseInt(room.beds) || 0), 0);
            
            // 分别计算普通房间和管理人员房间的床位
            let totalBedsNormal = 0;
            let totalBedsManager = 0;
            
            rooms.forEach(room => {
                const beds = parseInt(room.beds) || 0;
                const isManagerRoom = (room.room && room.room.toString().includes('管理')) || 
                                     (room.notes && room.notes.includes('管理'));
                if (isManagerRoom) {
                    totalBedsManager += beds;
                } else {
                    totalBedsNormal += beds;
                }
            });
            
            // 计算已入住床位数（区分普通和管理人员）
            let occupiedBedsNormal = 0;
            let occupiedBedsManager = 0;
            
            active.forEach(r => {
                if (!r.building || !r.room || !r.bed) return;
                
                // 查找对应的房间配置
                const room = rooms.find(rm => rm.building === r.building && rm.room === r.room);
                if (room) {
                    const isManagerRoom = (room.room && room.room.toString().includes('管理')) || 
                                         (room.notes && room.notes.includes('管理'));
                    if (isManagerRoom) {
                        occupiedBedsManager++;
                    } else {
                        occupiedBedsNormal++;
                    }
                } else {
                    // 如果找不到房间配置，默认归为普通房间
                    occupiedBedsNormal++;
                }
            });
            
            const occupiedBedsCount = occupiedBedsNormal + occupiedBedsManager;
            const availableBedsNormal = totalBedsNormal - occupiedBedsNormal;
            const availableBedsManager = totalBedsManager - occupiedBedsManager;
            const availableBedsCount = availableBedsNormal + availableBedsManager;
            
            document.getElementById('total').textContent = records.length;
            document.getElementById('active').textContent = active.length;
            document.getElementById('checkout').textContent = records.length - active.length;
            document.getElementById('buildings').textContent = buildings.length;
            
            document.getElementById('totalRooms').textContent = totalRooms;
            document.getElementById('totalBeds').textContent = totalBeds;
            document.getElementById('occupiedBeds').textContent = occupiedBedsCount;
            document.getElementById('availableBeds').textContent = availableBedsCount;
            
            // 更新细分统计
            document.getElementById('occupiedBedsNormal').textContent = occupiedBedsNormal;
            document.getElementById('occupiedBedsManager').textContent = occupiedBedsManager;
            document.getElementById('availableBedsNormal').textContent = availableBedsNormal;
            document.getElementById('availableBedsManager').textContent = availableBedsManager;
        }

        function renderRoomTypeStats() {
            const container = document.getElementById('roomTypeStatsContainer');
            const activeRecords = records.filter(r => !r.checkOutDate);
            
            // 按床位数分类房间（分为普通房间和管理人员房间）
            const roomTypeStats = {};
            const managerRoomTypeStats = {};
            
            rooms.forEach(room => {
                const beds = parseInt(room.beds) || 0;
                let typeName = '';
                
                if (beds === 1) {
                    typeName = '单人间';
                } else if (beds === 2) {
                    typeName = '双人间';
                } else if (beds === 3) {
                    typeName = '三人间';
                } else if (beds === 4) {
                    typeName = '四人间';
                } else if (beds >= 5) {
                    typeName = `${beds}人间`;
                } else {
                    typeName = '未配置';
                }
                
                // 判断是否为管理人员房间（房间号或备注包含"管理"）
                const isManagerRoom = (room.room && room.room.toString().includes('管理')) || 
                                     (room.notes && room.notes.includes('管理'));
                
                const targetStats = isManagerRoom ? managerRoomTypeStats : roomTypeStats;
                
                if (!targetStats[typeName]) {
                    targetStats[typeName] = {
                        count: 0,
                        totalBeds: 0,
                        occupiedBeds: 0,
                        fullyOccupied: 0,
                        beds: beds
                    };
                }
                
                targetStats[typeName].count++;
                targetStats[typeName].totalBeds += beds;
            });
            
            // 统计每个房间的入住情况
            const roomOccupancy = {};
            activeRecords.forEach(r => {
                if (!r.building || !r.room || !r.bed) return;
                const key = `${r.building}-${r.room}`;
                roomOccupancy[key] = (roomOccupancy[key] || 0) + 1;
            });
            
            // 计算已入住床位和住满的房间数
            rooms.forEach(room => {
                const key = `${room.building}-${room.room}`;
                const occupied = roomOccupancy[key] || 0;
                const beds = parseInt(room.beds) || 0;
                
                let typeName = '';
                if (beds === 1) typeName = '单人间';
                else if (beds === 2) typeName = '双人间';
                else if (beds === 3) typeName = '三人间';
                else if (beds === 4) typeName = '四人间';
                else if (beds >= 5) typeName = `${beds}人间`;
                else typeName = '未配置';
                
                // 判断是否为管理人员房间
                const isManagerRoom = (room.room && room.room.toString().includes('管理')) || 
                                     (room.notes && room.notes.includes('管理'));
                
                const targetStats = isManagerRoom ? managerRoomTypeStats : roomTypeStats;
                
                if (targetStats[typeName]) {
                    targetStats[typeName].occupiedBeds += occupied;
                    if (occupied >= beds && beds > 0) {
                        targetStats[typeName].fullyOccupied++;
                    }
                }
            });
            
            // 生成HTML - 新的卡片风格
            let html = '';
            
            // 普通房型统计
            // 计算普通宿舍的汇总数据
            let normalTotalBeds = 0;
            let normalOccupiedBeds = 0;
            Object.keys(roomTypeStats).forEach(typeName => {
                normalTotalBeds += roomTypeStats[typeName].totalBeds;
                normalOccupiedBeds += roomTypeStats[typeName].occupiedBeds;
            });
            const normalAvailableBeds = normalTotalBeds - normalOccupiedBeds;
            const normalPercentage = normalTotalBeds > 0 ? (normalOccupiedBeds / normalTotalBeds * 100).toFixed(0) : 0;
            
            html += `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 8px 8px 0 0; font-size: 18px; font-weight: bold; margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                <span>普通宿舍</span>
                <span style="font-size: 14px; opacity: 0.9;">
                    ${normalTotalBeds} 总床位 | ${normalOccupiedBeds} 已入住 | ${normalAvailableBeds} 剩余 | ${normalPercentage}% 入住率
                </span>
            </div>`;
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; padding: 20px; background: #f5f5f5; border-radius: 0 0 8px 8px; margin-bottom: 20px;">';
            
            // 按床位数排序
            const sortedTypes = Object.keys(roomTypeStats).sort((a, b) => {
                return roomTypeStats[a].beds - roomTypeStats[b].beds;
            });
            
            sortedTypes.forEach(typeName => {
                const stat = roomTypeStats[typeName];
                const availableBeds = stat.totalBeds - stat.occupiedBeds;
                const percentage = stat.totalBeds > 0 ? (stat.occupiedBeds / stat.totalBeds * 100).toFixed(0) : 0;
                
                // 确定状态和颜色
                let statusClass = 'empty';
                let statusBadge = '空房';
                let borderColor = '#4CAF50';
                let bgColor = '#e8f5e9';
                
                if (percentage >= 100) {
                    statusClass = 'full';
                    statusBadge = '已满';
                    borderColor = '#f44336';
                    bgColor = '#ffebee';
                } else if (percentage >= 50) {
                    statusClass = 'partial';
                    statusBadge = '部分';
                    borderColor = '#FF9800';
                    bgColor = '#fff3e0';
                }
                
                html += `
                    <div style="background: white; border-radius: 8px; padding: 15px; border: 2px solid ${borderColor}; background: ${bgColor}; position: relative;">
                        <div style="position: absolute; top: 10px; right: 10px; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; color: white; background: ${borderColor};">${statusBadge}</div>
                        <div style="font-size: 20px; font-weight: bold; color: #333; margin-bottom: 10px;">${typeName}</div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                            房间数: <strong style="color: #333;">${stat.count}</strong> 间
                        </div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                            总床位: <strong style="color: #333;">${stat.totalBeds}</strong> 张
                        </div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                            已入住: <strong style="color: #f44336;">${stat.occupiedBeds}</strong> 张
                        </div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                            空床位: <strong style="color: #4CAF50;">${availableBeds}</strong> 张
                        </div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                            住满房间: <strong style="color: #FF9800;">${stat.fullyOccupied}</strong> 间
                        </div>
                        <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-top: 10px;">
                            <div style="height: 100%; background: linear-gradient(90deg, #4CAF50, #2196F3); width: ${percentage}%;"></div>
                        </div>
                        <div style="text-align: right; font-size: 12px; color: #666; margin-top: 5px;">床位使用率: ${percentage}%</div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // 管理人员房型统计
            const sortedManagerTypes = Object.keys(managerRoomTypeStats).sort((a, b) => {
                return managerRoomTypeStats[a].beds - managerRoomTypeStats[b].beds;
            });
            
            if (sortedManagerTypes.length > 0) {
                // 计算管理人员宿舍的汇总数据
                let managerTotalBeds = 0;
                let managerOccupiedBeds = 0;
                Object.keys(managerRoomTypeStats).forEach(typeName => {
                    managerTotalBeds += managerRoomTypeStats[typeName].totalBeds;
                    managerOccupiedBeds += managerRoomTypeStats[typeName].occupiedBeds;
                });
                const managerAvailableBeds = managerTotalBeds - managerOccupiedBeds;
                const managerPercentage = managerTotalBeds > 0 ? (managerOccupiedBeds / managerTotalBeds * 100).toFixed(0) : 0;
                
                html += `<div style="background: linear-gradient(135deg, #9C27B0 0%, #E1BEE7 100%); color: white; padding: 15px 20px; border-radius: 8px 8px 0 0; font-size: 18px; font-weight: bold; margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <span>管理人员宿舍</span>
                    <span style="font-size: 14px; opacity: 0.9;">
                        ${managerTotalBeds} 总床位 | ${managerOccupiedBeds} 已入住 | ${managerAvailableBeds} 剩余 | ${managerPercentage}% 入住率
                    </span>
                </div>`;
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; padding: 20px; background: #f5f5f5; border-radius: 0 0 8px 8px; margin-bottom: 20px;">';
                
                sortedManagerTypes.forEach(typeName => {
                    const stat = managerRoomTypeStats[typeName];
                    const availableBeds = stat.totalBeds - stat.occupiedBeds;
                    const percentage = stat.totalBeds > 0 ? (stat.occupiedBeds / stat.totalBeds * 100).toFixed(0) : 0;
                    
                    // 确定状态和颜色
                    let statusClass = 'empty';
                    let statusBadge = '空房';
                    let borderColor = '#4CAF50';
                    let bgColor = '#f3e5f5';
                    
                    if (percentage >= 100) {
                        statusClass = 'full';
                        statusBadge = '已满';
                        borderColor = '#9C27B0';
                        bgColor = '#f3e5f5';
                    } else if (percentage >= 50) {
                        statusClass = 'partial';
                        statusBadge = '部分';
                        borderColor = '#BA68C8';
                        bgColor = '#f3e5f5';
                    }
                    
                    html += `
                        <div style="background: white; border-radius: 8px; padding: 15px; border: 2px solid ${borderColor}; background: ${bgColor}; position: relative;">
                            <div style="position: absolute; top: 10px; right: 10px; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; color: white; background: ${borderColor};">${statusBadge}</div>
                            <div style="font-size: 20px; font-weight: bold; color: #333; margin-bottom: 10px;">${typeName} <span style="font-size: 12px; color: #9C27B0;">(管理)</span></div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                房间数: <strong style="color: #333;">${stat.count}</strong> 间
                            </div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                总床位: <strong style="color: #333;">${stat.totalBeds}</strong> 张
                            </div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                已入住: <strong style="color: #9C27B0;">${stat.occupiedBeds}</strong> 张
                            </div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                空床位: <strong style="color: #4CAF50;">${availableBeds}</strong> 张
                            </div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                                住满房间: <strong style="color: #9C27B0;">${stat.fullyOccupied}</strong> 间
                            </div>
                            <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-top: 10px;">
                                <div style="height: 100%; background: linear-gradient(90deg, #9C27B0, #E1BEE7); width: ${percentage}%;"></div>
                            </div>
                            <div style="text-align: right; font-size: 12px; color: #666; margin-top: 5px;">床位使用率: ${percentage}%</div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            if (sortedTypes.length === 0 && sortedManagerTypes.length === 0) {
                html = '<p style="text-align:center;color:#999;padding:30px;">暂无房型数据,请先在"房间管理"中添加房间配置</p>';
            }
            
            container.innerHTML = html;
        }

        function renderBedStats() {
            const container = document.getElementById('bedStatsContainer');
            const activeRecords = records.filter(r => !r.checkOutDate);
            
            // 使用房间配置数据
            const buildingStats = {};
            
            // 首先从房间配置中初始化数据
            rooms.forEach(room => {
                if (!buildingStats[room.building]) {
                    buildingStats[room.building] = {};
                }
                buildingStats[room.building][room.room] = {
                    totalBeds: parseInt(room.beds) || 0,
                    occupiedBeds: 0,
                    notes: room.notes || ''
                };
            });
            
            // 然后统计实际入住情况
            activeRecords.forEach(r => {
                if (!r.building || !r.room || !r.bed) return;
                
                if (!buildingStats[r.building]) {
                    buildingStats[r.building] = {};
                }
                
                if (!buildingStats[r.building][r.room]) {
                    // 如果房间配置中没有这个房间，动态创建
                    buildingStats[r.building][r.room] = {
                        totalBeds: 0,
                        occupiedBeds: 0,
                        notes: '未配置'
                    };
                }
                
                buildingStats[r.building][r.room].occupiedBeds++;
                
                // 如果实际入住超过配置的床位数，自动更新总床位数
                const currentOccupied = buildingStats[r.building][r.room].occupiedBeds;
                const currentTotal = buildingStats[r.building][r.room].totalBeds;
                if (currentOccupied > currentTotal) {
                    buildingStats[r.building][r.room].totalBeds = currentOccupied;
                }
            });
            
            // 生成HTML - 平面图卡片风格
            let html = '';
            
            Object.keys(buildingStats).sort().forEach(building => {
                const roomsData = buildingStats[building];
                let buildingTotal = 0;
                let buildingOccupied = 0;
                let buildingAvailable = 0;
                
                // 先计算汇总数据
                Object.keys(roomsData).forEach(room => {
                    const roomData = roomsData[room];
                    buildingTotal += roomData.totalBeds;
                    buildingOccupied += roomData.occupiedBeds;
                });
                buildingAvailable = buildingTotal - buildingOccupied;
                const buildingPercentage = buildingTotal > 0 ? (buildingOccupied / buildingTotal * 100).toFixed(0) : 0;
                
                // 楼栋标题和汇总
                html += `
                    <div style="margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 8px 8px 0 0; font-size: 18px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
                            <span>${building}</span>
                            <span style="font-size: 14px; opacity: 0.9;">
                                ${buildingTotal} 总床位 | ${buildingOccupied} 已入住 | ${buildingAvailable} 剩余 | ${buildingPercentage}% 入住率
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; padding: 20px; background: #f5f5f5; border-radius: 0 0 8px 8px;">
                `;
                
                // 生成房间卡片
                Object.keys(roomsData).sort((a, b) => {
                    if (building === '办公三楼') {
                        // 办公三楼特殊排序：北侧房间从小到大，南侧房间从小到大
                        const isNorthA = a.includes('北');
                        const isNorthB = b.includes('北');
                        const numA = parseInt(a.match(/\d+/)?.[0]) || 0;
                        const numB = parseInt(b.match(/\d+/)?.[0]) || 0;
                        
                        // 如果都是北侧或都是南侧，按照从小到大排序
                        if (isNorthA && isNorthB) {
                            return numA - numB; // 北侧：从小到大
                        } else if (!isNorthA && !isNorthB) {
                            return numA - numB; // 南侧：从小到大
                        } else {
                            // 北侧排在前面
                            return isNorthA ? -1 : 1;
                        }
                    } else {
                        // 其他楼栋按从小到大排序
                        const numA = parseInt(a) || 0;
                        const numB = parseInt(b) || 0;
                        return numA - numB;
                    }
                }).forEach(room => {
                    const roomData = roomsData[room];
                    const total = roomData.totalBeds;
                    const occupied = roomData.occupiedBeds;
                    const available = total - occupied;
                    const percentage = total > 0 ? (occupied / total * 100).toFixed(0) : 0;
                    
                    // 确定房间状态
                    let status = 'empty';
                    let statusText = '空房';
                    let statusBadge = '空房';
                    let borderColor = '#4CAF50';
                    let bgColor = '#e8f5e9';
                    
                    if (occupied >= total && total > 0) {
                        status = 'full';
                        statusText = '已满';
                        statusBadge = '已满';
                        borderColor = '#f44336';
                        bgColor = '#ffebee';
                    } else if (occupied > 0) {
                        status = 'partial';
                        statusText = '部分入住';
                        statusBadge = '部分';
                        borderColor = '#FF9800';
                        bgColor = '#fff3e0';
                    }
                    
                    html += `
                        <div style="background: white; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.3s; border: 2px solid ${borderColor}; background: ${bgColor}; position: relative;" 
                             onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)';"
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                             onclick="showRoomDetail('${building}', '${room}')">
                            <div style="position: absolute; top: 10px; right: 10px; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; color: white; background: ${borderColor};">${statusBadge}</div>
                            <div style="font-size: 20px; font-weight: bold; color: #333; margin-bottom: 10px;">${room}号房</div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 8px;">${statusText}</div>
                            <div style="font-size: 12px; color: #999;">
                                已入住: <strong style="color: #f44336;">${occupied}</strong> / 
                                总床位: <strong>${total}</strong>
                            </div>
                            ${roomData.notes && roomData.notes !== '未配置' ? `<div style="font-size: 11px; color: #999; margin-top: 5px;">${roomData.notes}</div>` : ''}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<p style="text-align:center;color:#999;padding:30px;">暂无床位数据,请先在"房间管理"中添加房间配置</p>';
            }
            
            container.innerHTML = html;
        }

        // 自动调整Excel列宽的辅助函数
        function autoFitColumns(worksheet) {
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            const colWidths = [];
            
            // 遍历每一列
            for (let C = range.s.c; C <= range.e.c; ++C) {
                let maxWidth = 10; // 最小宽度
                
                // 遍历该列的所有行
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                    const cell = worksheet[cellAddress];
                    
                    if (cell && cell.v) {
                        const cellValue = cell.v.toString();
                        // 计算字符宽度（中文字符算2个宽度，英文算1个）
                        let width = 0;
                        for (let i = 0; i < cellValue.length; i++) {
                            const charCode = cellValue.charCodeAt(i);
                            // 中文字符范围
                            if (charCode >= 0x4e00 && charCode <= 0x9fa5) {
                                width += 2.2; // 中文字符
                            } else {
                                width += 1.1; // 英文、数字等
                            }
                        }
                        maxWidth = Math.max(maxWidth, width);
                    }
                }
                
                // 设置列宽，最大不超过50
                colWidths.push({ wch: Math.min(maxWidth, 50) });
            }
            
            worksheet['!cols'] = colWidths;
        }

        function exportExcel() {
            if (currentUser.role !== 'admin') {
                alert('只有管理员可以导出数据');
                return;
            }
            const wb = XLSX.utils.book_new();
            
            // 1. 在职人员
            const activeRecords = records.filter(r => !r.checkOutDate);
            if (activeRecords.length > 0) {
                const ws1 = XLSX.utils.json_to_sheet(activeRecords.map((r, i) => ({
                    序号: i + 1,
                    姓名: r.name,
                    身份证号: r.idCard,
                    性别: r.gender,
                    出生日期: r.birthDate,
                    年龄: r.age,
                    电话: r.phone,
                    地址: r.address,
                    民族: r.ethnicity,
                    来源单位: r.sourceUnit,
                    部门: r.department,
                    楼栋: r.building,
                    房间: r.room,
                    床位: r.bed,
                    入住日期: r.checkInDate,
                    紧急联系人: r.emergencyContact,
                    紧急电话: r.emergencyPhone,
                    离职日期: r.resignDate,
                    交割手续: r.handover,
                    备注: r.notes,
                    登记时间: r.recordTime
                })));
                autoFitColumns(ws1);
                // 设置冻结首行
                ws1['!freeze'] = { xSplit: 0, ySplit: 1 };
                XLSX.utils.book_append_sheet(wb, ws1, '在职人员');
            }
            
            // 2. 退宿人员
            const checkoutRecords = records.filter(r => r.checkOutDate);
            if (checkoutRecords.length > 0) {
                const ws2 = XLSX.utils.json_to_sheet(checkoutRecords.map((r, i) => ({
                    序号: i + 1,
                    姓名: r.name,
                    身份证号: r.idCard,
                    性别: r.gender,
                    出生日期: r.birthDate,
                    年龄: r.age,
                    电话: r.phone,
                    地址: r.address,
                    民族: r.ethnicity,
                    来源单位: r.sourceUnit,
                    部门: r.department,
                    楼栋: r.building,
                    房间: r.room,
                    床位: r.bed,
                    入住日期: r.checkInDate,
                    退宿日期: r.checkOutDate,
                    退宿原因: r.checkOutReason,
                    离职日期: r.resignDate,
                    交割手续: r.handover,
                    紧急联系人: r.emergencyContact,
                    紧急电话: r.emergencyPhone,
                    备注: r.notes,
                    登记时间: r.recordTime
                })));
                autoFitColumns(ws2);
                // 设置冻结首行
                ws2['!freeze'] = { xSplit: 0, ySplit: 1 };
                XLSX.utils.book_append_sheet(wb, ws2, '退宿人员');
            }
            
            // 3. 房间管理
            if (rooms.length > 0) {
                const ws3 = XLSX.utils.json_to_sheet(rooms.map((r, i) => ({
                    序号: i + 1,
                    楼栋: r.building,
                    房间号: r.room,
                    床位数: r.beds,
                    备注: r.notes || ''
                })));
                autoFitColumns(ws3);
                // 设置冻结首行
                ws3['!freeze'] = { xSplit: 0, ySplit: 1 };
                XLSX.utils.book_append_sheet(wb, ws3, '房间管理');
            }
            
            if (activeRecords.length === 0 && checkoutRecords.length === 0 && rooms.length === 0) {
                return alert('暂无数据可导出');
            }
            
            XLSX.writeFile(wb, '住宿人员管理_' + new Date().toLocaleDateString('zh-CN').replace(/\//g, '-') + '.xlsx');
        }

        function showImport() {
            if (currentUser.role !== 'admin') {
                alert('只有管理员可以导入数据');
                return;
            }
            document.getElementById('importModal').classList.add('active');
        }

        function closeImport() {
            document.getElementById('importModal').classList.remove('active');
        }

        function exportCheckoutExcel() {
            if (currentUser.role !== 'admin') {
                alert('只有管理员可以导出数据');
                return;
            }
            const checkoutRecords = records.filter(r => r.checkOutDate);
            
            if (checkoutRecords.length === 0) {
                alert('暂无退宿人员数据');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(checkoutRecords.map((r, i) => ({
                序号: i + 1,
                姓名: r.name,
                身份证号: r.idCard,
                性别: r.gender,
                出生日期: r.birthDate,
                年龄: r.age,
                电话: r.phone,
                地址: r.address,
                民族: r.ethnicity,
                来源单位: r.sourceUnit,
                部门: r.department,
                原楼栋: r.building,
                原房间: r.room,
                原床位: r.bed,
                入住日期: r.checkInDate,
                退宿日期: r.checkOutDate,
                退宿原因: r.checkOutReason,
                离职日期: r.resignDate,
                交割手续: r.handover,
                紧急联系人: r.emergencyContact,
                紧急电话: r.emergencyPhone,
                备注: r.notes,
                登记时间: r.recordTime
            })));
            
            autoFitColumns(ws); // 自动调整列宽
            // 设置冻结首行
            ws['!freeze'] = { xSplit: 0, ySplit: 1 };
            XLSX.utils.book_append_sheet(wb, ws, '退宿人员');
            XLSX.writeFile(wb, '退宿人员登记表_' + new Date().toLocaleDateString('zh-CN').replace(/\//g, '-') + '.xlsx');
        }

        function showImportCheckout() {
            if (currentUser.role !== 'admin') {
                alert('只有管理员可以导入数据');
                return;
            }
            document.getElementById('importCheckoutModal').classList.add('active');
        }

        function closeImportCheckout() {
            document.getElementById('importCheckoutModal').classList.remove('active');
        }

        function handleImportCheckout(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, {type: 'array'});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws, {raw: false, defval: ''});
                    
                    if (json.length === 0) {
                        alert('Excel文件为空!');
                        return;
                    }
                    
                    let success = 0;
                    let error = 0;
                    let errorDetails = [];
                    
                    const formatDate = (dateValue) => {
                        if (!dateValue || dateValue === '') return '';
                        
                        let date;
                        if (typeof dateValue === 'string') {
                            dateValue = dateValue.trim();
                            
                            if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(dateValue)) {
                                date = new Date(dateValue);
                            }
                            else if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(dateValue)) {
                                date = new Date(dateValue.replace(/\//g, '-'));
                            }
                            else if (/^\d{4}\.\d{1,2}\.\d{1,2}$/.test(dateValue)) {
                                const parts = dateValue.split('.');
                                date = new Date(`${parts[0]}-${parts[1]}-${parts[2]}`);
                            }
                            else if (/^\d{4}年\d{1,2}月\d{1,2}日?$/.test(dateValue)) {
                                const matches = dateValue.match(/(\d{4})年(\d{1,2})月(\d{1,2})/);
                                if (matches) {
                                    date = new Date(matches[1], matches[2] - 1, matches[3]);
                                }
                            }
                            else {
                                date = new Date(dateValue);
                            }
                        }
                        else if (dateValue instanceof Date) {
                            date = dateValue;
                        }
                        
                        if (!date || isNaN(date.getTime())) {
                            return dateValue;
                        }
                        
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        
                        return `${year}-${month}-${day}`;
                    }
                    
                    json.forEach((row, index) => {
                        const getName = (names) => {
                            for (let name of names) {
                                const value = row[name];
                                if (value !== undefined && value !== null && value !== '') {
                                    return value;
                                }
                            }
                            return '';
                        };
                        
                        let idCard = getName([
                            '身份证号', '身份证号码', '身份证', 'ID', 'idCard', 
                            '证件号', '证件号码', '身份证 号码', '身份证 号',
                            'ID Card', 'IdCard', 'IDCARD', '身份证件号码'
                        ]);
                        
                        if (idCard) {
                            idCard = String(idCard);
                            idCard = idCard.replace(/[\s\n\r\t]/g, '');
                            idCard = idCard.toUpperCase();
                            
                            if (idCard.includes('E+') || idCard.includes('e+')) {
                                try {
                                    const num = parseFloat(idCard);
                                    idCard = num.toFixed(0);
                                } catch (err) {
                                    idCard = '';
                                }
                            }
                        }
                        
                        // 退宿人员导入允许身份证号重复，已移除重复检查
                        
                        let gender = getName(['性别', 'gender', '男女']) || '';
                        let age = getName(['年龄', 'age'])?.toString() || '';
                        let birthDate = getName(['出生日期', '生日', 'birthDate', '出生']) || '';
                        
                        if (idCard && idCard.length === 18 && /^\d{17}[\dX]$/.test(idCard)) {
                            const genderCode = parseInt(idCard.charAt(16));
                            gender = genderCode % 2 === 1 ? '男' : '女';
                            const year = parseInt(idCard.substring(6, 10));
                            const month = idCard.substring(10, 12);
                            const day = idCard.substring(12, 14);
                            birthDate = `${year}-${month}-${day}`;
                            age = (new Date().getFullYear() - year).toString();
                        }
                        
                        let phone = getName(['电话', '联系电话', '手机号', 'phone', '手机', '联系方式']);
                        if (phone) {
                            phone = String(phone).replace(/[\s\n\r\t]/g, '');
                        }
                        
                        const checkOutDate = formatDate(getName(['退宿日期', '退宿时间', 'checkOutDate', '退宿']));
                        
                        // 如果没有退宿日期，跳过这条记录
                        if (!checkOutDate) {
                            error++;
                            if (errorDetails.length < 5) {
                                errorDetails.push(`第${index + 2}行:缺少退宿日期`);
                            }
                            return;
                        }
                        
                        records.push({
                            id: Date.now() + Math.random(),
                            name: getName(['姓名', '员工姓名', 'name', '名字']) || '',
                            idCard: idCard || '',
                            gender: gender,
                            birthDate: birthDate,
                            age: age,
                            phone: phone || '',
                            address: getName(['地址', '家庭地址', 'address', '住址']) || '',
                            ethnicity: getName(['民族', 'ethnicity']) || '',
                            sourceUnit: getName(['来源单位', '原单位', 'sourceUnit', '单位']) || '',
                            department: getName(['部门', '入职部门', '所属部门', 'department']) || '',
                            building: getName(['楼栋', '宿舍楼栋', '原楼栋', 'building', '宿舍']) || '',
                            room: getName(['房间', '房间号', '原房间', 'room', '房号'])?.toString() || '',
                            bed: getName(['床位', '床位号', '原床位', 'bed', '床号'])?.toString() || '',
                            checkInDate: formatDate(getName(['入住日期', '入住时间', 'checkInDate', '入住'])),
                            checkOutDate: checkOutDate,
                            checkOutReason: getName(['退宿原因', '原因', 'checkOutReason', '退房原因']) || '',
                            emergencyContact: getName(['紧急联系人', '联系人', 'emergencyContact', '家属']) || '',
                            emergencyPhone: getName(['紧急联系电话', '紧急电话', 'emergencyPhone', '家属电话'])?.toString() || '',
                            resignDate: formatDate(getName(['离职日期', '离职时间', 'resignDate', '离职'])),
                            handover: getName(['交割手续', '交接状态', 'handover', '交接']) || '',
                            notes: getName(['备注', '说明', 'notes', '备注说明']) || '',
                            recordTime: new Date().toLocaleString('zh-CN')
                        });
                        success++;
                    });
                    
                    localStorage.setItem('dormRecords', JSON.stringify(records));
                    renderCheckoutTable();
                    closeImportCheckout();
                    
                    let message = `导入完成!\n成功: ${success} 条\n失败: ${error} 条`;
                    if (errorDetails.length > 0) {
                        message += '\n\n错误详情:\n' + errorDetails.join('\n');
                        if (error > errorDetails.length) {
                            message += `\n...还有 ${error - errorDetails.length} 条错误`;
                        }
                    }
                    alert(message);
                } catch (err) {
                    alert('文件解析失败: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function handleImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, {type: 'array', cellText: false, cellDates: true});
                    
                    // 检查工作簿中的sheet数量
                    const sheetNames = wb.SheetNames;
                    console.log('检测到的Sheet:', sheetNames);
                    
                    // 统计信息
                    let totalSuccess = 0;
                    let totalError = 0;
                    let importSummary = [];
                    
                    // 处理在职人员sheet（可能的名称：在职人员、人员详细信息、Sheet1等）
                    const activeSheetNames = ['在职人员', '人员详细信息', '在住人员', '人员列表'];
                    const activeSheet = sheetNames.find(name => activeSheetNames.some(n => name.includes(n))) || sheetNames[0];
                    
                    if (activeSheet && wb.Sheets[activeSheet]) {
                        const result = importActivePersonnel(wb.Sheets[activeSheet], activeSheet);
                        totalSuccess += result.success;
                        totalError += result.error;
                        importSummary.push(`📋 ${activeSheet}: 成功${result.success}条, 失败${result.error}条`);
                    }
                    
                    // 处理退宿人员sheet
                    const checkoutSheetNames = ['退宿人员', '退宿', '离职人员'];
                    const checkoutSheet = sheetNames.find(name => checkoutSheetNames.some(n => name.includes(n)));
                    
                    if (checkoutSheet && wb.Sheets[checkoutSheet]) {
                        const result = importCheckoutPersonnel(wb.Sheets[checkoutSheet], checkoutSheet);
                        totalSuccess += result.success;
                        totalError += result.error;
                        importSummary.push(`📋 ${checkoutSheet}: 成功${result.success}条, 失败${result.error}条`);
                    }
                    
                    // 处理房间配置sheet
                    const roomSheetNames = ['房间管理', '房间配置', '房间', '宿舍配置'];
                    const roomSheet = sheetNames.find(name => roomSheetNames.some(n => name.includes(n)));
                    
                    if (roomSheet && wb.Sheets[roomSheet]) {
                        const result = importRooms(wb.Sheets[roomSheet], roomSheet);
                        totalSuccess += result.success;
                        totalError += result.error;
                        importSummary.push(`📋 ${roomSheet}: 成功${result.success}条, 失败${result.error}条`);
                    }
                    
                    // 显示导入结果
                    let message = `🎉 批量导入完成!\n\n`;
                    message += `总计: 成功${totalSuccess}条, 失败${totalError}条\n\n`;
                    message += `详细信息:\n${importSummary.join('\n')}`;
                    
                    alert(message);
                    
                    // 刷新界面
                    filterRecords();
                    renderRooms();
                    closeImport();
                    
                } catch (err) {
                    console.error('导入错误:', err);
                    alert('导入失败: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // 导入在职人员
        function importActivePersonnel(ws, sheetName) {
            const json = XLSX.utils.sheet_to_json(ws, {raw: false, defval: ''});
            
            if (json.length === 0) {
                return { success: 0, error: 0 };
            }
            
            let success = 0;
            let error = 0;
            
            function formatDate(dateValue) {
                if (!dateValue) return '';
                
                if (typeof dateValue === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
                    return dateValue;
                }
                
                let date;
                
                if (typeof dateValue === 'number') {
                    date = new Date((dateValue - 25569) * 86400 * 1000);
                }
                else if (typeof dateValue === 'string') {
                    dateValue = dateValue.trim();
                    
                    if (/^\d{4}[/-]\d{1,2}[/-]\d{1,2}$/.test(dateValue)) {
                        const parts = dateValue.split(/[/-]/);
                        date = new Date(parts[0], parts[1] - 1, parts[2]);
                    }
                    else if (/^\d{1,2}[/-]\d{1,2}[/-]\d{4}$/.test(dateValue)) {
                        const parts = dateValue.split(/[/-]/);
                        date = new Date(parts[2], parts[1] - 1, parts[0]);
                    }
                    else if (/^\d{4}年\d{1,2}月\d{1,2}日?$/.test(dateValue)) {
                        const matches = dateValue.match(/(\d{4})年(\d{1,2})月(\d{1,2})/);
                        if (matches) {
                            date = new Date(matches[1], matches[2] - 1, matches[3]);
                        }
                    }
                    else {
                        date = new Date(dateValue);
                    }
                }
                else if (dateValue instanceof Date) {
                    date = dateValue;
                }
                
                if (!date || isNaN(date.getTime())) {
                    return dateValue;
                }
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                
                return `${year}-${month}-${day}`;
            }
            
            json.forEach((row, index) => {
                const getName = (names) => {
                    for (let name of names) {
                        const value = row[name];
                        if (value !== undefined && value !== null && value !== '') {
                            return value;
                        }
                    }
                    return '';
                };
                
                let idCard = getName([
                    '身份证号', '身份证号码', '身份证', 'ID', 'idCard', 
                    '证件号', '证件号码', '身份证 号码', '身份证 号',
                    'ID Card', 'IdCard', 'IDCARD', '身份证件号码'
                ]);
                
                if (idCard) {
                    idCard = String(idCard);
                    idCard = idCard.replace(/[\s\n\r\t]/g, '');
                    idCard = idCard.toUpperCase();
                    
                    if (idCard.includes('E+') || idCard.includes('e+')) {
                        try {
                            const num = parseFloat(idCard);
                            idCard = num.toFixed(0);
                        } catch (err) {
                            idCard = '';
                        }
                    }
                }
                
                let gender = getName(['性别', 'gender', '男女']) || '';
                let age = getName(['年龄', 'age'])?.toString() || '';
                let birthDate = getName(['出生日期', '生日', 'birthDate', '出生']) || '';
                
                if (idCard && idCard.length === 18 && /^\d{17}[\dX]$/.test(idCard)) {
                    const genderCode = parseInt(idCard.charAt(16));
                    gender = genderCode % 2 === 1 ? '男' : '女';
                    const year = parseInt(idCard.substring(6, 10));
                    const month = idCard.substring(10, 12);
                    const day = idCard.substring(12, 14);
                    birthDate = `${year}-${month}-${day}`;
                    age = (new Date().getFullYear() - year).toString();
                }
                
                let phone = getName(['电话', '联系电话', '手机号', 'phone', '手机', '联系方式']);
                if (phone) {
                    phone = String(phone).replace(/[\s\n\r\t]/g, '');
                }
                
                records.push({
                    id: Date.now() + Math.random(),
                    name: getName(['姓名', '员工姓名', 'name', '名字']) || '',
                    idCard: idCard || '',
                    gender: gender,
                    birthDate: birthDate,
                    age: age,
                    phone: phone || '',
                    address: getName(['地址', '家庭地址', 'address', '住址']) || '',
                    ethnicity: getName(['民族', 'ethnicity']) || '',
                    sourceUnit: getName(['来源单位', '原单位', 'sourceUnit', '单位']) || '',
                    department: getName(['部门', '入职部门', '所属部门', 'department']) || '',
                    building: getName(['楼栋', '宿舍楼栋', '楼层', 'building', '宿舍']) || '',
                    room: getName(['房间', '房间号', 'room', '房号'])?.toString() || '',
                    bed: getName(['床位', '床位号', 'bed', '床号'])?.toString() || '',
                    checkInDate: formatDate(getName(['入住日期', '入住时间', 'checkInDate', '入住'])),
                    emergencyContact: getName(['紧急联系人', '联系人', 'emergencyContact', '家属']) || '',
                    emergencyPhone: getName(['紧急联系电话', '紧急电话', 'emergencyPhone', '家属电话'])?.toString() || '',
                    resignDate: formatDate(getName(['离职日期', '离职时间', 'resignDate', '离职'])),
                    handover: getName(['交割手续', '交接状态', 'handover', '交接']) || '',
                    notes: getName(['备注', '说明', 'notes', '备注说明']) || '',
                    recordTime: new Date().toLocaleString()
                });
                success++;
            });
            
            localStorage.setItem('dormRecords', JSON.stringify(records));
            return { success, error };
        }
        
        // 导入退宿人员
        function importCheckoutPersonnel(ws, sheetName) {
            const json = XLSX.utils.sheet_to_json(ws, {raw: false, defval: ''});
            
            if (json.length === 0) {
                return { success: 0, error: 0 };
            }
            
            let success = 0;
            let error = 0;
            
            function formatDate(dateValue) {
                if (!dateValue) return '';
                
                if (typeof dateValue === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
                    return dateValue;
                }
                
                let date;
                
                if (typeof dateValue === 'number') {
                    date = new Date((dateValue - 25569) * 86400 * 1000);
                }
                else if (typeof dateValue === 'string') {
                    dateValue = dateValue.trim();
                    
                    if (/^\d{4}[/-]\d{1,2}[/-]\d{1,2}$/.test(dateValue)) {
                        const parts = dateValue.split(/[/-]/);
                        date = new Date(parts[0], parts[1] - 1, parts[2]);
                    }
                    else {
                        date = new Date(dateValue);
                    }
                }
                else if (dateValue instanceof Date) {
                    date = dateValue;
                }
                
                if (!date || isNaN(date.getTime())) {
                    return dateValue;
                }
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                
                return `${year}-${month}-${day}`;
            }
            
            json.forEach((row, index) => {
                const getName = (names) => {
                    for (let name of names) {
                        const value = row[name];
                        if (value !== undefined && value !== null && value !== '') {
                            return value;
                        }
                    }
                    return '';
                };
                
                let idCard = getName(['身份证号', '身份证号码', '身份证', 'ID', 'idCard']);
                if (idCard) {
                    idCard = String(idCard).replace(/[\s\n\r\t]/g, '').toUpperCase();
                }
                
                let phone = getName(['电话', '联系电话', '手机号', 'phone']);
                if (phone) {
                    phone = String(phone).replace(/[\s\n\r\t]/g, '');
                }
                
                records.push({
                    id: Date.now() + Math.random(),
                    name: getName(['姓名', 'name']) || '',
                    idCard: idCard || '',
                    gender: getName(['性别', 'gender']) || '',
                    birthDate: getName(['出生日期', 'birthDate']) || '',
                    age: getName(['年龄', 'age'])?.toString() || '',
                    phone: phone || '',
                    address: getName(['地址', 'address']) || '',
                    ethnicity: getName(['民族', 'ethnicity']) || '',
                    sourceUnit: getName(['来源单位', 'sourceUnit']) || '',
                    department: getName(['部门', 'department']) || '',
                    building: getName(['楼栋', '原楼栋', 'building']) || '',
                    room: getName(['房间', '原房间', 'room'])?.toString() || '',
                    bed: getName(['床位', '原床位', 'bed'])?.toString() || '',
                    checkInDate: formatDate(getName(['入住日期', 'checkInDate'])),
                    checkOutDate: formatDate(getName(['退宿日期', 'checkOutDate'])),
                    checkOutReason: getName(['退宿原因', 'checkOutReason']) || '',
                    resignDate: formatDate(getName(['离职日期', 'resignDate'])),
                    handover: getName(['交割手续', 'handover']) || '',
                    emergencyContact: getName(['紧急联系人', 'emergencyContact']) || '',
                    emergencyPhone: getName(['紧急电话', 'emergencyPhone'])?.toString() || '',
                    notes: getName(['备注', 'notes']) || '',
                    recordTime: new Date().toLocaleString()
                });
                success++;
            });
            
            localStorage.setItem('dormRecords', JSON.stringify(records));
            return { success, error };
        }
        
        // 导入房间配置
        function importRooms(ws, sheetName) {
            const json = XLSX.utils.sheet_to_json(ws, {raw: false, defval: ''});
            
            if (json.length === 0) {
                return { success: 0, error: 0 };
            }
            
            let success = 0;
            let error = 0;
            
            json.forEach((row, index) => {
                const getName = (names) => {
                    for (let name of names) {
                        const value = row[name];
                        if (value !== undefined && value !== null && value !== '') {
                            return value;
                        }
                    }
                    return '';
                };
                
                const building = getName(['楼栋', 'building']);
                const room = getName(['房间号', '房间', 'room']);
                const beds = parseInt(getName(['床位数', '床位', 'beds'])) || 0;
                const notes = getName(['备注', 'notes']) || '';
                
                if (!building || !room || beds <= 0) {
                    error++;
                    return;
                }
                
                // 检查是否已存在
                const existing = rooms.find(r => r.building === building && r.room === room);
                if (existing) {
                    // 更新现有房间
                    existing.beds = beds;
                    existing.notes = notes;
                    success++;
                } else {
                    // 添加新房间
                    rooms.push({
                        id: Date.now() + Math.random(),
                        building,
                        room,
                        beds,
                        notes
                    });
                    success++;
                }
            });
            
            localStorage.setItem('dormRooms', JSON.stringify(rooms));
            return { success, error };
        }
        
        // 保留原有的单sheet导入功能作为备用
        function handleImportOld(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, {type: 'array', cellText: false, cellDates: true});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws, {raw: false, defval: ''});
                    
                    if (json.length === 0) {
                        alert('Excel文件为空或格式不正确!');
                        return;
                    }
                    
                    // 单sheet导入逻辑（备用）
                    alert('检测到单个Sheet，建议使用导出的多Sheet格式Excel');
                    
                } catch (err) {
                    alert('❌ 文件解析失败:' + err.message);
                    console.error('导入错误:', err);
                }
            };
            reader.readAsArrayBuffer(file);
            e.target.value = '';
        }

        // 房间管理功能
        function renderRooms() {
            const container = document.getElementById('roomsContainer');
            const isAdmin = currentUser.role === 'admin';
            
            // 按楼栋分组
            const buildingGroups = {};
            rooms.forEach(room => {
                if (!buildingGroups[room.building]) {
                    buildingGroups[room.building] = [];
                }
                buildingGroups[room.building].push(room);
            });
            
            let html = '';
            
            Object.keys(buildingGroups).sort().forEach(building => {
                const buildingRooms = buildingGroups[building];
                const totalBeds = buildingRooms.reduce((sum, r) => sum + (parseInt(r.beds) || 0), 0);
                
                html += `
                    <div class="building-section">
                        <h3>${building} (${buildingRooms.length} 个房间, ${totalBeds} 张床位)</h3>
                        <table>
                            <thead>
                                <tr>
                                    ${isAdmin ? `<th style="width:50px;">
                                        <div class="checkbox-wrapper">
                                            <input type="checkbox" class="select-all-rooms" onchange="toggleSelectAllRooms('${building}')">
                                        </div>
                                    </th>` : ''}
                                    <th>序号</th>
                                    <th>房间号</th>
                                    <th>床位数</th>
                                    <th>备注</th>
                                    ${isAdmin ? '<th>操作</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${buildingRooms.sort((a, b) => {
                                    const numA = parseInt(a.room) || 0;
                                    const numB = parseInt(b.room) || 0;
                                    return numA - numB;
                                }).map((room, i) => `
                                    <tr>
                                        ${isAdmin ? `<td>
                                            <div class="checkbox-wrapper">
                                                <input type="checkbox" class="room-checkbox" data-id="${room.id}" onchange="updateRoomSelection()">
                                            </div>
                                        </td>` : ''}
                                        <td>${i + 1}</td>
                                        <td>${room.room}</td>
                                        <td>${room.beds}</td>
                                        <td>${room.notes || '-'}</td>
                                        ${isAdmin ? `<td>
                                            <button class="btn btn-info" onclick="editRoom(${room.id})">编辑</button>
                                            <button class="btn btn-danger" onclick="deleteRoom(${room.id})">删除</button>
                                        </td>` : ''}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<p style="text-align:center;color:#999;padding:30px;">暂无房间配置,请点击"添加房间"按钮开始配置</p>';
            }
            
            container.innerHTML = html;
        }

        function showAddRoom() {
            if (currentUser.role !== 'admin') {
                alert('只有管理员可以添加房间');
                return;
            }
            editingRoomId = null;
            document.getElementById('roomModalTitle').textContent = '添加房间';
            document.getElementById('roomBuilding').value = '';
            document.getElementById('roomNumber').value = '';
            document.getElementById('roomBeds').value = '';
            document.getElementById('roomNotes').value = '';
            document.getElementById('roomModal').classList.add('active');
        }

        function editRoom(id) {
            if (currentUser.role !== 'admin') {
                alert('只有管理员可以编辑房间');
                return;
            }
            const room = rooms.find(r => r.id === id);
            if (!room) return;
            
            editingRoomId = id;
            document.getElementById('roomModalTitle').textContent = '编辑房间';
            document.getElementById('roomBuilding').value = room.building;
            document.getElementById('roomNumber').value = room.room;
            document.getElementById('roomBeds').value = room.beds;
            document.getElementById('roomNotes').value = room.notes || '';
            document.getElementById('roomModal').classList.add('active');
        }

        function saveRoom(e) {
            e.preventDefault();
            
            if (currentUser.role !== 'admin') {
                alert('只有管理员可以保存房间信息');
                return;
            }
            
            const data = {
                id: editingRoomId || Date.now(),
                building: document.getElementById('roomBuilding').value,
                room: document.getElementById('roomNumber').value,
                beds: parseInt(document.getElementById('roomBeds').value) || 0,
                notes: document.getElementById('roomNotes').value
            };
            
            // 检查是否重复
            const isDuplicate = rooms.some(r => 
                r.building === data.building && 
                r.room === data.room && 
                r.id !== editingRoomId
            );
            
            if (isDuplicate) {
                alert('该楼栋的房间号已存在!');
                return;
            }
            
            if (editingRoomId) {
                rooms = rooms.map(r => r.id === editingRoomId ? data : r);
                alert('修改成功!');
            } else {
                rooms.push(data);
                alert('添加成功!');
            }
            
            localStorage.setItem('dormRooms', JSON.stringify(rooms));
            closeRoomModal();
            renderRooms();
        }

        function closeRoomModal() {
            document.getElementById('roomModal').classList.remove('active');
        }

        function deleteRoom(id) {
            if (currentUser.role !== 'admin') {
                alert('只有管理员可以删除房间');
                return;
            }
            if (confirm('确定删除该房间配置吗?')) {
                rooms = rooms.filter(r => r.id !== id);
                localStorage.setItem('dormRooms', JSON.stringify(rooms));
                renderRooms();
                alert('删除成功!');
            }
        }

        function exportRoomsExcel() {
            if (currentUser.role !== 'admin') {
                alert('只有管理员可以导出数据');
                return;
            }
            if (rooms.length === 0) {
                alert('暂无房间配置数据');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(rooms.map((r, i) => ({
                序号: i + 1,
                楼栋: r.building,
                房间号: r.room,
                床位数: r.beds,
                备注: r.notes || ''
            })));
            
            autoFitColumns(ws); // 自动调整列宽
            // 设置冻结首行
            ws['!freeze'] = { xSplit: 0, ySplit: 1 };
            XLSX.utils.book_append_sheet(wb, ws, '房间配置');
            XLSX.writeFile(wb, '房间配置_' + new Date().toLocaleDateString('zh-CN').replace(/\//g, '-') + '.xlsx');
        }

        function importRoomsExcel() {
            if (currentUser.role !== 'admin') {
                alert('只有管理员可以导入房间数据');
                return;
            }
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const wb = XLSX.read(data, {type: 'array'});
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(ws, {raw: false, defval: ''});
                        
                        if (json.length === 0) {
                            alert('Excel文件为空!');
                            return;
                        }
                        
                        let success = 0;
                        let error = 0;
                        
                        json.forEach((row, index) => {
                            const building = row['楼栋'] || row['building'] || '';
                            const room = row['房间号'] || row['房间'] || row['room'] || '';
                            const beds = parseInt(row['床位数'] || row['床位'] || row['beds']) || 0;
                            const notes = row['备注'] || row['notes'] || '';
                            
                            if (!building || !room || beds <= 0) {
                                error++;
                                return;
                            }
                            
                            // 检查是否已存在
                            const existing = rooms.find(r => r.building === building && r.room === room);
                            if (existing) {
                                error++;
                                return;
                            }
                            
                            rooms.push({
                                id: Date.now() + Math.random(),
                                building,
                                room,
                                beds,
                                notes
                            });
                            success++;
                        });
                        
                        localStorage.setItem('dormRooms', JSON.stringify(rooms));
                        renderRooms();
                        alert(`导入完成!\n成功: ${success} 条\n失败: ${error} 条`);
                    } catch (err) {
                        alert('文件解析失败: ' + err.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            };
            input.click();
        }

        // 房间批量删除相关函数
        function updateRoomSelection() {
            const checkboxes = document.querySelectorAll('.room-checkbox:checked');
            const count = checkboxes.length;
            
            if (count > 0) {
                document.getElementById('batchActionsRooms').style.display = 'flex';
                document.getElementById('selectedCountRooms').textContent = count;
            } else {
                document.getElementById('batchActionsRooms').style.display = 'none';
            }
            
            // 更新全选复选框状态
            document.querySelectorAll('.select-all-rooms').forEach(selectAll => {
                const section = selectAll.closest('.building-section');
                if (!section) return;
                
                const building = section.querySelector('h3').textContent.split(' ')[0];
                const buildingCheckboxes = Array.from(section.querySelectorAll('.room-checkbox'));
                const buildingChecked = buildingCheckboxes.filter(cb => cb.checked);
                
                selectAll.checked = buildingCheckboxes.length > 0 && buildingCheckboxes.length === buildingChecked.length;
                selectAll.indeterminate = buildingChecked.length > 0 && buildingChecked.length < buildingCheckboxes.length;
            });
        }

        function toggleSelectAllRooms(building) {
            const buildingSections = document.querySelectorAll('.building-section');
            buildingSections.forEach(section => {
                const header = section.querySelector('h3');
                if (header && header.textContent.includes(building)) {
                    const selectAll = section.querySelector('.select-all-rooms');
                    const checkboxes = section.querySelectorAll('.room-checkbox');
                    checkboxes.forEach(cb => cb.checked = selectAll.checked);
                }
            });
            updateRoomSelection();
        }

        function clearSelectionRooms() {
            document.querySelectorAll('.room-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.select-all-rooms').forEach(cb => cb.checked = false);
            updateRoomSelection();
        }

        function batchDeleteRooms() {
            if (currentUser.role !== 'admin') {
                alert('只有管理员可以批量删除房间');
                return;
            }
            const checkboxes = document.querySelectorAll('.room-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('请先选择要删除的房间');
                return;
            }
            
            if (!confirm(`确定要删除选中的 ${checkboxes.length} 个房间吗？此操作不可恢复！`)) {
                return;
            }
            
            // 获取要删除的ID，确保类型一致
            const idsToDelete = Array.from(checkboxes).map(cb => {
                const id = cb.dataset.id;
                // 尝试转换为数字，如果失败则保持原样
                const numId = Number(id);
                return isNaN(numId) ? id : numId;
            });
            
            console.log('删除前房间数:', rooms.length);
            console.log('要删除的IDs:', idsToDelete);
            console.log('现有房间IDs:', rooms.map(r => r.id));
            
            // 过滤掉要删除的房间
            const originalLength = rooms.length;
            rooms = rooms.filter(r => !idsToDelete.includes(r.id));
            
            console.log('删除后房间数:', rooms.length);
            console.log('实际删除数:', originalLength - rooms.length);
            
            // 保存到localStorage
            localStorage.setItem('dormRooms', JSON.stringify(rooms));
            
            // 重新渲染
            renderRooms();
            updateRoomSelection();
            
            alert(`成功删除 ${originalLength - rooms.length} 个房间`);
        }

        // ========== 宿舍平面图相关函数 ==========
        function renderFloorPlan() {
            const container = document.getElementById('floorplanContainer');
            const activeRecords = records.filter(r => !r.checkOutDate);
            
            if (rooms.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">暂无房间配置，请先在"房间管理"中添加房间</p>';
                return;
            }
            
            // 按楼栋分组
            const buildingGroups = {};
            rooms.forEach(room => {
                if (!buildingGroups[room.building]) {
                    buildingGroups[room.building] = [];
                }
                buildingGroups[room.building].push(room);
            });
            
            // 统计每个房间的入住情况
            const roomOccupancy = {};
            activeRecords.forEach(r => {
                if (!r.building || !r.room) return;
                const key = `${r.building}-${r.room}`;
                if (!roomOccupancy[key]) {
                    roomOccupancy[key] = [];
                }
                roomOccupancy[key].push(r);
            });
            
            let html = '';
            
            // 遍历每个楼栋
            Object.keys(buildingGroups).sort().forEach(building => {
                const buildingRooms = buildingGroups[building];
                
                // 计算当前楼栋的统计数据
                let buildingTotalBeds = 0;
                let buildingOccupiedBeds = 0;
                
                buildingRooms.forEach(room => {
                    const totalBeds = parseInt(room.beds) || 0;
                    buildingTotalBeds += totalBeds;
                    const key = `${room.building}-${room.room}`;
                    const occupants = roomOccupancy[key] || [];
                    buildingOccupiedBeds += occupants.length;
                });
                
                const buildingAvailableBeds = buildingTotalBeds - buildingOccupiedBeds;
                const buildingOccupancyRate = buildingTotalBeds > 0 
                    ? Math.round((buildingOccupiedBeds / buildingTotalBeds) * 100) 
                    : 0;
                
                html += `
                    <div class="floorplan-building">
                        <div class="floorplan-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${building}</span>
                            <span style="font-size: 16px; font-weight: normal; display: flex; gap: 30px;">
                                <span><strong style="color: #e3f2fd; margin-right: 5px;">${buildingTotalBeds}</strong>总床位</span>
                                <span><strong style="color: #ffcdd2; margin-right: 5px;">${buildingOccupiedBeds}</strong>已入住</span>
                                <span><strong style="color: #c8e6c9; margin-right: 5px;">${buildingAvailableBeds}</strong>剩余</span>
                                <span><strong style="color: #ffe0b2; margin-right: 5px;">${buildingOccupancyRate}%</strong>入住率</span>
                            </span>
                        </div>
                `;
                
                // 特殊处理办公三楼：按北/南分组
                if (building === '办公三楼') {
                    // 分组房间
                    const northRooms = buildingRooms.filter(room => room.room.includes('北'));
                    const southRooms = buildingRooms.filter(room => room.room.includes('南'));
                    
                    // 排序函数：提取数字部分进行排序
                    const sortByNumber = (a, b) => {
                        const numA = parseInt(a.room.match(/\d+/)?.[0]) || 0;
                        const numB = parseInt(b.room.match(/\d+/)?.[0]) || 0;
                        return numA - numB;
                    };
                    
                    northRooms.sort(sortByNumber);
                    southRooms.sort(sortByNumber);
                    
                    // 北侧房间
                    if (northRooms.length > 0) {
                        html += `<div style="padding: 10px 20px; background: #f5f5f5;"><strong>北侧</strong></div>`;
                        html += `<div class="floorplan-rooms">`;
                        northRooms.forEach(room => {
                            html += generateRoomCard(room, roomOccupancy);
                        });
                        html += `</div>`;
                    }
                    
                    // 南侧房间
                    if (southRooms.length > 0) {
                        html += `<div style="padding: 10px 20px; background: #f5f5f5;"><strong>南侧</strong></div>`;
                        html += `<div class="floorplan-rooms">`;
                        southRooms.forEach(room => {
                            html += generateRoomCard(room, roomOccupancy);
                        });
                        html += `</div>`;
                    }
                } else {
                    // 其他楼栋：正常排序显示
                    html += `<div class="floorplan-rooms">`;
                    buildingRooms.sort((a, b) => {
                        const numA = parseInt(a.room) || 0;
                        const numB = parseInt(b.room) || 0;
                        return numA - numB;
                    }).forEach(room => {
                        html += generateRoomCard(room, roomOccupancy);
                    });
                    html += `</div>`;
                }
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }
        
        // 生成房间卡片的辅助函数
        function generateRoomCard(room, roomOccupancy) {
            const key = `${room.building}-${room.room}`;
            const occupants = roomOccupancy[key] || [];
            const totalBeds = parseInt(room.beds) || 0;
            const occupiedBeds = occupants.length;
            
            // 确定房间状态
            let status = 'empty';
            let statusText = '空房';
            let statusBadge = '空房';
            
            if (occupiedBeds >= totalBeds && totalBeds > 0) {
                status = 'full';
                statusText = '已满';
                statusBadge = '已满';
            } else if (occupiedBeds > 0) {
                status = 'partial';
                statusText = '部分入住';
                statusBadge = '部分';
            }
            
            return `
                <div class="room-card ${status}" onclick="showRoomDetail('${room.building}', '${room.room}')">
                    <div class="room-badge ${status}">${statusBadge}</div>
                    <div class="room-number">${room.room}号房</div>
                    <div class="room-status">${statusText}</div>
                    <div class="room-beds">
                        已入住: <strong style="color:#f44336;">${occupiedBeds}</strong> / 
                        总床位: <strong>${totalBeds}</strong>
                    </div>
                    ${room.notes ? `<div style="font-size:11px;color:#999;margin-top:5px;">${room.notes}</div>` : ''}
                </div>
            `;
        }

        function showRoomDetail(building, roomNumber) {
            const room = rooms.find(r => r.building === building && r.room === roomNumber);
            if (!room) {
                alert('房间信息不存在');
                return;
            }
            
            const activeRecords = records.filter(r => !r.checkOutDate);
            const occupants = activeRecords.filter(r => r.building === building && r.room === roomNumber);
            const totalBeds = parseInt(room.beds) || 0;
            const occupiedBeds = occupants.length;
            const availableBeds = totalBeds - occupiedBeds;
            
            // 获取所有已占用的床位号
            const occupiedBedNumbers = new Set(occupants.map(r => r.bed).filter(Boolean));
            
            // 生成床位可视化
            let bedVisualHtml = '<div class="bed-visual">';
            for (let i = 1; i <= totalBeds; i++) {
                const isOccupied = occupiedBedNumbers.has(i.toString()) || occupiedBedNumbers.has(i);
                const occupant = occupants.find(r => r.bed == i);
                
                if (isOccupied && occupant) {
                    bedVisualHtml += `
                        <div class="bed-item occupied" title="${occupant.name}">
                            ${i}号床<br>
                            <small>${occupant.name}</small>
                        </div>
                    `;
                } else {
                    bedVisualHtml += `
                        <div class="bed-item empty">
                            ${i}号床<br>
                            <small>空闲</small>
                        </div>
                    `;
                }
            }
            bedVisualHtml += '</div>';
            
            // 生成入住人员列表
            let residentsHtml = '';
            if (occupants.length > 0) {
                residentsHtml = '<div class="resident-list">';
                residentsHtml += '<h4 style="margin-bottom:10px;">入住人员：</h4>';
                
                occupants.forEach(person => {
                    residentsHtml += `
                        <div class="resident-item">
                            <div class="resident-name">${person.name} - ${person.bed}号床</div>
                            <div class="resident-info">
                                <span>性别: ${person.gender}</span>
                                <span>年龄: ${person.age}</span>
                                <span>电话: ${person.phone}</span>
                                ${person.department ? `<span>部门: ${person.department}</span>` : ''}
                                ${person.checkInDate ? `<span>入住日期: ${person.checkInDate}</span>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                residentsHtml += '</div>';
            } else {
                residentsHtml = '<p style="text-align:center;color:#999;padding:20px;background:#f5f5f5;border-radius:6px;">该房间暂无入住人员</p>';
            }
            
            const content = `
                <div style="background:#f5f5f5;padding:15px;border-radius:6px;margin-bottom:15px;">
                    <div style="display:flex;justify-content:space-around;text-align:center;">
                        <div>
                            <div style="font-size:20px;font-weight:bold;color:#2196F3;">${totalBeds}</div>
                            <div style="color:#666;font-size:13px;">总床位</div>
                        </div>
                        <div>
                            <div style="font-size:20px;font-weight:bold;color:#f44336;">${occupiedBeds}</div>
                            <div style="color:#666;font-size:13px;">已入住</div>
                        </div>
                        <div>
                            <div style="font-size:20px;font-weight:bold;color:#4CAF50;">${availableBeds}</div>
                            <div style="color:#666;font-size:13px;">剩余</div>
                        </div>
                    </div>
                </div>
                
                <h4 style="margin:15px 0 10px 0;">床位分布：</h4>
                ${bedVisualHtml}
                
                ${residentsHtml}
            `;
            
            document.getElementById('roomDetailTitle').textContent = `${building} - ${roomNumber}号房`;
            document.getElementById('roomDetailContent').innerHTML = content;
            document.getElementById('roomDetailModal').classList.add('active');
        }

        function closeRoomDetail() {
            document.getElementById('roomDetailModal').classList.remove('active');
        }

        // ========== 初始化 ==========
        window.onload = async function() {
            // 检查是否已登录
            const savedUser = localStorage.getItem('currentUser');
            
            // 如果已登录，直接显示主应用，不需要其他检查
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    // 异步加载用户数据（不阻塞登录）
                    loadUsersFromGitHub().catch(err => console.error('加载云端数据失败:', err));
                    showMainApp();
                    return;
                } catch (error) {
                    console.error('解析用户数据失败:', error);
                    localStorage.removeItem('currentUser');
                }
            }
            
            // 未登录：优先从GitHub加载用户数据
            await loadUsersFromGitHub();
            
            // 检查是否首次使用（只有在本地和云端都没有用户数据时才提示）
            const needSetup = checkFirstTimeUse();
            
            // 如果不需要设置，显示登录界面
            if (!needSetup) {
                showLoginScreen();
            }
        };
    </script>
</body>
</html>