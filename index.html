<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¿èˆä½å®¿äººå‘˜ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .card { background: white; border-radius: 10px; padding: 30px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #333; font-size: 28px; margin-bottom: 20px; text-align: center; }
        h2 { color: #333; font-size: 22px; margin-bottom: 15px; }
        h3 { color: #555; font-size: 18px; margin: 20px 0 10px 0; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; margin: 5px; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-info { background: #2196F3; color: white; }
        .btn-warning { background: #FF9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 15px; background: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        .tab.active { background: #2196F3; color: white; }
        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: bold; margin-bottom: 5px; }
        .form-group input, .form-group select, .form-group textarea { padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .form-group input:focus { border-color: #2196F3; outline: none; }
        .error { color: red; font-size: 12px; margin-top: 5px; }
        .success { color: green; font-size: 12px; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f5f5f5; font-weight: bold; position: relative; }
        tr:hover { background: #f9f9f9; }
        .hidden { display: none; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 36px; font-weight: bold; margin: 10px 0; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .checkbox-wrapper { display: flex; align-items: center; justify-content: center; }
        .checkbox-wrapper input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .batch-actions { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        .selected-count { background: #fff3cd; padding: 8px 15px; border-radius: 6px; font-weight: bold; color: #856404; }
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .bed-stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px; }
        .bed-stat-item { background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3; }
        .bed-stat-header { font-weight: bold; font-size: 16px; margin-bottom: 10px; color: #333; }
        .bed-stat-details { display: flex; justify-content: space-between; margin-top: 8px; font-size: 14px; }
        .bed-stat-label { color: #666; }
        .bed-stat-value { font-weight: bold; }
        .occupied { color: #f44336; }
        .available { color: #4CAF50; }
        .progress-bar { width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4CAF50, #2196F3); transition: width 0.3s; }
        .building-section { margin-bottom: 30px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>æ±Ÿè‹å¸¸é˜´æ²™ç°ä»£å†œä¸šå‘å±•æœ‰é™å…¬å¸</h1>
            <h2 style="text-align: center; color: #666; margin-top: 10px;">ä½å®¿äººå‘˜ç®¡ç†ç³»ç»Ÿ</h2>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('register')">äººå‘˜ç™»è®°</button>
            <button class="tab" onclick="switchTab('list')">äººå‘˜åˆ—è¡¨</button>
            <button class="tab" onclick="switchTab('checkout')">é€€å®¿äººå‘˜</button>
            <button class="tab" onclick="switchTab('rooms')">æˆ¿é—´ç®¡ç†</button>
            <button class="tab" onclick="switchTab('stats')">ç»Ÿè®¡åˆ†æ</button>
        </div>

        <!-- ç™»è®°è¡¨å• -->
        <div id="registerTab" class="card">
            <h2 id="formTitle">æ–°å¢äººå‘˜ç™»è®°</h2>
            <form onsubmit="handleSubmit(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>å§“å *</label>
                        <input type="text" id="name" required>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label>èº«ä»½è¯å· *</label>
                        <input type="text" id="idCard" maxlength="18" required oninput="validateIdCard()">
                        <span id="idError" class="error hidden"></span>
                        <span id="idSuccess" class="success hidden"></span>
                    </div>
                    <div class="form-group">
                        <label>æ€§åˆ«</label>
                        <input type="text" id="gender" readonly>
                    </div>
                    <div class="form-group">
                        <label>å‡ºç”Ÿæ—¥æœŸ</label>
                        <input type="text" id="birthDate" readonly>
                    </div>
                    <div class="form-group">
                        <label>å¹´é¾„</label>
                        <input type="text" id="age" readonly>
                    </div>
                    <div class="form-group">
                        <label>è”ç³»ç”µè¯ *</label>
                        <input type="tel" id="phone" required>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label>å®¶åº­åœ°å€</label>
                        <input type="text" id="address">
                    </div>
                    <div class="form-group">
                        <label>æ°‘æ—</label>
                        <input type="text" id="ethnicity">
                    </div>
                    <div class="form-group">
                        <label>æ¥æºå•ä½</label>
                        <input type="text" id="sourceUnit">
                    </div>
                    <div class="form-group">
                        <label>å…¥èŒéƒ¨é—¨</label>
                        <input type="text" id="department">
                    </div>
                    <div class="form-group">
                        <label>å®¿èˆæ¥¼æ ‹</label>
                        <select id="building" onchange="updateRoomOptions()">
                            <option value="">è¯·é€‰æ‹©æ¥¼æ ‹</option>
                            <option value="å®¿èˆäºŒæ¥¼">å®¿èˆäºŒæ¥¼</option>
                            <option value="å®¿èˆä¸‰æ¥¼">å®¿èˆä¸‰æ¥¼</option>
                            <option value="åŠå…¬ä¸‰æ¥¼">åŠå…¬ä¸‰æ¥¼</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æˆ¿é—´å·</label>
                        <select id="room"><option value="">è¯·å…ˆé€‰æ‹©æ¥¼æ ‹</option></select>
                    </div>
                    <div class="form-group">
                        <label>åºŠä½å·</label>
                        <input type="text" id="bed">
                    </div>
                    <div class="form-group">
                        <label>å…¥ä½æ—¥æœŸ</label>
                        <input type="date" id="checkInDate">
                    </div>
                    <div class="form-group">
                        <label>ç´§æ€¥è”ç³»äºº</label>
                        <input type="text" id="emergencyContact">
                    </div>
                    <div class="form-group">
                        <label>ç´§æ€¥è”ç³»ç”µè¯</label>
                        <input type="tel" id="emergencyPhone">
                    </div>
                    <div class="form-group">
                        <label>ç¦»èŒæ—¥æœŸ</label>
                        <input type="date" id="resignDate">
                    </div>
                    <div class="form-group">
                        <label>äº¤å‰²æ‰‹ç»­</label>
                        <select id="handover">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                            <option value="æœªå®Œæˆ">æœªå®Œæˆ</option>
                            <option value="è¿›è¡Œä¸­">è¿›è¡Œä¸­</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: span 3;">
                        <label>å¤‡æ³¨è¯´æ˜</label>
                        <textarea id="notes" rows="3"></textarea>
                    </div>
                </div>
                <button type="submit" class="btn btn-info">ğŸ’¾ ç¡®å®šä¿å­˜</button>
                <button type="button" class="btn btn-warning hidden" id="cancelBtn" onclick="cancelEdit()">å–æ¶ˆç¼–è¾‘</button>
            </form>
        </div>

        <!-- äººå‘˜åˆ—è¡¨ -->
        <div id="listTab" class="card hidden">
            <h2>åœ¨ä½äººå‘˜åˆ—è¡¨</h2>
            <div class="toolbar">
                <input type="text" id="search" placeholder="æœç´¢å§“åã€èº«ä»½è¯å·ã€ç”µè¯..." style="flex:1;max-width:300px;padding:10px;" oninput="filterRecords()">
                <select id="dormFilter" style="padding:10px;border:1px solid #ddd;border-radius:6px;min-width:200px;" onchange="filterRecords()">
                    <option value="">å…¨éƒ¨å®¿èˆ</option>
                </select>
                <button class="btn btn-primary" onclick="exportExcel()">ğŸ“¥ å¯¼å‡ºExcel</button>
                <button class="btn btn-info" onclick="showImport()">ğŸ“¤ æ‰¹é‡å¯¼å…¥</button>
                <div class="batch-actions" id="batchActions" style="display:none;">
                    <span class="selected-count">å·²é€‰æ‹© <span id="selectedCount">0</span> æ¡</span>
                    <button class="btn btn-warning" onclick="batchCheckout()">ğŸšª æ‰¹é‡é€€å®¿</button>
                    <button class="btn btn-danger" onclick="batchDelete()">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
                    <button class="btn btn-secondary" onclick="clearSelection()">å–æ¶ˆé€‰æ‹©</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th style="width:50px;"><div class="checkbox-wrapper"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></div></th>
                        <th>åºå·</th><th>å§“å</th><th>æ€§åˆ«</th><th>å¹´é¾„</th><th>ç”µè¯</th><th>éƒ¨é—¨</th><th>å®¿èˆ</th><th>å…¥ä½æ—¥æœŸ</th><th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <!-- é€€å®¿äººå‘˜ -->
        <div id="checkoutTab" class="card hidden">
            <h2>é€€å®¿äººå‘˜åˆ—è¡¨</h2>
            <div class="toolbar">
                <input type="text" id="searchCheckout" placeholder="æœç´¢å§“åã€èº«ä»½è¯å·ã€ç”µè¯..." style="flex:1;max-width:400px;padding:10px;" oninput="filterCheckoutRecords()">
                <div class="batch-actions" id="batchActionsCheckout" style="display:none;">
                    <span class="selected-count">å·²é€‰æ‹© <span id="selectedCountCheckout">0</span> æ¡</span>
                    <button class="btn btn-danger" onclick="batchDeleteCheckout()">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
                    <button class="btn btn-secondary" onclick="clearSelectionCheckout()">å–æ¶ˆé€‰æ‹©</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th style="width:50px;"><div class="checkbox-wrapper"><input type="checkbox" id="selectAllCheckout" onchange="toggleSelectAllCheckout()"></div></th>
                        <th>åºå·</th><th>å§“å</th><th>æ€§åˆ«</th><th>ç”µè¯</th><th>éƒ¨é—¨</th><th>åŸå®¿èˆ</th><th>å…¥ä½æ—¥æœŸ</th><th>é€€å®¿æ—¥æœŸ</th><th>ç¦»èŒæ—¥æœŸ</th><th>äº¤å‰²æ‰‹ç»­</th><th>é€€å®¿åŸå› </th><th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="checkoutTableBody"></tbody>
            </table>
        </div>

        <!-- æˆ¿é—´ç®¡ç† -->
        <div id="roomsTab" class="card hidden">
            <h2>æˆ¿é—´ç®¡ç†</h2>
            <div class="toolbar">
                <div>
                    <button class="btn btn-primary" onclick="showAddRoom()">â• æ·»åŠ æˆ¿é—´</button>
                    <button class="btn btn-info" onclick="importRoomsExcel()">ğŸ“¤ æ‰¹é‡å¯¼å…¥æˆ¿é—´</button>
                    <button class="btn btn-warning" onclick="exportRoomsExcel()">ğŸ“¥ å¯¼å‡ºæˆ¿é—´é…ç½®</button>
                </div>
                <div class="batch-actions" id="batchActionsRooms" style="display:none;">
                    <span class="selected-count">å·²é€‰æ‹© <span id="selectedCountRooms">0</span> æ¡</span>
                    <button class="btn btn-danger" onclick="batchDeleteRooms()">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
                    <button class="btn btn-secondary" onclick="clearSelectionRooms()">å–æ¶ˆé€‰æ‹©</button>
                </div>
            </div>
            <div id="roomsContainer"></div>
        </div>

        <!-- ç»Ÿè®¡åˆ†æ -->
        <div id="statsTab" class="card hidden">
            <h2>æ•°æ®ç»Ÿè®¡</h2>
            <div class="stats">
                <div class="stat-card"><div>æ€»äººæ•°</div><div class="stat-value" style="color:#2196F3;" id="total">0</div></div>
                <div class="stat-card"><div>åœ¨ä½äººæ•°</div><div class="stat-value" style="color:#4CAF50;" id="active">0</div></div>
                <div class="stat-card"><div>å·²é€€å®¿</div><div class="stat-value" style="color:#FF9800;" id="checkout">0</div></div>
                <div class="stat-card"><div>æ¥¼æ ‹æ•°</div><div class="stat-value" style="color:#9C27B0;" id="buildings">0</div></div>
            </div>
            <div class="stats">
                <div class="stat-card"><div>æ€»æˆ¿é—´æ•°</div><div class="stat-value" style="color:#00BCD4;" id="totalRooms">0</div></div>
                <div class="stat-card"><div>æ€»åºŠä½æ•°</div><div class="stat-value" style="color:#FF5722;" id="totalBeds">0</div></div>
                <div class="stat-card">
                    <div>å·²å…¥ä½åºŠä½</div>
                    <div class="stat-value" style="color:#f44336;" id="occupiedBeds">0</div>
                    <div style="font-size:12px;color:#666;margin-top:8px;">
                        æ™®é€š <span id="occupiedBedsNormal" style="font-weight:bold;color:#f44336;">0</span> | 
                        ç®¡ç† <span id="occupiedBedsManager" style="font-weight:bold;color:#9C27B0;">0</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div>å‰©ä½™åºŠä½</div>
                    <div class="stat-value" style="color:#4CAF50;" id="availableBeds">0</div>
                    <div style="font-size:12px;color:#666;margin-top:8px;">
                        æ™®é€š <span id="availableBedsNormal" style="font-weight:bold;color:#4CAF50;">0</span> | 
                        ç®¡ç† <span id="availableBedsManager" style="font-weight:bold;color:#9C27B0;">0</span>
                    </div>
                </div>
            </div>
            <h2>æˆ¿å‹ç»Ÿè®¡</h2>
            <div id="roomTypeStatsContainer"></div>
            <h2>åºŠä½ä½™é‡ç»Ÿè®¡</h2>
            <div id="bedStatsContainer"></div>
        </div>

        <!-- æ¨¡æ€æ¡† -->
        <div id="importModal" class="modal">
            <div class="modal-content">
                <h3>æ‰¹é‡å¯¼å…¥æ•°æ®</h3>
                <p style="margin:15px 0;">è¯·ä¸Šä¼ Excelæ–‡ä»¶,æ”¯æŒåŒ…å«ä»¥ä¸‹åˆ—:å§“åã€èº«ä»½è¯å·ã€è”ç³»ç”µè¯ã€éƒ¨é—¨ã€å®¿èˆç­‰ä¿¡æ¯</p>
                <p style="margin:15px 0;color:#ff9800;font-weight:bold;">âš ï¸ æ‰¹é‡å¯¼å…¥å·²å…³é—­èº«ä»½è¯å·æ ¼å¼éªŒè¯,å¯å¯¼å…¥ä»»æ„æ ¼å¼æ•°æ®</p>
                <input type="file" accept=".xlsx,.xls" onchange="handleImport(event)" style="margin-bottom:15px;">
                <button class="btn btn-danger" onclick="closeImport()">å…³é—­</button>
            </div>
        </div>

        <div id="batchCheckoutModal" class="modal">
            <div class="modal-content">
                <h3>æ‰¹é‡é€€å®¿</h3>
                <p style="margin:15px 0;">å·²é€‰æ‹© <strong id="batchCheckoutCount">0</strong> äºº</p>
                <div class="form-group">
                    <label>é€€å®¿åŸå› </label>
                    <textarea id="batchCheckoutReason" rows="3" placeholder="è¯·è¾“å…¥é€€å®¿åŸå› "></textarea>
                </div>
                <button class="btn btn-warning" onclick="confirmBatchCheckout()">ç¡®è®¤é€€å®¿</button>
                <button class="btn btn-secondary" onclick="closeBatchCheckout()">å–æ¶ˆ</button>
            </div>
        </div>

        <div id="roomModal" class="modal">
            <div class="modal-content">
                <h3 id="roomModalTitle">æ·»åŠ æˆ¿é—´</h3>
                <form onsubmit="saveRoom(event)">
                    <div class="form-group" style="margin-bottom:15px;">
                        <label>æ¥¼æ ‹</label>
                        <select id="roomBuilding" required>
                            <option value="">è¯·é€‰æ‹©æ¥¼æ ‹</option>
                            <option value="å®¿èˆäºŒæ¥¼">å®¿èˆäºŒæ¥¼</option>
                            <option value="å®¿èˆä¸‰æ¥¼">å®¿èˆä¸‰æ¥¼</option>
                            <option value="åŠå…¬ä¸‰æ¥¼">åŠå…¬ä¸‰æ¥¼</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom:15px;">
                        <label>æˆ¿é—´å·</label>
                        <input type="text" id="roomNumber" required>
                    </div>
                    <div class="form-group" style="margin-bottom:15px;">
                        <label>åºŠä½æ•°</label>
                        <input type="number" id="roomBeds" min="1" required>
                    </div>
                    <div class="form-group" style="margin-bottom:15px;">
                        <label>å¤‡æ³¨</label>
                        <input type="text" id="roomNotes">
                    </div>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    <button type="button" class="btn btn-secondary" onclick="closeRoomModal()">å–æ¶ˆ</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        let records = JSON.parse(localStorage.getItem('dormRecords') || '[]');
        let rooms = JSON.parse(localStorage.getItem('dormRooms') || '[]');
        let selectedIds = new Set();
        let selectedCheckoutIds = new Set();
        let editingId = null;
        let editingRoomId = null;

        // å·¥å…·å‡½æ•°
        const isManagerRoom = (room) => (room.room && room.room.toString().includes('ç®¡ç†')) || (room.notes && room.notes.includes('ç®¡ç†'));
        
        const getRoomTypeName = (beds) => {
            if (beds === 1) return 'å•äººé—´';
            if (beds === 2) return 'åŒäººé—´';
            if (beds === 3) return 'ä¸‰äººé—´';
            if (beds === 4) return 'å››äººé—´';
            if (beds >= 5) return `${beds}äººé—´`;
            return 'æœªé…ç½®';
        };

        const getFilteredRecords = (activeOnly = true, searchId = 'search', includeDormFilter = false) => {
            const source = activeOnly ? records.filter(r => !r.checkOutDate) : records.filter(r => r.checkOutDate);
            const search = document.getElementById(searchId).value.toLowerCase();
            let filtered = source.filter(r => 
                r.name.toLowerCase().includes(search) || 
                r.idCard.includes(search) || 
                r.phone.includes(search)
            );
            
            if (includeDormFilter) {
                const dormFilter = document.getElementById('dormFilter').value;
                if (dormFilter) {
                    filtered = filtered.filter(r => `${r.building || ''}-${r.room || ''}` === dormFilter);
                }
            }
            return filtered;
        };

        // Tabåˆ‡æ¢
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.card').forEach((c, i) => i > 0 && c.classList.add('hidden'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.remove('hidden');
            
            const actions = {
                list: () => { clearSelection(); updateDormFilterOptions(); renderTable(); },
                checkout: () => { clearSelectionCheckout(); renderCheckoutTable(); },
                rooms: renderRooms,
                stats: () => { renderStats(); renderRoomTypeStats(); renderBedStats(); }
            };
            actions[tab]?.();
        }

        // äººå‘˜åˆ—è¡¨ç›¸å…³
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            const filtered = getFilteredRecords(true, 'search', true);
            selectAll ? filtered.forEach(r => selectedIds.add(r.id)) : selectedIds.clear();
            updateBatchActions();
            renderTable();
        }

        function toggleSelect(id) {
            selectedIds.has(id) ? selectedIds.delete(id) : selectedIds.add(id);
            updateBatchActions();
            renderTable();
        }

        function updateBatchActions() {
            const count = selectedIds.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('batchActions').style.display = count > 0 ? 'flex' : 'none';
            const filtered = getFilteredRecords(true, 'search', true);
            document.getElementById('selectAll').checked = filtered.length > 0 && filtered.every(r => selectedIds.has(r.id));
        }

        function clearSelection() {
            selectedIds.clear();
            updateBatchActions();
            renderTable();
        }

        function batchDelete() {
            if (selectedIds.size === 0) return;
            if (confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedIds.size} æ¡è®°å½•å—?åˆ é™¤åæ— æ³•æ¢å¤!`)) {
                records = records.filter(r => !selectedIds.has(r.id));
                localStorage.setItem('dormRecords', JSON.stringify(records));
                clearSelection();
                alert('æ‰¹é‡åˆ é™¤æˆåŠŸ!');
            }
        }

        function batchCheckout() {
            if (selectedIds.size === 0) return;
            document.getElementById('batchCheckoutCount').textContent = selectedIds.size;
            document.getElementById('batchCheckoutReason').value = '';
            document.getElementById('batchCheckoutModal').classList.add('active');
        }

        function closeBatchCheckout() {
            document.getElementById('batchCheckoutModal').classList.remove('active');
        }

        function confirmBatchCheckout() {
            const reason = document.getElementById('batchCheckoutReason').value.trim();
            if (!reason) return alert('è¯·è¾“å…¥é€€å®¿åŸå› !');

            const checkoutDate = new Date().toLocaleDateString();
            records = records.map(r => selectedIds.has(r.id) ? {...r, checkOutDate: checkoutDate, checkOutReason: reason} : r);
            localStorage.setItem('dormRecords', JSON.stringify(records));
            closeBatchCheckout();
            clearSelection();
            alert(`æˆåŠŸé€€å®¿ ${selectedIds.size} äºº`);
        }

        function filterRecords() { renderTable(); }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const filtered = getFilteredRecords(true, 'search', true);
            tbody.innerHTML = filtered.map((r, i) => `
                <tr>
                    <td><div class="checkbox-wrapper"><input type="checkbox" ${selectedIds.has(r.id) ? 'checked' : ''} onchange="toggleSelect(${r.id})"></div></td>
                    <td>${i + 1}</td><td>${r.name}</td><td>${r.gender}</td><td>${r.age}</td><td>${r.phone}</td>
                    <td>${r.department || '-'}</td><td>${r.building || '-'}-${r.room || '-'}-${r.bed || '-'}</td><td>${r.checkInDate || '-'}</td>
                    <td>
                        <button class="btn btn-info" onclick="editRecord(${r.id})">ç¼–è¾‘</button>
                        <button class="btn btn-warning" onclick="checkout(${r.id})">é€€å®¿</button>
                        <button class="btn btn-danger" onclick="deleteRecord(${r.id})">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="10" style="text-align:center;padding:30px;color:#999;">æš‚æ— åœ¨ä½äººå‘˜</td></tr>';
            updateBatchActions();
        }

        function updateDormFilterOptions() {
            const dormFilter = document.getElementById('dormFilter');
            const activeRecords = records.filter(r => !r.checkOutDate);
            const dormSet = new Set();
            activeRecords.forEach(r => { if (r.building && r.room) dormSet.add(`${r.building}-${r.room}`); });
            
            const dormList = Array.from(dormSet).sort((a, b) => {
                const [buildingA, roomA] = a.split('-');
                const [buildingB, roomB] = b.split('-');
                return buildingA !== buildingB ? buildingA.localeCompare(buildingB) : parseInt(roomA) - parseInt(roomB);
            });
            
            const currentValue = dormFilter.value;
            dormFilter.innerHTML = '<option value="">å…¨éƒ¨å®¿èˆ</option>';
            
            const buildingGroups = {};
            dormList.forEach(dorm => {
                const [building, room] = dorm.split('-');
                (buildingGroups[building] = buildingGroups[building] || []).push(room);
            });
            
            Object.keys(buildingGroups).sort().forEach(building => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = building;
                buildingGroups[building].forEach(room => {
                    const option = document.createElement('option');
                    option.value = `${building}-${room}`;
                    const count = activeRecords.filter(r => r.building === building && r.room === room).length;
                    option.textContent = `${room}å·æˆ¿ (${count}äºº)`;
                    optgroup.appendChild(option);
                });
                dormFilter.appendChild(optgroup);
            });
            
            if (dormList.includes(currentValue)) dormFilter.value = currentValue;
        }

        // é€€å®¿äººå‘˜åˆ—è¡¨ç›¸å…³
        function toggleSelectAllCheckout() {
            const selectAll = document.getElementById('selectAllCheckout').checked;
            const filtered = getFilteredRecords(false, 'searchCheckout');
            selectAll ? filtered.forEach(r => selectedCheckoutIds.add(r.id)) : selectedCheckoutIds.clear();
            updateBatchActionsCheckout();
            renderCheckoutTable();
        }

        function toggleSelectCheckout(id) {
            selectedCheckoutIds.has(id) ? selectedCheckoutIds.delete(id) : selectedCheckoutIds.add(id);
            updateBatchActionsCheckout();
            renderCheckoutTable();
        }

        function updateBatchActionsCheckout() {
            const count = selectedCheckoutIds.size;
            document.getElementById('selectedCountCheckout').textContent = count;
            document.getElementById('batchActionsCheckout').style.display = count > 0 ? 'flex' : 'none';
            const filtered = getFilteredRecords(false, 'searchCheckout');
            document.getElementById('selectAllCheckout').checked = filtered.length > 0 && filtered.every(r => selectedCheckoutIds.has(r.id));
        }

        function clearSelectionCheckout() {
            selectedCheckoutIds.clear();
            updateBatchActionsCheckout();
            renderCheckoutTable();
        }

        function batchDeleteCheckout() {
            if (selectedCheckoutIds.size === 0) return;
            if (confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedCheckoutIds.size} æ¡é€€å®¿è®°å½•å—?`)) {
                records = records.filter(r => !selectedCheckoutIds.has(r.id));
                localStorage.setItem('dormRecords', JSON.stringify(records));
                clearSelectionCheckout();
                alert('æ‰¹é‡åˆ é™¤æˆåŠŸ!');
            }
        }

        function filterCheckoutRecords() { renderCheckoutTable(); }

        function renderCheckoutTable() {
            const tbody = document.getElementById('checkoutTableBody');
            const filtered = getFilteredRecords(false, 'searchCheckout');
            tbody.innerHTML = filtered.map((r, i) => `
                <tr>
                    <td><div class="checkbox-wrapper"><input type="checkbox" ${selectedCheckoutIds.has(r.id) ? 'checked' : ''} onchange="toggleSelectCheckout(${r.id})"></div></td>
                    <td>${i + 1}</td><td>${r.name}</td><td>${r.gender}</td><td>${r.phone}</td><td>${r.department || '-'}</td>
                    <td>${r.building || '-'}-${r.room || '-'}-${r.bed || '-'}</td><td>${r.checkInDate || '-'}</td>
                    <td>${r.checkOutDate || '-'}</td><td>${r.resignDate || '-'}</td><td>${r.handover || '-'}</td>
                    <td>${r.checkOutReason || '-'}</td>
                    <td><button class="btn btn-danger" onclick="deleteCheckoutRecord(${r.id})">åˆ é™¤</button></td>
                </tr>
            `).join('') || '<tr><td colspan="13" style="text-align:center;padding:30px;color:#999;">æš‚æ— é€€å®¿äººå‘˜</td></tr>';
            updateBatchActionsCheckout();
        }

        function deleteCheckoutRecord(id) {
            if (confirm('ç¡®å®šåˆ é™¤è¯¥é€€å®¿è®°å½•å—?')) {
                records = records.filter(r => r.id !== id);
                localStorage.setItem('dormRecords', JSON.stringify(records));
                renderCheckoutTable();
                alert('åˆ é™¤æˆåŠŸ!');
            }
        }

        // èº«ä»½è¯éªŒè¯
        function validateIdCard() {
            const id = document.getElementById('idCard').value.toUpperCase();
            document.getElementById('idCard').value = id;
            const err = document.getElementById('idError');
            const suc = document.getElementById('idSuccess');
            err.classList.add('hidden');
            suc.classList.add('hidden');

            if (id.length !== 18) {
                if (id.length === 0) {
                    document.getElementById('gender').value = '';
                    document.getElementById('birthDate').value = '';
                    document.getElementById('age').value = '';
                }
                return;
            }

            if (!/^\d{17}[\dX]$/.test(id)) {
                err.textContent = 'èº«ä»½è¯å·æ ¼å¼é”™è¯¯';
                err.classList.remove('hidden');
                return;
            }

            const weights = [7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2];
            const codes = ['1','0','X','9','8','7','6','5','4','3','2'];
            let sum = 0;
            for (let i = 0; i < 17; i++) sum += parseInt(id[i]) * weights[i];
            if (id[17] !== codes[sum % 11]) {
                err.textContent = 'èº«ä»½è¯å·æ ¡éªŒç é”™è¯¯';
                err.classList.remove('hidden');
                return;
            }

            const gender = parseInt(id[16]) % 2 === 1 ? 'ç”·' : 'å¥³';
            const year = parseInt(id.substring(6, 10));
            const month = id.substring(10, 12);
            const day = id.substring(12, 14);
            const birthDate = `${year}-${month}-${day}`;
            const age = new Date().getFullYear() - year;
            
            document.getElementById('gender').value = gender;
            document.getElementById('birthDate').value = birthDate;
            document.getElementById('age').value = age;

            const historyRecords = records.filter(r => r.idCard === id && r.id !== editingId);
            const checkoutRecords = historyRecords.filter(r => r.checkOutDate);
            
            if (checkoutRecords.length > 0) {
                let historyText = `ã€ç¦»èŒå†å²ã€‘æ›¾ç¦»èŒ${checkoutRecords.length}æ¬¡ï¼š`;
                checkoutRecords.forEach((record, index) => {
                    const resignDate = record.resignDate || record.checkOutDate || 'æœªè®°å½•';
                    const checkoutReason = record.checkOutReason ? ` (åŸå› ï¼š${record.checkOutReason})` : '';
                    historyText += `\n  ${index + 1}. ç¦»èŒæ—¥æœŸï¼š${resignDate}${checkoutReason}`;
                });
                
                const currentNotes = document.getElementById('notes').value.trim();
                let userNotes = currentNotes;
                if (currentNotes.includes('ã€ç¦»èŒå†å²ã€‘')) {
                    const match = currentNotes.split('ã€ç¦»èŒå†å²ã€‘')[1]?.match(/\n\n(.+)/s);
                    userNotes = match ? match[1].trim() : '';
                }
                
                document.getElementById('notes').value = userNotes ? historyText + '\n\n' + userNotes : historyText;
            }

            const activeRecords = historyRecords.filter(r => !r.checkOutDate);
            if (activeRecords.length > 0) {
                err.textContent = 'è¯¥èº«ä»½è¯å·å·²ç™»è®°ï¼ˆå½“å‰åœ¨èŒï¼‰';
                err.classList.remove('hidden');
                return;
            }

            suc.textContent = checkoutRecords.length > 0 ? 
                `âœ“ éªŒè¯é€šè¿‡ï¼ˆæ£€æµ‹åˆ°${checkoutRecords.length}æ¬¡ç¦»èŒè®°å½•ï¼Œå·²è‡ªåŠ¨æ·»åŠ åˆ°å¤‡æ³¨ï¼‰` : 
                'âœ“ éªŒè¯é€šè¿‡';
            suc.classList.remove('hidden');
        }

        // è¡¨å•æäº¤
        function handleSubmit(e) {
            e.preventDefault();
            const data = {
                id: editingId || Date.now(),
                name: document.getElementById('name').value,
                idCard: document.getElementById('idCard').value,
                gender: document.getElementById('gender').value,
                birthDate: document.getElementById('birthDate').value,
                age: document.getElementById('age').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                ethnicity: document.getElementById('ethnicity').value,
                sourceUnit: document.getElementById('sourceUnit').value,
                department: document.getElementById('department').value,
                building: document.getElementById('building').value,
                room: document.getElementById('room').value,
                bed: document.getElementById('bed').value,
                checkInDate: document.getElementById('checkInDate').value,
                emergencyContact: document.getElementById('emergencyContact').value,
                emergencyPhone: document.getElementById('emergencyPhone').value,
                resignDate: document.getElementById('resignDate').value,
                handover: document.getElementById('handover').value,
                notes: document.getElementById('notes').value,
                recordTime: new Date().toLocaleString()
            };

            if (editingId) {
                records = records.map(r => r.id === editingId ? data : r);
                alert('ä¿®æ”¹æˆåŠŸ!');
            } else {
                records.push(data);
                alert('ä¿å­˜æˆåŠŸ!');
            }

            localStorage.setItem('dormRecords', JSON.stringify(records));
            resetForm();
        }

        function resetForm() {
            document.querySelector('form').reset();
            document.getElementById('gender').value = '';
            document.getElementById('birthDate').value = '';
            document.getElementById('age').value = '';
            document.getElementById('idError').classList.add('hidden');
            document.getElementById('idSuccess').classList.add('hidden');
            document.getElementById('cancelBtn').classList.add('hidden');
            document.getElementById('formTitle').textContent = 'æ–°å¢äººå‘˜ç™»è®°';
            editingId = null;
        }

        function editRecord(id) {
            const record = records.find(r => r.id === id);
            editingId = id;
            Object.keys(record).forEach(key => {
                const el = document.getElementById(key);
                if (el) el.value = record[key] || '';
            });
            
            if (record.building) {
                document.getElementById('building').value = record.building;
                updateRoomOptions();
                if (record.room) document.getElementById('room').value = record.room;
            }
            
            document.getElementById('formTitle').textContent = 'ç¼–è¾‘äººå‘˜ä¿¡æ¯';
            document.getElementById('cancelBtn').classList.remove('hidden');
            switchTab('register');
        }

        function updateRoomOptions() {
            const building = document.getElementById('building').value;
            const roomSelect = document.getElementById('room');
            roomSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æˆ¿é—´</option>';
            
            if (!building) {
                roomSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©æ¥¼æ ‹</option>';
                return;
            }
            
            const buildingRooms = rooms.filter(r => r.building === building).sort((a, b) => {
                return (parseInt(a.room) || 0) - (parseInt(b.room) || 0);
            });
            
            if (buildingRooms.length === 0) {
                roomSelect.innerHTML = '<option value="">è¯¥æ¥¼æ ‹æš‚æ— æˆ¿é—´é…ç½®</option>';
                return;
            }
            
            buildingRooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room.room;
                option.textContent = `${room.room}å·æˆ¿ (${room.beds}åºŠä½)`;
                roomSelect.appendChild(option);
            });
        }

        function cancelEdit() { resetForm(); }

        function deleteRecord(id) {
            if (confirm('ç¡®å®šåˆ é™¤è¯¥è®°å½•å—?åˆ é™¤åæ— æ³•æ¢å¤!')) {
                records = records.filter(r => r.id !== id);
                localStorage.setItem('dormRecords', JSON.stringify(records));
                renderTable();
                renderCheckoutTable();
                alert('åˆ é™¤æˆåŠŸ!');
            }
        }

        function checkout(id) {
            const reason = prompt('è¯·è¾“å…¥é€€å®¿åŸå› :');
            if (reason) {
                records = records.map(r => r.id === id ? {...r, checkOutDate: new Date().toLocaleDateString(), checkOutReason: reason} : r);
                localStorage.setItem('dormRecords', JSON.stringify(records));
                renderTable();
                alert('é€€å®¿ç™»è®°æˆåŠŸ!');
            }
        }

        // ç»Ÿè®¡ç›¸å…³
        function renderStats() {
            const active = records.filter(r => !r.checkOutDate);
            const buildings = [...new Set(records.map(r => r.building).filter(Boolean))];
            
            const totalRooms = rooms.length;
            const totalBeds = rooms.reduce((sum, room) => sum + (parseInt(room.beds) || 0), 0);
            
            let totalBedsNormal = 0, totalBedsManager = 0, occupiedBedsNormal = 0, occupiedBedsManager = 0;
            
            rooms.forEach(room => {
                const beds = parseInt(room.beds) || 0;
                isManagerRoom(room) ? (totalBedsManager += beds) : (totalBedsNormal += beds);
            });
            
            active.forEach(r => {
                if (!r.building || !r.room || !r.bed) return;
                const room = rooms.find(rm => rm.building === r.building && rm.room === r.room);
                if (room && isManagerRoom(room)) occupiedBedsManager++;
                else occupiedBedsNormal++;
            });
            
            const occupiedBedsCount = occupiedBedsNormal + occupiedBedsManager;
            const availableBedsNormal = totalBedsNormal - occupiedBedsNormal;
            const availableBedsManager = totalBedsManager - occupiedBedsManager;
            const availableBedsCount = availableBedsNormal + availableBedsManager;
            
            document.getElementById('total').textContent = records.length;
            document.getElementById('active').textContent = active.length;
            document.getElementById('checkout').textContent = records.length - active.length;
            document.getElementById('buildings').textContent = buildings.length;
            document.getElementById('totalRooms').textContent = totalRooms;
            document.getElementById('totalBeds').textContent = totalBeds;
            document.getElementById('occupiedBeds').textContent = occupiedBedsCount;
            document.getElementById('availableBeds').textContent = availableBedsCount;
            document.getElementById('occupiedBedsNormal').textContent = occupiedBedsNormal;
            document.getElementById('occupiedBedsManager').textContent = occupiedBedsManager;
            document.getElementById('availableBedsNormal').textContent = availableBedsNormal;
            document.getElementById('availableBedsManager').textContent = availableBedsManager;
        }

        function renderRoomTypeStats() {
            const container = document.getElementById('roomTypeStatsContainer');
            const activeRecords = records.filter(r => !r.checkOutDate);
            const roomTypeStats = {};
            const managerRoomTypeStats = {};
            
            rooms.forEach(room => {
                const beds = parseInt(room.beds) || 0;
                const typeName = getRoomTypeName(beds);
                const targetStats = isManagerRoom(room) ? managerRoomTypeStats : roomTypeStats;
                
                if (!targetStats[typeName]) {
                    targetStats[typeName] = { count: 0, totalBeds: 0, occupiedBeds: 0, fullyOccupied: 0, beds: beds };
                }
                targetStats[typeName].count++;
                targetStats[typeName].totalBeds += beds;
            });
            
            const roomOccupancy = {};
            activeRecords.forEach(r => {
                if (!r.building || !r.room || !r.bed) return;
                const key = `${r.building}-${r.room}`;
                roomOccupancy[key] = (roomOccupancy[key] || 0) + 1;
            });
            
            rooms.forEach(room => {
                const key = `${room.building}-${room.room}`;
                const occupied = roomOccupancy[key] || 0;
                const beds = parseInt(room.beds) || 0;
                const typeName = getRoomTypeName(beds);
                const targetStats = isManagerRoom(room) ? managerRoomTypeStats : roomTypeStats;
                
                if (targetStats[typeName]) {
                    targetStats[typeName].occupiedBeds += occupied;
                    if (occupied >= beds && beds > 0) targetStats[typeName].fullyOccupied++;
                }
            });
            
            const renderTypeStats = (stats, title, color) => {
                const sortedTypes = Object.keys(stats).sort((a, b) => stats[a].beds - stats[b].beds);
                if (sortedTypes.length === 0) return '';
                
                let html = `<h3 style="color:#555;font-size:16px;margin:${title === 'æ™®é€šå®¿èˆ' ? 20 : 30}px 0 15px 0;">${title}</h3><div class="bed-stats-grid">`;
                sortedTypes.forEach(typeName => {
                    const stat = stats[typeName];
                    const availableBeds = stat.totalBeds - stat.occupiedBeds;
                    const percentage = stat.totalBeds > 0 ? (stat.occupiedBeds / stat.totalBeds * 100).toFixed(0) : 0;
                    const isManager = title === 'ç®¡ç†äººå‘˜å®¿èˆ';
                    
                    html += `
                        <div class="bed-stat-item" style="border-left-color: ${color};">
                            <div class="bed-stat-header">${typeName}${isManager ? ' <span style="font-size:12px;color:#9C27B0;">(ç®¡ç†)</span>' : ''}</div>
                            <div class="bed-stat-details"><span class="bed-stat-label">æˆ¿é—´æ•°:</span><span class="bed-stat-value">${stat.count} é—´</span></div>
                            <div class="bed-stat-details"><span class="bed-stat-label">æ€»åºŠä½:</span><span class="bed-stat-value">${stat.totalBeds} å¼ </span></div>
                            <div class="bed-stat-details"><span class="bed-stat-label">å·²å…¥ä½:</span><span class="bed-stat-value occupied">${stat.occupiedBeds} å¼ </span></div>
                            <div class="bed-stat-details"><span class="bed-stat-label">ç©ºåºŠä½:</span><span class="bed-stat-value available">${availableBeds} å¼ </span></div>
                            <div class="bed-stat-details"><span class="bed-stat-label">ä½æ»¡æˆ¿é—´:</span><span class="bed-stat-value" style="color:${color};">${stat.fullyOccupied} é—´</span></div>
                            <div class="progress-bar"><div class="progress-fill" style="width: ${percentage}%;${isManager ? 'background: linear-gradient(90deg, #9C27B0, #E1BEE7);' : ''}"></div></div>
                            <div style="text-align:right;font-size:12px;color:#666;margin-top:5px;">åºŠä½ä½¿ç”¨ç‡: ${percentage}%</div>
                        </div>`;
                });
                return html + '</div>';
            };
            
            let html = renderTypeStats(roomTypeStats, 'æ™®é€šå®¿èˆ', '#FF9800') + renderTypeStats(managerRoomTypeStats, 'ç®¡ç†äººå‘˜å®¿èˆ', '#9C27B0');
            container.innerHTML = html || '<p style="text-align:center;color:#999;padding:30px;">æš‚æ— æˆ¿å‹æ•°æ®,è¯·å…ˆåœ¨"æˆ¿é—´ç®¡ç†"ä¸­æ·»åŠ æˆ¿é—´é…ç½®</p>';
        }

        function renderBedStats() {
            const container = document.getElementById('bedStatsContainer');
            const activeRecords = records.filter(r => !r.checkOutDate);
            const buildingStats = {};
            
            rooms.forEach(room => {
                if (!buildingStats[room.building]) buildingStats[room.building] = {};
                buildingStats[room.building][room.room] = {
                    totalBeds: parseInt(room.beds) || 0,
                    occupiedBeds: 0,
                    notes: room.notes || ''
                };
            });
            
            activeRecords.forEach(r => {
                if (!r.building || !r.room || !r.bed) return;
                if (!buildingStats[r.building]) buildingStats[r.building] = {};
                if (!buildingStats[r.building][r.room]) {
                    buildingStats[r.building][r.room] = { totalBeds: 0, occupiedBeds: 0, notes: 'æœªé…ç½®' };
                }
                buildingStats[r.building][r.room].occupiedBeds++;
                const currentOccupied = buildingStats[r.building][r.room].occupiedBeds;
                const currentTotal = buildingStats[r.building][r.room].totalBeds;
                if (currentOccupied > currentTotal) buildingStats[r.building][r.room].totalBeds = currentOccupied;
            });
            
            let html = '';
            Object.keys(buildingStats).sort().forEach(building => {
                const roomsData = buildingStats[building];
                let buildingTotal = 0, buildingOccupied = 0, roomsHtml = '';
                
                Object.keys(roomsData).sort((a, b) => (parseInt(a) || 0) - (parseInt(b) || 0)).forEach(room => {
                    const roomData = roomsData[room];
                    const total = roomData.totalBeds;
                    const occupied = roomData.occupiedBeds;
                    const available = total - occupied;
                    const percentage = total > 0 ? (occupied / total * 100).toFixed(0) : 0;
                    buildingTotal += total;
                    buildingOccupied += occupied;
                    
                    roomsHtml += `
                        <div class="bed-stat-item">
                            <div class="bed-stat-header">${building} - ${room}å·æˆ¿</div>
                            ${roomData.notes ? `<div style="font-size:12px;color:#999;margin-bottom:8px;">${roomData.notes}</div>` : ''}
                            <div class="bed-stat-details"><span class="bed-stat-label">æ€»åºŠä½:</span><span class="bed-stat-value">${total} å¼ </span></div>
                            <div class="bed-stat-details"><span class="bed-stat-label">å·²å…¥ä½:</span><span class="bed-stat-value occupied">${occupied} å¼ </span></div>
                            <div class="bed-stat-details"><span class="bed-stat-label">å‰©ä½™:</span><span class="bed-stat-value available">${available} å¼ </span></div>
                            <div class="progress-bar"><div class="progress-fill" style="width: ${percentage}%"></div></div>
                            <div style="text-align:right;font-size:12px;color:#666;margin-top:5px;">å…¥ä½ç‡: ${percentage}%</div>
                        </div>`;
                });
                
                const buildingAvailable = buildingTotal - buildingOccupied;
                const buildingPercentage = buildingTotal > 0 ? (buildingOccupied / buildingTotal * 100).toFixed(0) : 0;
                
                html += `
                    <div class="building-section">
                        <h3>${building} - æ±‡æ€»</h3>
                        <div style="background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:15px;">
                            <div style="display:flex;justify-content:space-around;text-align:center;">
                                <div><div style="font-size:24px;font-weight:bold;color:#2196F3;">${buildingTotal}</div><div style="color:#666;font-size:14px;">æ€»åºŠä½</div></div>
                                <div><div style="font-size:24px;font-weight:bold;color:#f44336;">${buildingOccupied}</div><div style="color:#666;font-size:14px;">å·²å…¥ä½</div></div>
                                <div><div style="font-size:24px;font-weight:bold;color:#4CAF50;">${buildingAvailable}</div><div style="color:#666;font-size:14px;">å‰©ä½™</div></div>
                                <div><div style="font-size:24px;font-weight:bold;color:#FF9800;">${buildingPercentage}%</div><div style="color:#666;font-size:14px;">å…¥ä½ç‡</div></div>
                            </div>
                        </div>
                        <div class="bed-stats-grid">${roomsHtml}</div>
                    </div>`;
            });
            
            container.innerHTML = html || '<p style="text-align:center;color:#999;padding:30px;">æš‚æ— åºŠä½æ•°æ®,è¯·å…ˆåœ¨"æˆ¿é—´ç®¡ç†"ä¸­æ·»åŠ æˆ¿é—´é…ç½®</p>';
        }

        // Excelå¯¼å‡ºå¯¼å…¥
        function exportExcel() {
            if (!records.length) return alert('æš‚æ— æ•°æ®');
            const wb = XLSX.utils.book_new();
            
            const activeRecords = records.filter(r => !r.checkOutDate);
            if (activeRecords.length > 0) {
                const ws1 = XLSX.utils.json_to_sheet(activeRecords.map((r, i) => ({
                    åºå·: i + 1, å§“å: r.name, èº«ä»½è¯å·: r.idCard, æ€§åˆ«: r.gender, å¹´é¾„: r.age, å‡ºç”Ÿæ—¥æœŸ: r.birthDate,
                    ç”µè¯: r.phone, åœ°å€: r.address, æ°‘æ—: r.ethnicity, æ¥æºå•ä½: r.sourceUnit, éƒ¨é—¨: r.department,
                    æ¥¼æ ‹: r.building, æˆ¿é—´å·: r.room, åºŠä½å·: r.bed, å…¥ä½æ—¥æœŸ: r.checkInDate,
                    ç´§æ€¥è”ç³»äºº: r.emergencyContact, ç´§æ€¥è”ç³»ç”µè¯: r.emergencyPhone, å¤‡æ³¨: r.notes
                })));
                XLSX.utils.book_append_sheet(wb, ws1, 'åœ¨ä½äººå‘˜');
            }
            
            const checkoutRecords = records.filter(r => r.checkOutDate);
            if (checkoutRecords.length > 0) {
                const ws2 = XLSX.utils.json_to_sheet(checkoutRecords.map((r, i) => ({
                    åºå·: i + 1, å§“å: r.name, èº«ä»½è¯å·: r.idCard, æ€§åˆ«: r.gender, å¹´é¾„: r.age, ç”µè¯: r.phone,
                    éƒ¨é—¨: r.department, æ¥¼æ ‹: r.building, æˆ¿é—´å·: r.room, åºŠä½å·: r.bed, å…¥ä½æ—¥æœŸ: r.checkInDate,
                    é€€å®¿æ—¥æœŸ: r.checkOutDate, ç¦»èŒæ—¥æœŸ: r.resignDate, äº¤å‰²æ‰‹ç»­: r.handover, é€€å®¿åŸå› : r.checkOutReason
                })));
                XLSX.utils.book_append_sheet(wb, ws2, 'é€€å®¿äººå‘˜');
            }
            
            XLSX.writeFile(wb, 'å®¿èˆäººå‘˜ä¿¡æ¯_' + new Date().toLocaleDateString('zh-CN').replace(/\//g, '-') + '.xlsx');
        }

        function showImport() { document.getElementById('importModal').classList.add('active'); }
        function closeImport() { document.getElementById('importModal').classList.remove('active'); }

        function handleImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, {type: 'array'});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws, {raw: false, defval: ''});
                    
                    if (json.length === 0) return alert('Excelæ–‡ä»¶ä¸ºç©º!');
                    
                    let success = 0, error = 0, errorDetails = [];
                    
                    const formatDate = (dateValue) => {
                        if (!dateValue) return dateValue;
                        let date;
                        if (typeof dateValue === 'string') {
                            if (/^\d{5}$/.test(dateValue)) {
                                date = new Date((parseInt(dateValue) - 25569) * 86400 * 1000);
                            } else if (/^\d{4}[-\/]\d{1,2}[-\/]\d{1,2}$/.test(dateValue)) {
                                date = new Date(dateValue.replace(/\//g, '-'));
                            } else if (/^\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥?$/.test(dateValue)) {
                                const matches = dateValue.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})/);
                                if (matches) date = new Date(matches[1], matches[2] - 1, matches[3]);
                            } else {
                                date = new Date(dateValue);
                            }
                        } else if (dateValue instanceof Date) {
                            date = dateValue;
                        }
                        
                        if (!date || isNaN(date.getTime())) return dateValue;
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    };
                    
                    json.forEach((row, index) => {
                        const getName = (names) => {
                            for (let name of names) {
                                const value = row[name];
                                if (value !== undefined && value !== null && value !== '') return value;
                            }
                            return '';
                        };
                        
                        let idCard = getName(['èº«ä»½è¯å·', 'èº«ä»½è¯å·ç ', 'èº«ä»½è¯', 'ID', 'idCard', 'è¯ä»¶å·', 'è¯ä»¶å·ç ']);
                        if (idCard) {
                            idCard = String(idCard).replace(/[\s\n\r\t]/g, '').toUpperCase();
                            if (idCard.includes('E+') || idCard.includes('e+')) {
                                try {
                                    idCard = parseFloat(idCard).toFixed(0);
                                } catch (err) {
                                    idCard = '';
                                }
                            }
                        }
                        
                        if (idCard && records.some(r => r.idCard === idCard)) {
                            error++;
                            if (errorDetails.length < 5) errorDetails.push(`ç¬¬${index + 2}è¡Œ:èº«ä»½è¯å·å·²å­˜åœ¨ [${idCard}]`);
                            return;
                        }
                        
                        let gender = getName(['æ€§åˆ«', 'gender', 'ç”·å¥³']) || '';
                        let age = getName(['å¹´é¾„', 'age'])?.toString() || '';
                        
                        if (idCard && idCard.length === 18 && /^\d{17}[\dX]$/.test(idCard)) {
                            const genderCode = parseInt(idCard.charAt(16));
                            gender = genderCode % 2 === 1 ? 'ç”·' : 'å¥³';
                            const year = parseInt(idCard.substring(6, 10));
                            age = (new Date().getFullYear() - year).toString();
                        }
                        
                        let phone = getName(['ç”µè¯', 'è”ç³»ç”µè¯', 'æ‰‹æœºå·', 'phone', 'æ‰‹æœº', 'è”ç³»æ–¹å¼']);
                        if (phone) phone = String(phone).replace(/[\s\n\r\t]/g, '');
                        
                        records.push({
                            id: Date.now() + Math.random(),
                            name: getName(['å§“å', 'å‘˜å·¥å§“å', 'name', 'åå­—']) || '',
                            idCard: idCard || '',
                            gender: gender,
                            age: age,
                            phone: phone || '',
                            address: getName(['åœ°å€', 'å®¶åº­åœ°å€', 'address', 'ä½å€']) || '',
                            ethnicity: getName(['æ°‘æ—', 'ethnicity']) || '',
                            sourceUnit: getName(['æ¥æºå•ä½', 'åŸå•ä½', 'sourceUnit', 'å•ä½']) || '',
                            department: getName(['éƒ¨é—¨', 'å…¥èŒéƒ¨é—¨', 'æ‰€å±éƒ¨é—¨', 'department']) || '',
                            building: getName(['æ¥¼æ ‹', 'å®¿èˆæ¥¼æ ‹', 'æ¥¼å±‚', 'building', 'å®¿èˆ']) || '',
                            room: getName(['æˆ¿é—´', 'æˆ¿é—´å·', 'room', 'æˆ¿å·'])?.toString() || '',
                            bed: getName(['åºŠä½', 'åºŠä½å·', 'bed', 'åºŠå·'])?.toString() || '',
                            checkInDate: formatDate(getName(['å…¥ä½æ—¥æœŸ', 'å…¥ä½æ—¶é—´', 'checkInDate', 'å…¥ä½'])),
                            emergencyContact: getName(['ç´§æ€¥è”ç³»äºº', 'è”ç³»äºº', 'emergencyContact', 'å®¶å±']) || '',
                            emergencyPhone: getName(['ç´§æ€¥è”ç³»ç”µè¯', 'ç´§æ€¥ç”µè¯', 'emergencyPhone', 'å®¶å±ç”µè¯'])?.toString() || '',
                            resignDate: formatDate(getName(['ç¦»èŒæ—¥æœŸ', 'ç¦»èŒæ—¶é—´', 'resignDate', 'ç¦»èŒ'])),
                            handover: getName(['äº¤å‰²æ‰‹ç»­', 'äº¤æ¥çŠ¶æ€', 'handover', 'äº¤æ¥']) || '',
                            notes: getName(['å¤‡æ³¨', 'è¯´æ˜', 'notes', 'å¤‡æ³¨è¯´æ˜']) || '',
                            recordTime: new Date().toLocaleString()
                        });
                        success++;
                    });
                    
                    localStorage.setItem('dormRecords', JSON.stringify(records));
                    renderTable();
                    closeImport();
                    let msg = `å¯¼å…¥å®Œæˆ!\næˆåŠŸ: ${success} æ¡\nå¤±è´¥: ${error} æ¡`;
                    if (errorDetails.length > 0) msg += '\n\nå¤±è´¥è¯¦æƒ…:\n' + errorDetails.join('\n');
                    alert(msg);
                } catch (err) {
                    alert('æ–‡ä»¶è§£æå¤±è´¥: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // æˆ¿é—´ç®¡ç†
        function renderRooms() {
            const container = document.getElementById('roomsContainer');
            if (rooms.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#999;padding:30px;">æš‚æ— æˆ¿é—´é…ç½®,è¯·ç‚¹å‡»"æ·»åŠ æˆ¿é—´"æŒ‰é’®å¼€å§‹é…ç½®</p>';
                return;
            }
            
            const buildingGroups = {};
            rooms.forEach(r => (buildingGroups[r.building] = buildingGroups[r.building] || []).push(r));
            
            let html = '';
            Object.keys(buildingGroups).sort().forEach(building => {
                const buildingRooms = buildingGroups[building];
                const totalBeds = buildingRooms.reduce((sum, r) => sum + (parseInt(r.beds) || 0), 0);
                
                html += `
                    <div class="building-section">
                        <h3>${building} (${buildingRooms.length} ä¸ªæˆ¿é—´, ${totalBeds} å¼ åºŠä½)</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:50px;"><div class="checkbox-wrapper"><input type="checkbox" class="select-all-rooms" onchange="toggleSelectAllRooms('${building}')"></div></th>
                                    <th>åºå·</th><th>æˆ¿é—´å·</th><th>åºŠä½æ•°</th><th>å¤‡æ³¨</th><th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${buildingRooms.sort((a, b) => (parseInt(a.room) || 0) - (parseInt(b.room) || 0)).map((room, i) => `
                                    <tr>
                                        <td><div class="checkbox-wrapper"><input type="checkbox" class="room-checkbox" data-id="${room.id}" onchange="updateRoomSelection()"></div></td>
                                        <td>${i + 1}</td><td>${room.room}</td><td>${room.beds}</td><td>${room.notes || '-'}</td>
                                        <td>
                                            <button class="btn btn-info" onclick="editRoom(${room.id})">ç¼–è¾‘</button>
                                            <button class="btn btn-danger" onclick="deleteRoom(${room.id})">åˆ é™¤</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>`;
            });
            container.innerHTML = html;
        }

        function showAddRoom() {
            editingRoomId = null;
            document.getElementById('roomModalTitle').textContent = 'æ·»åŠ æˆ¿é—´';
            document.getElementById('roomBuilding').value = '';
            document.getElementById('roomNumber').value = '';
            document.getElementById('roomBeds').value = '';
            document.getElementById('roomNotes').value = '';
            document.getElementById('roomModal').classList.add('active');
        }

        function editRoom(id) {
            const room = rooms.find(r => r.id === id);
            if (!room) return;
            editingRoomId = id;
            document.getElementById('roomModalTitle').textContent = 'ç¼–è¾‘æˆ¿é—´';
            document.getElementById('roomBuilding').value = room.building;
            document.getElementById('roomNumber').value = room.room;
            document.getElementById('roomBeds').value = room.beds;
            document.getElementById('roomNotes').value = room.notes || '';
            document.getElementById('roomModal').classList.add('active');
        }

        function saveRoom(e) {
            e.preventDefault();
            const data = {
                id: editingRoomId || Date.now(),
                building: document.getElementById('roomBuilding').value,
                room: document.getElementById('roomNumber').value,
                beds: parseInt(document.getElementById('roomBeds').value) || 0,
                notes: document.getElementById('roomNotes').value
            };
            
            const isDuplicate = rooms.some(r => r.building === data.building && r.room === data.room && r.id !== editingRoomId);
            if (isDuplicate) return alert('è¯¥æ¥¼æ ‹çš„æˆ¿é—´å·å·²å­˜åœ¨!');
            
            if (editingRoomId) {
                rooms = rooms.map(r => r.id === editingRoomId ? data : r);
                alert('ä¿®æ”¹æˆåŠŸ!');
            } else {
                rooms.push(data);
                alert('æ·»åŠ æˆåŠŸ!');
            }
            
            localStorage.setItem('dormRooms', JSON.stringify(rooms));
            closeRoomModal();
            renderRooms();
        }

        function closeRoomModal() { document.getElementById('roomModal').classList.remove('active'); }

        function deleteRoom(id) {
            if (confirm('ç¡®å®šåˆ é™¤è¯¥æˆ¿é—´é…ç½®å—?')) {
                rooms = rooms.filter(r => r.id !== id);
                localStorage.setItem('dormRooms', JSON.stringify(rooms));
                renderRooms();
                alert('åˆ é™¤æˆåŠŸ!');
            }
        }

        function exportRoomsExcel() {
            if (rooms.length === 0) return alert('æš‚æ— æˆ¿é—´é…ç½®æ•°æ®');
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(rooms.map((r, i) => ({
                åºå·: i + 1, æ¥¼æ ‹: r.building, æˆ¿é—´å·: r.room, åºŠä½æ•°: r.beds, å¤‡æ³¨: r.notes || ''
            })));
            XLSX.utils.book_append_sheet(wb, ws, 'æˆ¿é—´é…ç½®');
            XLSX.writeFile(wb, 'æˆ¿é—´é…ç½®_' + new Date().toLocaleDateString('zh-CN').replace(/\//g, '-') + '.xlsx');
        }

        function importRoomsExcel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const wb = XLSX.read(data, {type: 'array'});
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(ws, {raw: false, defval: ''});
                        
                        if (json.length === 0) return alert('Excelæ–‡ä»¶ä¸ºç©º!');
                        
                        let success = 0, error = 0;
                        json.forEach((row, index) => {
                            const building = row['æ¥¼æ ‹'] || row['building'] || '';
                            const room = row['æˆ¿é—´å·'] || row['æˆ¿é—´'] || row['room'] || '';
                            const beds = parseInt(row['åºŠä½æ•°'] || row['åºŠä½'] || row['beds']) || 0;
                            const notes = row['å¤‡æ³¨'] || row['notes'] || '';
                            
                            if (!building || !room || beds <= 0) {
                                error++;
                                return;
                            }
                            
                            if (rooms.find(r => r.building === building && r.room === room)) {
                                error++;
                                return;
                            }
                            
                            rooms.push({ id: Date.now() + Math.random(), building, room, beds, notes });
                            success++;
                        });
                        
                        localStorage.setItem('dormRooms', JSON.stringify(rooms));
                        renderRooms();
                        alert(`å¯¼å…¥å®Œæˆ!\næˆåŠŸ: ${success} æ¡\nå¤±è´¥: ${error} æ¡`);
                    } catch (err) {
                        alert('æ–‡ä»¶è§£æå¤±è´¥: ' + err.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            };
            input.click();
        }

        function updateRoomSelection() {
            const checkboxes = document.querySelectorAll('.room-checkbox:checked');
            const count = checkboxes.length;
            
            if (count > 0) {
                document.getElementById('batchActionsRooms').style.display = 'flex';
                document.getElementById('selectedCountRooms').textContent = count;
            } else {
                document.getElementById('batchActionsRooms').style.display = 'none';
            }
            
            document.querySelectorAll('.select-all-rooms').forEach(selectAll => {
                const building = selectAll.parentElement.parentElement.parentElement.parentElement.querySelector('h3').textContent.split(' ')[0];
                const buildingCheckboxes = Array.from(document.querySelectorAll('.room-checkbox')).filter(cb => {
                    const table = cb.closest('table');
                    const buildingHeader = table.previousElementSibling;
                    return buildingHeader && buildingHeader.textContent.includes(building);
                });
                const buildingChecked = buildingCheckboxes.filter(cb => cb.checked);
                selectAll.checked = buildingCheckboxes.length > 0 && buildingCheckboxes.length === buildingChecked.length;
                selectAll.indeterminate = buildingChecked.length > 0 && buildingChecked.length < buildingCheckboxes.length;
            });
        }

        function toggleSelectAllRooms(building) {
            const buildingSections = document.querySelectorAll('.building-section');
            buildingSections.forEach(section => {
                const header = section.querySelector('h3');
                if (header && header.textContent.includes(building)) {
                    const selectAll = section.querySelector('.select-all-rooms');
                    const checkboxes = section.querySelectorAll('.room-checkbox');
                    checkboxes.forEach(cb => cb.checked = selectAll.checked);
                }
            });
            updateRoomSelection();
        }

        function clearSelectionRooms() {
            document.querySelectorAll('.room-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.select-all-rooms').forEach(cb => cb.checked = false);
            updateRoomSelection();
        }

        function batchDeleteRooms() {
            const checkboxes = document.querySelectorAll('.room-checkbox:checked');
            if (checkboxes.length === 0) return alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æˆ¿é—´');
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${checkboxes.length} ä¸ªæˆ¿é—´å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
            
            const idsToDelete = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));
            rooms = rooms.filter(r => !idsToDelete.includes(r.id));
            localStorage.setItem('dormRooms', JSON.stringify(rooms));
            renderRooms();
            updateRoomSelection();
            alert(`æˆåŠŸåˆ é™¤ ${idsToDelete.length} ä¸ªæˆ¿é—´`);
        }
    </script>
</body>
</html>
