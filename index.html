<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¿èˆä½å®¿äººå‘˜ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .card { background: white; border-radius: 10px; padding: 30px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow-x: auto; }
        h1 { color: #333; font-size: 28px; margin-bottom: 20px; text-align: center; }
        h2 { color: #333; font-size: 22px; margin-bottom: 15px; }
        h3 { color: #555; font-size: 18px; margin: 20px 0 10px 0; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; margin: 5px; transition: all 0.3s; white-space: nowrap; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-info { background: #2196F3; color: white; }
        .btn-warning { background: #FF9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .tab { flex: 1; padding: 15px; background: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s; white-space: nowrap; min-width: 100px; }
        .tab.active { background: #2196F3; color: white; }
        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; width: 100%; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #2196F3; outline: none; }
        .error { color: red; font-size: 12px; margin-top: 5px; }
        .success { color: green; font-size: 12px; margin-top: 5px; }
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f5f5f5; font-weight: bold; position: sticky; top: 0; z-index: 10; }
        tr:hover { background: #f9f9f9; }
        .hidden { display: none !important; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 12px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 28px; font-weight: bold; margin: 5px 0; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; padding: 10px; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .checkbox-wrapper { display: flex; align-items: center; justify-content: center; }
        .checkbox-wrapper input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .batch-actions { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        .selected-count { background: #fff3cd; padding: 8px 15px; border-radius: 6px; font-weight: bold; color: #856404; font-size: 14px; }
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .bed-stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px; }
        .bed-stat-item { background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3; }
        .bed-stat-header { font-weight: bold; font-size: 16px; margin-bottom: 10px; color: #333; }
        .bed-stat-details { display: flex; justify-content: space-between; margin-top: 8px; font-size: 14px; }
        .bed-stat-label { color: #666; }
        .bed-stat-value { font-weight: bold; }
        .occupied { color: #f44336; }
        .available { color: #4CAF50; }
        .progress-bar { width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4CAF50, #2196F3); transition: width 0.3s; }
        .building-section { margin-bottom: 30px; }
        
        /* å¹³é¢å›¾æ ·å¼ */
        .floorplan-building { margin-bottom: 40px; }
        .floorplan-header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 15px 20px; 
            border-radius: 8px 8px 0 0; 
            font-size: 18px; 
            font-weight: bold; 
        }
        .floorplan-rooms { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            gap: 15px; 
            padding: 20px; 
            background: #f5f5f5; 
            border-radius: 0 0 8px 8px; 
        }
        .room-card { 
            background: white; 
            border-radius: 8px; 
            padding: 15px; 
            cursor: pointer; 
            transition: all 0.3s; 
            border: 2px solid #e0e0e0; 
            position: relative;
        }
        .room-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 6px 12px rgba(0,0,0,0.15); 
            border-color: #2196F3; 
        }
        .room-card.full { border-color: #f44336; background: #ffebee; }
        .room-card.empty { border-color: #4CAF50; background: #e8f5e9; }
        .room-card.partial { border-color: #FF9800; background: #fff3e0; }
        .room-number { 
            font-size: 20px; 
            font-weight: bold; 
            color: #333; 
            margin-bottom: 10px; 
        }
        .room-status { 
            font-size: 14px; 
            color: #666; 
            margin-bottom: 8px; 
        }
        .room-beds { 
            font-size: 12px; 
            color: #999; 
        }
        .room-badge { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 11px; 
            font-weight: bold; 
            color: white; 
        }
        .room-badge.full { background: #f44336; }
        .room-badge.empty { background: #4CAF50; }
        .room-badge.partial { background: #FF9800; }
        
        /* æˆ¿é—´è¯¦æƒ…æ¨¡æ€æ¡†æ ·å¼ */
        .room-detail-modal .modal-content { max-width: 700px; }
        .resident-list { margin-top: 15px; }
        .resident-item { 
            background: #f9f9f9; 
            padding: 12px; 
            margin-bottom: 10px; 
            border-radius: 6px; 
            border-left: 4px solid #2196F3; 
        }
        .resident-name { 
            font-weight: bold; 
            font-size: 16px; 
            color: #333; 
            margin-bottom: 5px; 
        }
        .resident-info { 
            font-size: 13px; 
            color: #666; 
            display: flex; 
            gap: 15px; 
            flex-wrap: wrap; 
        }
        .bed-visual { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); 
            gap: 10px; 
            margin: 15px 0; 
        }
        .bed-item { 
            padding: 12px; 
            text-align: center; 
            border-radius: 6px; 
            font-size: 13px; 
            font-weight: bold; 
            border: 2px solid #ddd;
        }
        .bed-item.occupied { 
            background: #ffebee; 
            border-color: #f44336; 
            color: #c62828; 
        }
        .bed-item.empty { 
            background: #e8f5e9; 
            border-color: #4CAF50; 
            color: #2e7d32; 
        }
        
        /* ç™»å½•ç•Œé¢æ ·å¼ */
        .login-container { max-width: 450px; margin: 80px auto; padding: 0 20px; }
        .login-card { background: white; padding: 40px 35px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        .login-title { text-align: center; color: #333; margin-bottom: 30px; font-size: 24px; }
        .login-form { display: flex; flex-direction: column; gap: 20px; }
        .login-form input { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .login-form button { padding: 12px; background: #2196F3; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .login-form button:hover { background: #1976D2; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(33,150,243,0.3); }
        
        /* ç”¨æˆ·ä¿¡æ¯æ  */
        .user-info { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 8px; margin-bottom: 20px; }
        .user-name { font-weight: bold; color: #333; }
        .user-role { background: #4CAF50; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px; margin-left: 10px; }
        .user-role.viewer { background: #FF9800; }
        .sync-status { display: flex; align-items: center; gap: 10px; }
        .sync-indicator { width: 10px; height: 10px; border-radius: 50%; background: #4CAF50; }
        .sync-indicator.syncing { background: #FF9800; animation: pulse 1s infinite; }
        .sync-indicator.error { background: #f44336; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .card { padding: 15px; }
            h1 { font-size: 20px; margin-bottom: 15px; }
            h2 { font-size: 18px; margin-bottom: 10px; }
            h3 { font-size: 16px; margin: 15px 0 8px 0; }
            .tabs { gap: 5px; padding-bottom: 5px; }
            .tab { padding: 10px 8px; font-size: 12px; min-width: 70px; }
            .form-grid { grid-template-columns: 1fr; gap: 10px; }
            .stats { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .stat-card { padding: 12px; }
            .stat-card > div:first-child { font-size: 12px; }
            .stat-value { font-size: 24px; }
            .btn { padding: 8px 12px; font-size: 12px; margin: 3px; }
            .toolbar { flex-direction: column; align-items: stretch; }
            .toolbar > * { width: 100%; margin: 5px 0; }
            .batch-actions { justify-content: flex-start; }
            .bed-stats-grid { grid-template-columns: 1fr; }
            table { min-width: 600px; font-size: 12px; }
            th, td { padding: 6px 4px; font-size: 12px; }
            .modal-content { padding: 20px; width: 95%; }
            .selected-count { font-size: 12px; padding: 6px 10px; }
        }
        
        @media (max-width: 480px) {
            body { padding: 5px; }
            .card { padding: 10px; border-radius: 8px; }
            h1 { font-size: 18px; margin-bottom: 10px; }
            h2 { font-size: 16px; margin-bottom: 8px; }
            h3 { font-size: 14px; margin: 10px 0 6px 0; }
            .tab { font-size: 11px; padding: 8px 5px; min-width: 60px; }
            .stat-card { padding: 10px; }
            .stat-card > div:first-child { font-size: 11px; }
            .stat-value { font-size: 20px; }
            .btn { padding: 6px 10px; font-size: 11px; margin: 2px; }
            table { min-width: 500px; font-size: 11px; }
            th, td { padding: 5px 3px; font-size: 11px; }
            .form-group label { font-size: 12px; }
            .form-group input, .form-group select, .form-group textarea { font-size: 12px; padding: 8px; }
            .bed-stat-header { font-size: 14px; }
            .bed-stat-details { font-size: 12px; }
        }
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <!-- å…¬å¸æŠ¬å¤´ -->
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="font-size: 22px; color: #333; margin-bottom: 8px; font-weight: bold;">æ±Ÿè‹å¸¸é˜´æ²™ç°ä»£å†œä¸šå‘å±•æœ‰é™å…¬å¸</h1>
                <h2 style="font-size: 18px; color: #666; font-weight: normal;">ä½å®¿äººå‘˜ç®¡ç†ç³»ç»Ÿ</h2>
            </div>
            
            <div class="login-form">
                <input type="text" id="loginUsername" placeholder="ç”¨æˆ·å" onkeypress="if(event.key==='Enter')handleLogin()" />
                <input type="password" id="loginPassword" placeholder="å¯†ç " onkeypress="if(event.key==='Enter')handleLogin()" />
                <button onclick="handleLogin()">ç™»å½•</button>
            </div>
        </div>
    </div>

    <!-- åˆå§‹è®¾ç½®Modal -->
    <div id="initialSetupModal" class="modal">
        <div class="modal-content">
            <h2>ğŸ” é¦–æ¬¡ä½¿ç”¨è®¾ç½®</h2>
            <p style="color: #666; margin: 15px 0;">è¯·ä¸ºç®¡ç†å‘˜è´¦å·è®¾ç½®å®‰å…¨å¯†ç </p>
            <div class="form-group">
                <label>ç®¡ç†å‘˜ç”¨æˆ·å</label>
                <input type="text" id="setupAdminUsername" value="admin" readonly style="background: #f5f5f5;">
            </div>
            <div class="form-group">
                <label>ç®¡ç†å‘˜å¯†ç  *</label>
                <input type="password" id="setupAdminPassword" placeholder="è‡³å°‘6ä½å­—ç¬¦">
            </div>
            <div class="form-group">
                <label>ç¡®è®¤å¯†ç  *</label>
                <input type="password" id="setupAdminPasswordConfirm" placeholder="å†æ¬¡è¾“å…¥å¯†ç ">
            </div>
            <hr style="margin: 20px 0;">
            <div class="form-group">
                <label>æŸ¥çœ‹è€…ç”¨æˆ·å</label>
                <input type="text" id="setupViewerUsername" value="viewer" readonly style="background: #f5f5f5;">
            </div>
            <div class="form-group">
                <label>æŸ¥çœ‹è€…å¯†ç  *</label>
                <input type="password" id="setupViewerPassword" placeholder="è‡³å°‘6ä½å­—ç¬¦">
            </div>
            <div class="form-group">
                <label>ç¡®è®¤å¯†ç  *</label>
                <input type="password" id="setupViewerPasswordConfirm" placeholder="å†æ¬¡è¾“å…¥å¯†ç ">
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="completeInitialSetup()">å®Œæˆè®¾ç½®</button>
            </div>
            <div style="margin-top: 15px; padding: 10px; background: #f0f8ff; border-radius: 6px; font-size: 12px;">
                <strong>æç¤ºï¼š</strong>è¯·å¦¥å–„ä¿ç®¡æ‚¨çš„å¯†ç ï¼Œè®¾ç½®å®Œæˆåå°†æ— æ³•æŸ¥çœ‹é»˜è®¤å¯†ç 
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ç•Œé¢ -->
    <div id="mainApp" class="hidden">
    <div class="container">
        <!-- å…¬å¸æŠ¬å¤´ - ç½®é¡¶ -->
        <div class="card" id="companyHeader">
            <h1>æ±Ÿè‹å¸¸é˜´æ²™ç°ä»£å†œä¸šå‘å±•æœ‰é™å…¬å¸</h1>
            <h2 style="text-align: center; color: #666; margin-top: 10px;">ä½å®¿äººå‘˜ç®¡ç†ç³»ç»Ÿ</h2>
        </div>

        <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
        <div class="user-info">
            <div>
                <span class="user-name" id="currentUserName">ç”¨æˆ·</span>
                <span class="user-role" id="currentUserRole">è§’è‰²</span>
            </div>
            <div class="sync-status">
                <span id="syncStatusText">æœªåŒæ­¥</span>
                <span class="sync-indicator" id="syncIndicator"></span>
                <button class="btn btn-info" onclick="syncData()" id="syncBtn">åŒæ­¥æ•°æ®</button>
                <button class="btn btn-info" onclick="showImport()">ğŸ“¤ æ‰¹é‡å¯¼å…¥</button>
                <button class="btn btn-primary" onclick="exportExcel()">ğŸ“¥ å¯¼å‡ºExcel</button>
                <button class="btn btn-secondary" onclick="handleLogout()">é€€å‡º</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('register')">äººå‘˜ç™»è®°</button>
            <button class="tab" onclick="switchTab('list')">äººå‘˜åˆ—è¡¨</button>
            <button class="tab" onclick="switchTab('checkout')">é€€å®¿äººå‘˜</button>
            <button class="tab" onclick="switchTab('rooms')">æˆ¿é—´ç®¡ç†</button>
            <button class="tab" onclick="switchTab('floorplan')">å®¿èˆå¹³é¢å›¾</button>
            <button class="tab" onclick="switchTab('stats')">æ•°æ®æ¦‚è§ˆ</button>
            <button class="tab" onclick="switchTab('settings')">ç³»ç»Ÿè®¾ç½®</button>
        </div>

        <!-- ç™»è®°è¡¨å• -->
        <div id="registerTab" class="card">
            <h2 id="formTitle">æ–°å¢äººå‘˜ç™»è®°</h2>
            <div id="adminOnlyMessage" class="hidden" style="padding: 20px; background: #fff3cd; border-radius: 6px; text-align: center;">
                âš ï¸ åªæœ‰ç®¡ç†å‘˜æ‰èƒ½è¿›è¡Œäººå‘˜ç™»è®°æ“ä½œ
            </div>
            <form onsubmit="handleSubmit(event)" id="registerForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>å§“å *</label>
                        <input type="text" id="name" required>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label>èº«ä»½è¯å· *</label>
                        <input type="text" id="idCard" maxlength="18" required oninput="validateIdCard()">
                        <span id="idError" class="error hidden"></span>
                        <span id="idSuccess" class="success hidden"></span>
                    </div>
                    <div class="form-group">
                        <label>æ€§åˆ«</label>
                        <input type="text" id="gender" readonly>
                    </div>
                    <div class="form-group">
                        <label>å‡ºç”Ÿæ—¥æœŸ</label>
                        <input type="text" id="birthDate" readonly>
                    </div>
                    <div class="form-group">
                        <label>å¹´é¾„</label>
                        <input type="text" id="age" readonly>
                    </div>
                    <div class="form-group">
                        <label>è”ç³»ç”µè¯ *</label>
                        <input type="tel" id="phone" required>
                    </div>
                    <div class="form-group" style="grid-column: span 3;">
                        <label>å®¶åº­åœ°å€</label>
                        <input type="text" id="address">
                    </div>
                    <div class="form-group">
                        <label>æ°‘æ—</label>
                        <input type="text" id="ethnicity">
                    </div>
                    <div class="form-group">
                        <label>æ¥æºå•ä½</label>
                        <input type="text" id="sourceUnit">
                    </div>
                    <div class="form-group">
                        <label>å…¥èŒéƒ¨é—¨</label>
                        <input type="text" id="department">
                    </div>
                    <div class="form-group">
                        <label>å®¿èˆæ¥¼æ ‹</label>
                        <select id="building" onchange="updateRoomOptions()">
                            <option value="">è¯·é€‰æ‹©æ¥¼æ ‹</option>
                            <option value="å®¿èˆäºŒæ¥¼">å®¿èˆäºŒæ¥¼</option>
                            <option value="å®¿èˆä¸‰æ¥¼">å®¿èˆä¸‰æ¥¼</option>
                            <option value="åŠå…¬ä¸‰æ¥¼">åŠå…¬ä¸‰æ¥¼</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æˆ¿é—´å·</label>
                        <select id="room">
                            <option value="">è¯·å…ˆé€‰æ‹©æ¥¼æ ‹</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>åºŠä½å·</label>
                        <input type="text" id="bed">
                    </div>
                    <div class="form-group">
                        <label>å…¥ä½æ—¥æœŸ</label>
                        <input type="date" id="checkInDate">
                    </div>
                    <div class="form-group">
                        <label>ç´§æ€¥è”ç³»äºº</label>
                        <input type="text" id="emergencyContact">
                    </div>
                    <div class="form-group">
                        <label>ç´§æ€¥è”ç³»ç”µè¯</label>
                        <input type="tel" id="emergencyPhone">
                    </div>
                    <div class="form-group">
                        <label>ç¦»èŒæ—¥æœŸ</label>
                        <input type="date" id="resignDate">
                    </div>
                    <div class="form-group">
                        <label>äº¤å‰²æ‰‹ç»­</label>
                        <select id="handover">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                            <option value="æœªå®Œæˆ">æœªå®Œæˆ</option>
                            <option value="è¿›è¡Œä¸­">è¿›è¡Œä¸­</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: span 3;">
                        <label>å¤‡æ³¨è¯´æ˜</label>
                        <textarea id="notes" rows="3"></textarea>
                    </div>
                </div>
                <button type="submit" class="btn btn-info" id="submitBtn">ğŸ’¾ ç¡®å®šä¿å­˜</button>
                <button type="button" class="btn btn-warning hidden" id="cancelBtn" onclick="cancelEdit()">å–æ¶ˆç¼–è¾‘</button>
            </form>
        </div>

        <!-- äººå‘˜åˆ—è¡¨ -->
        <div id="listTab" class="card hidden">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                <h2 style="margin: 0;">åœ¨ä½äººå‘˜åˆ—è¡¨</h2>
                <input type="text" id="search" placeholder="æœç´¢å§“åã€èº«ä»½è¯å·ã€ç”µè¯..." style="flex:1;max-width:300px;padding:10px;border:1px solid #ddd;border-radius:6px;" oninput="filterRecords()">
                <select id="dormFilter" style="padding:10px;border:1px solid #ddd;border-radius:6px;min-width:200px;" onchange="filterRecords()">
                    <option value="">å…¨éƒ¨å®¿èˆ</option>
                </select>
                <div class="batch-actions" id="batchActions" style="display:none;">
                    <span class="selected-count">å·²é€‰æ‹© <span id="selectedCount">0</span> æ¡</span>
                    <button class="btn btn-warning" onclick="batchCheckout()">ğŸšª æ‰¹é‡é€€å®¿</button>
                    <button class="btn btn-danger" onclick="batchDelete()">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
                    <button class="btn btn-secondary" onclick="clearSelection()">å–æ¶ˆé€‰æ‹©</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th style="width:50px;">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </div>
                        </th>
                        <th>åºå·</th>
                        <th>å§“å</th>
                        <th>æ€§åˆ«</th>
                        <th>å¹´é¾„</th>
                        <th>ç”µè¯</th>
                        <th>éƒ¨é—¨</th>
                        <th>å®¿èˆ</th>
                        <th>å…¥ä½æ—¥æœŸ</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <!-- é€€å®¿äººå‘˜ -->
        <div id="checkoutTab" class="card hidden">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                <h2 style="margin: 0;">é€€å®¿äººå‘˜åˆ—è¡¨</h2>
                <input type="text" id="searchCheckout" placeholder="æœç´¢å§“åã€èº«ä»½è¯å·ã€ç”µè¯..." style="flex:1;max-width:400px;padding:10px;border:1px solid #ddd;border-radius:6px;" oninput="filterCheckoutRecords()">
                <div class="batch-actions" id="batchActionsCheckout" style="display:none;">
                    <span class="selected-count">å·²é€‰æ‹© <span id="selectedCountCheckout">0</span> æ¡</span>
                    <button class="btn btn-danger" onclick="batchDeleteCheckout()">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
                    <button class="btn btn-secondary" onclick="clearSelectionCheckout()">å–æ¶ˆé€‰æ‹©</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th style="width:50px;">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="selectAllCheckout" onchange="toggleSelectAllCheckout()">
                            </div>
                        </th>
                        <th>åºå·</th>
                        <th>å§“å</th>
                        <th>æ€§åˆ«</th>
                        <th>ç”µè¯</th>
                        <th>éƒ¨é—¨</th>
                        <th>åŸå®¿èˆ</th>
                        <th>å…¥ä½æ—¥æœŸ</th>
                        <th>é€€å®¿æ—¥æœŸ</th>
                        <th>ç¦»èŒæ—¥æœŸ</th>
                        <th>äº¤å‰²æ‰‹ç»­</th>
                        <th>é€€å®¿åŸå› </th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="checkoutTableBody"></tbody>
            </table>
        </div>

        <!-- æˆ¿é—´ç®¡ç† -->
        <div id="roomsTab" class="card hidden">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                <h2 style="margin: 0;">æˆ¿é—´ç®¡ç†</h2>
                <button class="btn btn-primary" onclick="showAddRoom()">â• æ·»åŠ æˆ¿é—´</button>
                <div class="batch-actions" id="batchActionsRooms" style="display:none;">
                    <span class="selected-count">å·²é€‰æ‹© <span id="selectedCountRooms">0</span> æ¡</span>
                    <button class="btn btn-danger" onclick="batchDeleteRooms()">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
                    <button class="btn btn-secondary" onclick="clearSelectionRooms()">å–æ¶ˆé€‰æ‹©</button>
                </div>
            </div>
            
            <div id="roomsContainer"></div>
        </div>

        <!-- å®¿èˆå¹³é¢å›¾ -->
        <div id="floorplanTab" class="card hidden">
            <h2>å®¿èˆå¹³é¢å›¾</h2>
            <p style="color: #666; margin-bottom: 20px;">ç‚¹å‡»æˆ¿é—´æŸ¥çœ‹è¯¦ç»†å…¥ä½æƒ…å†µ</p>
            <div id="floorplanContainer"></div>
        </div>

        <!-- æ•°æ®æ¦‚è§ˆ -->
        <div id="statsTab" class="card hidden">
            <h2>æ•°æ®æ€»è§ˆ</h2>
            <div class="stats">
                <div class="stat-card">
                    <div>æ€»äººæ¬¡</div>
                    <div class="stat-value" style="color:#2196F3;" id="total">0</div>
                </div>
                <div class="stat-card">
                    <div>åœ¨ä½äººæ•°</div>
                    <div class="stat-value" style="color:#4CAF50;" id="active">0</div>
                </div>
                <div class="stat-card">
                    <div>å·²é€€å®¿</div>
                    <div class="stat-value" style="color:#FF9800;" id="checkout">0</div>
                </div>
                <div class="stat-card">
                    <div>æ¥¼å±‚æ•°</div>
                    <div class="stat-value" style="color:#9C27B0;" id="buildings">0</div>
                </div>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div>æ€»æˆ¿é—´æ•°</div>
                    <div class="stat-value" style="color:#00BCD4;" id="totalRooms">0</div>
                </div>
                <div class="stat-card">
                    <div>æ€»åºŠä½æ•°</div>
                    <div class="stat-value" style="color:#FF5722;" id="totalBeds">0</div>
                </div>
                <div class="stat-card">
                    <div>å·²å…¥ä½åºŠä½</div>
                    <div class="stat-value" style="color:#f44336;" id="occupiedBeds">0</div>
                    <div style="font-size:12px;color:#666;margin-top:8px;">
                        æ™®é€š <span id="occupiedBedsNormal" style="font-weight:bold;color:#f44336;">0</span> | 
                        ç®¡ç† <span id="occupiedBedsManager" style="font-weight:bold;color:#9C27B0;">0</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div>å‰©ä½™åºŠä½</div>
                    <div class="stat-value" style="color:#4CAF50;" id="availableBeds">0</div>
                    <div style="font-size:12px;color:#666;margin-top:8px;">
                        æ™®é€š <span id="availableBedsNormal" style="font-weight:bold;color:#4CAF50;">0</span> | 
                        ç®¡ç† <span id="availableBedsManager" style="font-weight:bold;color:#9C27B0;">0</span>
                    </div>
                </div>
            </div>

            <h2 style="margin-top: 30px; margin-bottom: 10px; color: #333; font-size: 22px;">ğŸ“Š æˆ¿å‹æ¦‚å†µ</h2>
            <div id="roomTypeStatsContainer"></div>

            <h2 style="margin-top: 40px; margin-bottom: 10px; color: #333; font-size: 22px;">ğŸ›ï¸ åºŠä½ä½¿ç”¨æƒ…å†µ</h2>
            <div id="bedStatsContainer"></div>
        </div>

        <!-- æ–°å¢ï¼šç³»ç»Ÿè®¾ç½®é¡µ -->
        <div id="settingsTab" class="card hidden">
            <h2>ç³»ç»Ÿè®¾ç½®</h2>
            <div class="form-grid" style="grid-template-columns: 1fr;">
                <div class="form-group">
                    <label>GitHub Token (ç”¨äºæ•°æ®åŒæ­¥)</label>
                    <input type="password" id="githubToken" placeholder="è¾“å…¥æ‚¨çš„GitHub Personal Access Token">
                    <small style="color: #666;">åˆ›å»ºToken: GitHubè®¾ç½® â†’ Developer settings â†’ Personal access tokens â†’ Generate new token (éœ€è¦gistæƒé™)</small>
                </div>
                <div class="form-group">
                    <label>Gist ID (ç•™ç©ºå°†è‡ªåŠ¨åˆ›å»º)</label>
                    <input type="text" id="gistId" placeholder="å¯é€‰ï¼šè¾“å…¥ç°æœ‰Gist ID">
                </div>
                <div>
                    <button class="btn btn-primary" onclick="saveGitHubConfig()">ä¿å­˜é…ç½®</button>
                    <button class="btn btn-info" onclick="testGitHubConnection()">æµ‹è¯•è¿æ¥</button>
                </div>
            </div>
            
            <hr style="margin: 30px 0;" id="userManagementDivider">
            
            <div id="userManagementSection">
                <h3>ç”¨æˆ·ç®¡ç†</h3>
                <div id="adminOnlySettings" class="hidden" style="padding: 20px; background: #fff3cd; border-radius: 6px; text-align: center;">
                    âš ï¸ åªæœ‰ç®¡ç†å‘˜æ‰èƒ½ç®¡ç†ç”¨æˆ·
                </div>
                <div id="userManagement">
                    <p style="color: #666; margin-bottom: 15px;">ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹ç”¨æˆ·å¯†ç å’Œæƒé™</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>ç”¨æˆ·å</label>
                            <select id="manageUsername">
                                <option value="admin">admin (ç®¡ç†å‘˜)</option>
                                <option value="viewer">viewer (æŸ¥çœ‹è€…)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æ–°å¯†ç </label>
                            <input type="password" id="newPassword" placeholder="è¾“å…¥æ–°å¯†ç ">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-warning" onclick="changePassword()" style="margin-top: 24px;">ä¿®æ”¹å¯†ç </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¯¼å…¥æ¨¡æ€æ¡† -->
        <div id="importModal" class="modal">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">æ‰¹é‡å¯¼å…¥æ•°æ®ï¼ˆæ”¯æŒå¤šSheetï¼‰</h3>
                    <button onclick="closeImport()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #999; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.3s;" onmouseover="this.style.backgroundColor='#f0f0f0'; this.style.color='#333';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#999';" title="å…³é—­">&times;</button>
                </div>
                <p style="margin:15px 0;">è¯·ä¸Šä¼ Excelæ–‡ä»¶ï¼Œæ”¯æŒä»¥ä¸‹ä¸¤ç§æ ¼å¼ï¼š</p>
                <p style="margin:5px 0;color:#2196F3;">âœ… <strong>æ¨èï¼š</strong>åŒ…å«3ä¸ªSheetçš„å®Œæ•´æ•°æ®è¡¨æ ¼ï¼ˆåœ¨èŒäººå‘˜ã€é€€å®¿äººå‘˜ã€æˆ¿é—´ç®¡ç†ï¼‰</p>
                <p style="margin:5px 0;color:#666;">âœ… å•ä¸ªSheetçš„äººå‘˜æ•°æ®è¡¨æ ¼</p>
                <p style="margin:15px 0;color:#ff9800;font-weight:bold;">âš ï¸ æ‰¹é‡å¯¼å…¥å·²å…³é—­èº«ä»½è¯å·æ ¼å¼éªŒè¯ï¼Œå¯å¯¼å…¥ä»»æ„æ ¼å¼æ•°æ®</p>
                <p style="margin:5px 0;color:#4CAF50;font-size:14px;">ğŸ’¡ æç¤ºï¼šä½¿ç”¨"å¯¼å‡ºExcel"åŠŸèƒ½å¯¼å‡ºçš„æ–‡ä»¶å¯ä»¥ç›´æ¥å¯¼å…¥</p>
                <input type="file" accept=".xlsx,.xls" onchange="handleImport(event)" style="margin-bottom:15px;">
                <button class="btn btn-danger" onclick="closeImport()">å…³é—­</button>
            </div>
        </div>

        <!-- é€€å®¿äººå‘˜å¯¼å…¥æ¨¡æ€æ¡† -->
        <div id="importCheckoutModal" class="modal">
            <div class="modal-content">
                <h3>æ‰¹é‡å¯¼å…¥é€€å®¿äººå‘˜</h3>
                <p style="margin:15px 0;">è¯·ä¸Šä¼ Excelæ–‡ä»¶,æ”¯æŒåŒ…å«ä»¥ä¸‹åˆ—:å§“åã€èº«ä»½è¯å·ã€è”ç³»ç”µè¯ã€éƒ¨é—¨ã€é€€å®¿æ—¥æœŸã€é€€å®¿åŸå› ç­‰ä¿¡æ¯</p>
                <p style="margin:15px 0;color:#ff9800;font-weight:bold;">âš ï¸ æ‰¹é‡å¯¼å…¥å·²å…³é—­èº«ä»½è¯å·æ ¼å¼éªŒè¯,å¯å¯¼å…¥ä»»æ„æ ¼å¼æ•°æ®</p>
                <input type="file" accept=".xlsx,.xls" onchange="handleImportCheckout(event)" style="margin-bottom:15px;">
                <button class="btn btn-danger" onclick="closeImportCheckout()">å…³é—­</button>
            </div>
        </div>

        <!-- æ‰¹é‡é€€å®¿æ¨¡æ€æ¡† -->
        <div id="batchCheckoutModal" class="modal">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">æ‰¹é‡é€€å®¿</h3>
                    <button onclick="closeBatchCheckout()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #999; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.3s;" onmouseover="this.style.backgroundColor='#f0f0f0'; this.style.color='#333';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#999';" title="å…³é—­">&times;</button>
                </div>
                <p style="margin:15px 0;">å·²é€‰æ‹© <strong id="batchCheckoutCount">0</strong> äºº</p>
                <div class="form-group">
                    <label>é€€å®¿åŸå› </label>
                    <textarea id="batchCheckoutReason" rows="3" placeholder="è¯·è¾“å…¥é€€å®¿åŸå› ..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;"></textarea>
                </div>
                <div style="margin-top:20px;">
                    <button class="btn btn-warning" onclick="confirmBatchCheckout()">ç¡®å®šé€€å®¿</button>
                    <button class="btn btn-secondary" onclick="closeBatchCheckout()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ /ç¼–è¾‘æˆ¿é—´æ¨¡æ€æ¡† -->
        <div id="roomModal" class="modal">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 id="roomModalTitle" style="margin: 0;">æ·»åŠ æˆ¿é—´</h3>
                    <button onclick="closeRoomModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #999; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.3s;" onmouseover="this.style.backgroundColor='#f0f0f0'; this.style.color='#333';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#999';" title="å…³é—­">&times;</button>
                </div>
                <form onsubmit="saveRoom(event)">
                    <div class="form-group">
                        <label>æ¥¼æ ‹ *</label>
                        <select id="roomBuilding" required>
                            <option value="">è¯·é€‰æ‹©æ¥¼æ ‹</option>
                            <option value="å®¿èˆäºŒæ¥¼">å®¿èˆäºŒæ¥¼</option>
                            <option value="å®¿èˆä¸‰æ¥¼">å®¿èˆä¸‰æ¥¼</option>
                            <option value="åŠå…¬ä¸‰æ¥¼">åŠå…¬ä¸‰æ¥¼</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æˆ¿é—´å· *</label>
                        <input type="text" id="roomNumber" required placeholder="ä¾‹å¦‚: 201">
                    </div>
                    <div class="form-group">
                        <label>åºŠä½æ•° *</label>
                        <input type="number" id="roomBeds" required min="1" placeholder="ä¾‹å¦‚: 4">
                    </div>
                    <div class="form-group">
                        <label>å¤‡æ³¨</label>
                        <textarea id="roomNotes" rows="2" placeholder="å¯é€‰å¡«å†™æˆ¿é—´å¤‡æ³¨ä¿¡æ¯"></textarea>
                    </div>
                    <div style="margin-top:20px;">
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                        <button type="button" class="btn btn-secondary" onclick="closeRoomModal()">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æˆ¿é—´è¯¦æƒ…æ¨¡æ€æ¡† -->
        <div id="roomDetailModal" class="modal room-detail-modal">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 id="roomDetailTitle" style="margin: 0;">æˆ¿é—´è¯¦æƒ…</h3>
                    <button onclick="closeRoomDetail()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #999; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.3s;" onmouseover="this.style.backgroundColor='#f0f0f0'; this.style.color='#333';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#999';" title="å…³é—­">&times;</button>
                </div>
                <div id="roomDetailContent"></div>
                <div style="margin-top:20px;">
                    <button class="btn btn-secondary" onclick="closeRoomDetail()">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        // ========== å…¨å±€å˜é‡ ==========
        let records = JSON.parse(localStorage.getItem('dormRecords') || '[]');
        let rooms = JSON.parse(localStorage.getItem('dormRooms') || '[]');
        let editingId = null;
        let editingRoomId = null;
        let selectedIds = new Set();
        let selectedCheckoutIds = new Set();
        let currentUser = null;
        let githubConfig = {
            token: '',
            gistId: ''
        };

        // ========== ç”¨æˆ·è®¤è¯ç³»ç»Ÿ ==========
        const defaultUsers = {
            admin: { password: 'admin123', role: 'admin', name: 'ç®¡ç†å‘˜' },
            viewer: { password: 'viewer123', role: 'viewer', name: 'æŸ¥çœ‹è€…' }
        };

        function checkFirstTimeUse() {
            // ä»localStorageè¯»å–usersæ•°æ®
            const savedUsers = JSON.parse(localStorage.getItem('users') || '{}');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•ç”¨æˆ·ï¼ˆä»äº‘ç«¯æˆ–æœ¬åœ°åŠ è½½çš„ï¼‰
            const hasUsers = Object.keys(savedUsers).length > 0;
            
            // åªæœ‰åœ¨userså¯¹è±¡ä¸ºç©ºï¼ˆäº‘ç«¯å’Œæœ¬åœ°éƒ½æ²¡æœ‰ç”¨æˆ·æ•°æ®ï¼‰æ—¶æ‰éœ€è¦è®¾ç½®å¯†ç 
            if (!hasUsers) {
                // æ˜¾ç¤ºè®¾ç½®ç•Œé¢è®©ç”¨æˆ·åˆå§‹åŒ–ç³»ç»Ÿ
                openModal('setupModal');
                return true;
            }
            // å¦‚æœæœ‰ç”¨æˆ·æ•°æ®ï¼ˆä»äº‘ç«¯æˆ–æœ¬åœ°åŠ è½½ï¼‰ï¼Œç›´æ¥è¿”å›falseï¼Œä¸æ˜¾ç¤ºè®¾ç½®ç•Œé¢
            return false;
        }

        function showInitialSetup() {
            const modal = document.getElementById('initialSetupModal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        async function completeInitialSetup() {
            const adminPassword = document.getElementById('setupAdminPassword').value.trim();
            const adminPasswordConfirm = document.getElementById('setupAdminPasswordConfirm').value.trim();
            const viewerPassword = document.getElementById('setupViewerPassword').value.trim();
            const viewerPasswordConfirm = document.getElementById('setupViewerPasswordConfirm').value.trim();
            
            if (!adminPassword || !viewerPassword) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¯†ç ');
                return;
            }
            
            if (adminPassword.length < 6 || viewerPassword.length < 6) {
                alert('å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½');
                return;
            }
            
            if (adminPassword !== adminPasswordConfirm) {
                alert('ç®¡ç†å‘˜å¯†ç ä¸¤æ¬¡è¾“å…¥ä¸ä¸€è‡´');
                return;
            }
            
            if (viewerPassword !== viewerPasswordConfirm) {
                alert('æŸ¥çœ‹è€…å¯†ç ä¸¤æ¬¡è¾“å…¥ä¸ä¸€è‡´');
                return;
            }
            
            const newUsers = {
                admin: { password: adminPassword, role: 'admin', name: 'ç®¡ç†å‘˜' },
                viewer: { password: viewerPassword, role: 'viewer', name: 'æŸ¥çœ‹è€…' }
            };
            
            localStorage.setItem('users', JSON.stringify(newUsers));
            localStorage.setItem('systemInitialized', 'true');
            
            document.getElementById('initialSetupModal').classList.remove('active');
            document.getElementById('firstTimeSetup').classList.add('hidden');
            
            // ç«‹å³åŒæ­¥åˆ°äº‘ç«¯
            const config = JSON.parse(localStorage.getItem('githubConfig') || '{}');
            if (config.token) {
                await syncToGitHub();
                alert('è®¾ç½®å®Œæˆå¹¶å·²åŒæ­¥åˆ°äº‘ç«¯ï¼è¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•');
            } else {
                alert('è®¾ç½®å®Œæˆï¼è¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•\n\næç¤ºï¼šå»ºè®®åœ¨"ç³»ç»Ÿè®¾ç½®"ä¸­é…ç½®GitHubåŒæ­¥ï¼Œè¿™æ ·å…¶ä»–è®¾å¤‡å°±èƒ½è‡ªåŠ¨è·å–å¯†ç ');
            }
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('setupAdminPassword').value = '';
            document.getElementById('setupAdminPasswordConfirm').value = '';
            document.getElementById('setupViewerPassword').value = '';
            document.getElementById('setupViewerPasswordConfirm').value = '';
        }

        function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }
            
            // è·å–å·²ä¿å­˜çš„ç”¨æˆ·ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤ç”¨æˆ·
            const savedUsers = JSON.parse(localStorage.getItem('users') || JSON.stringify(defaultUsers));
            
            if (savedUsers[username] && savedUsers[username].password === password) {
                currentUser = {
                    username: username,
                    role: savedUsers[username].role,
                    name: savedUsers[username].name
                };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showMainApp();
            } else {
                alert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
            }
        }

        function handleLogout() {
            console.log('=== handleLogout called ==='); // è°ƒè¯•æ—¥å¿—
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                console.log('âœ“ User confirmed logout'); // è°ƒè¯•æ—¥å¿—
                currentUser = null;
                localStorage.removeItem('currentUser');
                console.log('â†’ Calling showLoginScreen()...'); // è°ƒè¯•æ—¥å¿—
                showLoginScreen();
            } else {
                console.log('âœ— User cancelled logout'); // è°ƒè¯•æ—¥å¿—
            }
        }

        function showLoginScreen() {
            console.log('=== showLoginScreen called ==='); // è°ƒè¯•æ—¥å¿—
            
            // è·å–å…ƒç´ 
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            
            console.log('ğŸ“ Elements found:');
            console.log('  - loginScreen:', loginScreen ? 'âœ“' : 'âœ—'); // è°ƒè¯•æ—¥å¿—
            console.log('  - mainApp:', mainApp ? 'âœ“' : 'âœ—'); // è°ƒè¯•æ—¥å¿—
            
            console.log('ğŸ“ Before changes:');
            console.log('  - loginScreen classes:', loginScreen?.className); // è°ƒè¯•æ—¥å¿—
            console.log('  - mainApp classes:', mainApp?.className); // è°ƒè¯•æ—¥å¿—
            
            // æ˜¾ç¤ºç™»å½•ç•Œé¢ï¼Œéšè—ä¸»åº”ç”¨
            if (loginScreen) {
                loginScreen.classList.remove('hidden');
                loginScreen.style.display = ''; // ç¡®ä¿æ²¡æœ‰inline styleè¦†ç›–
            }
            
            if (mainApp) {
                mainApp.classList.add('hidden');
            }
            
            console.log('ğŸ“ After changes:');
            console.log('  - loginScreen classes:', loginScreen?.className); // è°ƒè¯•æ—¥å¿—
            console.log('  - mainApp classes:', mainApp?.className); // è°ƒè¯•æ—¥å¿—
            
            // æ¸…ç©ºç™»å½•è¡¨å•
            const usernameInput = document.getElementById('loginUsername');
            const passwordInput = document.getElementById('loginPassword');
            if (usernameInput) usernameInput.value = '';
            if (passwordInput) passwordInput.value = '';
            
            // é‡ç½®æ‰€æœ‰æ ‡ç­¾é¡µä¸ºé»˜è®¤çŠ¶æ€
            document.querySelectorAll('.tab').forEach((t, i) => {
                if (i === 0) {
                    t.classList.add('active');
                } else {
                    t.classList.remove('active');
                }
            });
            
            // éšè—æ‰€æœ‰å†…å®¹å¡ç‰‡ï¼Œåªæ˜¾ç¤ºç¬¬ä¸€ä¸ªï¼ˆç™»è®°è¡¨å•ï¼‰
            document.querySelectorAll('.card').forEach(c => {
                if (!c.classList.contains('login-card') && 
                    !c.classList.contains('user-info') && 
                    c.id !== 'companyHeader') {
                    c.classList.add('hidden');
                }
            });
            
            // æ˜¾ç¤ºç™»è®°è¡¨å•
            const registerTab = document.getElementById('registerTab');
            if (registerTab) {
                registerTab.classList.remove('hidden');
            }
            
            console.log('=== showLoginScreen completed ==='); // è°ƒè¯•æ—¥å¿—
        }

        function showMainApp() {
            console.log('=== showMainApp called ==='); // è°ƒè¯•æ—¥å¿—
            
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            
            console.log('ğŸ“ Before changes:');
            console.log('  - loginScreen classes:', loginScreen?.className);
            console.log('  - mainApp classes:', mainApp?.className);
            
            // éšè—ç™»å½•ç•Œé¢
            if (loginScreen) {
                loginScreen.classList.add('hidden');
            }
            
            // æ˜¾ç¤ºä¸»åº”ç”¨
            if (mainApp) {
                mainApp.classList.remove('hidden');
            }
            
            console.log('ğŸ“ After changes:');
            console.log('  - loginScreen classes:', loginScreen?.className);
            console.log('  - mainApp classes:', mainApp?.className);
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            const userNameElement = document.getElementById('currentUserName');
            const roleElement = document.getElementById('currentUserRole');
            
            if (userNameElement && currentUser) {
                userNameElement.textContent = currentUser.name;
            }
            
            if (roleElement && currentUser) {
                roleElement.textContent = currentUser.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æŸ¥çœ‹è€…';
                roleElement.className = 'user-role' + (currentUser.role === 'viewer' ? ' viewer' : '');
            }
            
            // æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤ºé»˜è®¤æ ‡ç­¾é¡µ
            console.log('â†’ Calling switchTab...');
            if (currentUser.role === 'viewer') {
                switchTab('list'); // vieweré»˜è®¤æ˜¾ç¤ºäººå‘˜åˆ—è¡¨
            } else {
                switchTab('register'); // adminé»˜è®¤æ˜¾ç¤ºäººå‘˜ç™»è®°
            }
            
            updateUIPermissions();
            loadData();
            
            console.log('=== showMainApp completed ==='); // è°ƒè¯•æ—¥å¿—
        }

        function updateUIPermissions() {
            if (!currentUser) return; // å¦‚æœæ²¡æœ‰å½“å‰ç”¨æˆ·ï¼Œç›´æ¥è¿”å›
            
            const isAdmin = currentUser.role === 'admin';
            
            // æ§åˆ¶äººå‘˜ç™»è®°æ ‡ç­¾çš„æ˜¾ç¤º
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                if (tab.textContent.includes('äººå‘˜ç™»è®°') && !isAdmin) {
                    tab.style.display = 'none';
                }
            });
            
            // æ§åˆ¶äººå‘˜ç™»è®°è¡¨å•
            const registerForm = document.getElementById('registerForm');
            const adminOnlyMessage = document.getElementById('adminOnlyMessage');
            
            if (registerForm && adminOnlyMessage) {
                if (!isAdmin) {
                    registerForm.classList.add('hidden');
                    adminOnlyMessage.classList.remove('hidden');
                } else {
                    registerForm.classList.remove('hidden');
                    adminOnlyMessage.classList.add('hidden');
                }
            }
            
            // æ§åˆ¶ç”¨æˆ·ç®¡ç†æ•´ä¸ªåŒºåŸŸçš„æ˜¾ç¤ºï¼ˆåŒ…æ‹¬æ ‡é¢˜å’Œåˆ†éš”çº¿ï¼‰
            const userManagementSection = document.getElementById('userManagementSection');
            const userManagementDivider = document.getElementById('userManagementDivider');
            
            if (userManagementSection) {
                userManagementSection.style.display = isAdmin ? 'block' : 'none';
            }
            if (userManagementDivider) {
                userManagementDivider.style.display = isAdmin ? 'block' : 'none';
            }
            
            // æ§åˆ¶å¯¼å‡ºå¯¼å…¥æŒ‰é’®
            const importBtn = document.querySelector('button[onclick="showImport()"]');
            const exportBtn = document.querySelector('button[onclick="exportExcel()"]');
            const syncBtn = document.getElementById('syncBtn');
            
            if (importBtn) {
                importBtn.style.display = isAdmin ? 'inline-block' : 'none';
            }
            if (exportBtn) {
                exportBtn.style.display = isAdmin ? 'inline-block' : 'none';
            }
            if (syncBtn) {
                syncBtn.style.display = isAdmin ? 'inline-block' : 'none';
            }
        }

        async function changePassword() {
            if (currentUser.role !== 'admin') {
                alert('åªæœ‰ç®¡ç†å‘˜æ‰èƒ½ä¿®æ”¹å¯†ç ');
                return;
            }
            
            const username = document.getElementById('manageUsername').value;
            const newPassword = document.getElementById('newPassword').value.trim();
            
            if (!newPassword) {
                alert('è¯·è¾“å…¥æ–°å¯†ç ');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½');
                return;
            }
            
            const savedUsers = JSON.parse(localStorage.getItem('users') || JSON.stringify(defaultUsers));
            savedUsers[username].password = newPassword;
            localStorage.setItem('users', JSON.stringify(savedUsers));
            
            // è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯
            const synced = await syncToGitHub();
            
            if (synced) {
                alert(`ç”¨æˆ· ${username} çš„å¯†ç å·²ä¿®æ”¹å¹¶åŒæ­¥åˆ°äº‘ç«¯`);
            } else {
                alert(`ç”¨æˆ· ${username} çš„å¯†ç å·²ä¿®æ”¹ï¼ˆæœ¬åœ°ä¿å­˜æˆåŠŸï¼Œä½†æœªåŒæ­¥åˆ°äº‘ç«¯ï¼Œè¯·æ£€æŸ¥GitHubé…ç½®ï¼‰`);
            }
            
            document.getElementById('newPassword').value = '';
        }

        // ========== GitHubæ•°æ®åŒæ­¥ ==========
        function saveGitHubConfig() {
            const token = document.getElementById('githubToken').value.trim();
            const gistId = document.getElementById('gistId').value.trim();
            
            if (!token) {
                alert('è¯·è¾“å…¥GitHub Token');
                return;
            }
            
            githubConfig = { token, gistId };
            localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
            alert('GitHubé…ç½®å·²ä¿å­˜');
        }

        async function testGitHubConnection() {
            const config = JSON.parse(localStorage.getItem('githubConfig') || '{}');
            if (!config.token) {
                alert('è¯·å…ˆé…ç½®GitHub Token');
                return;
            }
            
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`è¿æ¥æˆåŠŸï¼\nç”¨æˆ·ï¼š${data.login}\né‚®ç®±ï¼š${data.email || 'æœªè®¾ç½®'}`);
                } else {
                    alert('è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥Tokenæ˜¯å¦æ­£ç¡®');
                }
            } catch (error) {
                alert('è¿æ¥å¤±è´¥ï¼š' + error.message);
            }
        }

        // åŒæ­¥åˆ°GitHubçš„ç®€åŒ–å‡½æ•°ï¼ˆç”¨äºå¯†ç ä¿®æ”¹ç­‰æ“ä½œï¼‰
        async function syncToGitHub() {
            const config = JSON.parse(localStorage.getItem('githubConfig') || '{}');
            if (!config.token || !config.gistId) {
                console.log('GitHubæœªé…ç½®ï¼Œè·³è¿‡è‡ªåŠ¨åŒæ­¥');
                return false;
            }
            
            try {
                // è·å–ç”¨æˆ·æ•°æ®
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                const systemInitialized = localStorage.getItem('systemInitialized') === 'true';
                
                const data = {
                    records: records,
                    rooms: rooms,
                    users: users,
                    systemInitialized: systemInitialized,
                    lastSync: new Date().toISOString()
                };
                
                // æ›´æ–°ç°æœ‰Gist
                const updateResponse = await fetch(`https://api.github.com/gists/${config.gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: {
                            'dormitory-data.json': {
                                content: JSON.stringify(data, null, 2)
                            }
                        }
                    })
                });
                
                if (!updateResponse.ok) {
                    throw new Error('æ›´æ–°Gistå¤±è´¥');
                }
                
                console.log('âœ… å¯†ç å·²è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯');
                return true;
            } catch (error) {
                console.error('è‡ªåŠ¨åŒæ­¥å¤±è´¥:', error);
                return false;
            }
        }

        async function syncData() {
            if (currentUser.role !== 'admin') {
                alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥åŒæ­¥æ•°æ®');
                return;
            }
            const config = JSON.parse(localStorage.getItem('githubConfig') || '{}');
            if (!config.token) {
                alert('è¯·å…ˆåœ¨ç³»ç»Ÿè®¾ç½®ä¸­é…ç½®GitHub Token');
                switchTab('settings');
                return;
            }
            
            updateSyncStatus('syncing', 'åŒæ­¥ä¸­...');
            
            try {
                // è·å–ç”¨æˆ·æ•°æ®
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                const systemInitialized = localStorage.getItem('systemInitialized') === 'true';
                
                const data = {
                    records: records,
                    rooms: rooms,
                    users: users,  // æ–°å¢ï¼šåŒæ­¥ç”¨æˆ·å¯†ç 
                    systemInitialized: systemInitialized,  // æ–°å¢ï¼šåŒæ­¥åˆå§‹åŒ–çŠ¶æ€
                    lastSync: new Date().toISOString()
                };
                
                let gistId = config.gistId;
                
                if (!gistId) {
                    // åˆ›å»ºæ–°çš„Gist
                    const createResponse = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            description: 'å®¿èˆç®¡ç†ç³»ç»Ÿæ•°æ®å¤‡ä»½',
                            public: false,
                            files: {
                                'dormitory-data.json': {
                                    content: JSON.stringify(data, null, 2)
                                }
                            }
                        })
                    });
                    
                    if (!createResponse.ok) {
                        throw new Error('åˆ›å»ºGistå¤±è´¥');
                    }
                    
                    const createData = await createResponse.json();
                    gistId = createData.id;
                    
                    // ä¿å­˜Gist ID
                    config.gistId = gistId;
                    localStorage.setItem('githubConfig', JSON.stringify(config));
                    document.getElementById('gistId').value = gistId;
                } else {
                    // æ›´æ–°ç°æœ‰Gist
                    const updateResponse = await fetch(`https://api.github.com/gists/${gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            files: {
                                'dormitory-data.json': {
                                    content: JSON.stringify(data, null, 2)
                                }
                            }
                        })
                    });
                    
                    if (!updateResponse.ok) {
                        throw new Error('æ›´æ–°Gistå¤±è´¥');
                    }
                }
                
                updateSyncStatus('success', 'åŒæ­¥æˆåŠŸ');
                setTimeout(() => updateSyncStatus('idle', 'å·²åŒæ­¥'), 2000);
            } catch (error) {
                console.error('åŒæ­¥å¤±è´¥:', error);
                updateSyncStatus('error', 'åŒæ­¥å¤±è´¥');
                alert('æ•°æ®åŒæ­¥å¤±è´¥ï¼š' + error.message);
            }
        }

        async function loadFromGitHub() {
            const config = JSON.parse(localStorage.getItem('githubConfig') || '{}');
            if (!config.token || !config.gistId) {
                return false;
            }
            
            try {
                const response = await fetch(`https://api.github.com/gists/${config.gistId}`, {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    return false;
                }
                
                const gist = await response.json();
                const fileContent = gist.files['dormitory-data.json'].content;
                const data = JSON.parse(fileContent);
                
                records = data.records || [];
                rooms = data.rooms || [];
                
                // æ¢å¤ç”¨æˆ·æ•°æ®å’Œåˆå§‹åŒ–çŠ¶æ€
                if (data.users) {
                    localStorage.setItem('users', JSON.stringify(data.users));
                }
                if (data.systemInitialized) {
                    localStorage.setItem('systemInitialized', 'true');
                }
                
                // åŒæ—¶ä¿å­˜åˆ°localStorageä½œä¸ºç¼“å­˜
                localStorage.setItem('dormRecords', JSON.stringify(records));
                localStorage.setItem('dormRooms', JSON.stringify(rooms));
                
                updateSyncStatus('success', 'å·²ä»äº‘ç«¯åŠ è½½');
                return true;
            } catch (error) {
                console.error('ä»GitHubåŠ è½½å¤±è´¥:', error);
                return false;
            }
        }

        async function loadUsersFromGitHub() {
            const config = JSON.parse(localStorage.getItem('githubConfig') || '{}');
            if (!config.token || !config.gistId) {
                return false;
            }
            
            try {
                const response = await fetch(`https://api.github.com/gists/${config.gistId}`, {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    return false;
                }
                
                const gist = await response.json();
                const fileContent = gist.files['dormitory-data.json'].content;
                const data = JSON.parse(fileContent);
                
                // åªæ¢å¤ç”¨æˆ·æ•°æ®å’Œåˆå§‹åŒ–çŠ¶æ€
                if (data.users && Object.keys(data.users).length > 0) {
                    localStorage.setItem('users', JSON.stringify(data.users));
                    localStorage.setItem('systemInitialized', 'true');
                    console.log('âœ… å·²ä»äº‘ç«¯åŠ è½½ç”¨æˆ·æ•°æ®');
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('ä»GitHubåŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                return false;
            }
        }

        function updateSyncStatus(status, text) {
            const indicator = document.getElementById('syncIndicator');
            const statusText = document.getElementById('syncStatusText');
            
            // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›ï¼ˆå¯èƒ½åœ¨ç™»å½•ç•Œé¢ï¼‰
            if (!indicator || !statusText) {
                return;
            }
            
            indicator.className = 'sync-indicator';
            if (status === 'syncing') {
                indicator.classList.add('syncing');
            } else if (status === 'error') {
                indicator.classList.add('error');
            }
            
            statusText.textContent = text;
        }

        // ========== æ•°æ®åŠ è½½ ==========
        async function loadData() {
            // å…ˆå°è¯•ä»GitHubåŠ è½½
            const loaded = await loadFromGitHub();
            
            // å¦‚æœGitHubåŠ è½½å¤±è´¥ï¼Œä»localStorageåŠ è½½
            if (!loaded) {
                records = JSON.parse(localStorage.getItem('dormRecords') || '[]');
                rooms = JSON.parse(localStorage.getItem('dormRooms') || '[]');
            }
            
            // åŠ è½½GitHubé…ç½®
            const config = JSON.parse(localStorage.getItem('githubConfig') || '{}');
            if (config.token) {
                document.getElementById('githubToken').value = config.token;
            }
            if (config.gistId) {
                document.getElementById('gistId').value = config.gistId;
            }
            githubConfig = config;
        }

        function switchTab(tabOrEvent, tab) {
            // å…¼å®¹ä¸¤ç§è°ƒç”¨æ–¹å¼ï¼šswitchTab('register') æˆ– switchTab(event, 'register')
            let targetTab;
            let sourceButton = null;
            
            if (typeof tabOrEvent === 'string') {
                // ç›´æ¥ä¼ å…¥tabåç§°
                targetTab = tabOrEvent;
                // ä¸ä¾èµ–window.eventï¼Œè€Œæ˜¯é€šè¿‡tabåç§°æ‰¾åˆ°æŒ‰é’®
            } else if (tabOrEvent && tabOrEvent.target) {
                // ä¼ å…¥eventå¯¹è±¡
                targetTab = tab;
                sourceButton = tabOrEvent.target;
            } else {
                // å®¹é”™å¤„ç†
                targetTab = tabOrEvent || tab;
            }
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeçŠ¶æ€
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            // éšè—æ‰€æœ‰å†…å®¹å¡ç‰‡ï¼ˆé™¤äº†ç‰¹æ®Šçš„ï¼‰
            document.querySelectorAll('.card').forEach(c => {
                // ä¸éšè—ç™»å½•å¡ç‰‡ã€ç”¨æˆ·ä¿¡æ¯æ å’Œå…¬å¸æŠ¬å¤´
                if (!c.classList.contains('login-card') && 
                    !c.classList.contains('user-info') && 
                    c.id !== 'companyHeader') {
                    c.classList.add('hidden');
                }
            });
            
            // è®¾ç½®å½“å‰æ ‡ç­¾ä¸ºactive
            if (sourceButton) {
                // å¦‚æœæœ‰æ˜ç¡®çš„æŒ‰é’®å…ƒç´ 
                sourceButton.classList.add('active');
            } else {
                // é€šè¿‡tabåç§°æ‰¾åˆ°å¯¹åº”æŒ‰é’®
                document.querySelectorAll('.tab').forEach(t => {
                    const onclick = t.getAttribute('onclick');
                    if (onclick && onclick.includes("'" + targetTab + "'")) {
                        t.classList.add('active');
                    }
                });
            }
            
            // æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹
            const tabElement = document.getElementById(targetTab + 'Tab');
            if (tabElement) {
                tabElement.classList.remove('hidden');
            }
            
            // ç‰¹å®šæ ‡ç­¾é¡µçš„åˆå§‹åŒ–æ“ä½œ
            if (targetTab === 'list') {
                clearSelection();
                updateDormFilterOptions();
                renderTable();
            }
            if (targetTab === 'checkout') {
                clearSelectionCheckout();
                renderCheckoutTable();
            }
            if (targetTab === 'rooms') {
                renderRooms();
                // æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤º/éšè—æ·»åŠ æˆ¿é—´æŒ‰é’®
                const addRoomBtn = document.querySelector('#roomsTab button.btn-primary');
                if (addRoomBtn) {
                    addRoomBtn.style.display = currentUser.role === 'admin' ? 'inline-block' : 'none';
                }
            }
            if (targetTab === 'floorplan') {
                renderFloorPlan();
            }
            if (targetTab === 'stats') {
                renderStats();
                renderRoomTypeStats();
                renderBedStats();
            }
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            const activeRecords = records.filter(r => !r.checkOutDate);
            const search = document.getElementById('search').value.toLowerCase();
            const dormFilter = document.getElementById('dormFilter').value;
            
            let filtered = activeRecords.filter(r => 
                r.name.toLowerCase().includes(search) || 
                r.idCard.includes(search) || 
                r.phone.includes(search)
            );
            
            // åº”ç”¨å®¿èˆç­›é€‰
            if (dormFilter) {
                filtered = filtered.filter(r => {
                    const dormKey = `${r.building || ''}-${r.room || ''}`;
                    return dormKey === dormFilter;
                });
            }
            
            if (selectAll) {
                filtered.forEach(r => selectedIds.add(r.id));
            } else {
                selectedIds.clear();
            }
            updateBatchActions();
            renderTable();
        }

        function toggleSelect(id) {
            if (selectedIds.has(id)) {
                selectedIds.delete(id);
            } else {
                selectedIds.add(id);
            }
            updateBatchActions();
            renderTable();
        }

        function updateBatchActions() {
            const count = selectedIds.size;
            document.getElementById('selectedCount').textContent = count;
            
            // æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤ºæ‰¹é‡æ“ä½œæŒ‰é’®
            const batchActionsDiv = document.getElementById('batchActions');
            if (count > 0) {
                batchActionsDiv.style.display = 'flex';
                // å¦‚æœæ˜¯viewerï¼Œéšè—æ‰¹é‡é€€å®¿å’Œæ‰¹é‡åˆ é™¤æŒ‰é’®
                if (currentUser.role === 'viewer') {
                    batchActionsDiv.innerHTML = `
                        <span class="selected-count">å·²é€‰æ‹© <span id="selectedCount">${count}</span> æ¡</span>
                        <button class="btn btn-secondary" onclick="clearSelection()">å–æ¶ˆé€‰æ‹©</button>
                        <span style="color:#999;margin-left:10px;">ä»…æŸ¥çœ‹æƒé™</span>
                    `;
                } else {
                    batchActionsDiv.innerHTML = `
                        <span class="selected-count">å·²é€‰æ‹© <span id="selectedCount">${count}</span> æ¡</span>
                        <button class="btn btn-warning" onclick="batchCheckout()">ğŸšª æ‰¹é‡é€€å®¿</button>
                        <button class="btn btn-danger" onclick="batchDelete()">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
                        <button class="btn btn-secondary" onclick="clearSelection()">å–æ¶ˆé€‰æ‹©</button>
                    `;
                }
            } else {
                batchActionsDiv.style.display = 'none';
            }
            
            const activeRecords = records.filter(r => !r.checkOutDate);
            const search = document.getElementById('search').value.toLowerCase();
            const dormFilter = document.getElementById('dormFilter').value;
            
            let filtered = activeRecords.filter(r => 
                r.name.toLowerCase().includes(search) || 
                r.idCard.includes(search) || 
                r.phone.includes(search)
            );
            
            // åº”ç”¨å®¿èˆç­›é€‰
            if (dormFilter) {
                filtered = filtered.filter(r => {
                    const dormKey = `${r.building || ''}-${r.room || ''}`;
                    return dormKey === dormFilter;
                });
            }
            
            const allSelected = filtered.length > 0 && filtered.every(r => selectedIds.has(r.id));
            document.getElementById('selectAll').checked = allSelected;
        }

        function clearSelection() {
            selectedIds.clear();
            updateBatchActions();
            renderTable();
        }

        function batchDelete() {
            // æ£€æŸ¥vieweræƒé™
            if (currentUser.role === 'viewer') {
                alert('æ‚¨æ²¡æœ‰æƒé™æ‰¹é‡åˆ é™¤è®°å½•');
                return;
            }
            
            if (selectedIds.size === 0) return;
            
            if (confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedIds.size} æ¡è®°å½•å—?åˆ é™¤åæ— æ³•æ¢å¤!`)) {
                records = records.filter(r => !selectedIds.has(r.id));
                localStorage.setItem('dormRecords', JSON.stringify(records));
                selectedIds.clear();
                updateBatchActions();
                renderTable();
                alert('æ‰¹é‡åˆ é™¤æˆåŠŸ!');
            }
        }

        function batchCheckout() {
            // æ£€æŸ¥vieweræƒé™
            if (currentUser.role === 'viewer') {
                alert('æ‚¨æ²¡æœ‰æƒé™æ‰¹é‡é€€å®¿');
                return;
            }
            
            if (selectedIds.size === 0) return;
            
            document.getElementById('batchCheckoutCount').textContent = selectedIds.size;
            document.getElementById('batchCheckoutReason').value = '';
            document.getElementById('batchCheckoutModal').classList.add('active');
        }

        function closeBatchCheckout() {
            document.getElementById('batchCheckoutModal').classList.remove('active');
        }

        function confirmBatchCheckout() {
            const reason = document.getElementById('batchCheckoutReason').value.trim();
            
            if (!reason) {
                alert('è¯·è¾“å…¥é€€å®¿åŸå› !');
                return;
            }

            const checkoutDate = new Date().toLocaleDateString();
            const count = selectedIds.size;
            
            // è·å–å½“å‰æ—¥æœŸçš„YYYY-MM-DDæ ¼å¼ï¼ˆç”¨äºç¦»èŒæ—¥æœŸå­—æ®µï¼‰
            const today = new Date();
            const resignDateFormat = today.getFullYear() + '-' + 
                                    String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                                    String(today.getDate()).padStart(2, '0');
            
            console.log('=== æ‰¹é‡é€€å®¿å¼€å§‹ ===');
            console.log('é€€å®¿æ—¥æœŸ:', checkoutDate);
            console.log('è‡ªåŠ¨å¡«å……çš„ç¦»èŒæ—¥æœŸæ ¼å¼:', resignDateFormat);
            
            records = records.map(r => {
                if (selectedIds.has(r.id)) {
                    // å¦‚æœæ²¡æœ‰ç¦»èŒæ—¥æœŸ,è‡ªåŠ¨è®¾ç½®ä¸ºä»Šå¤©çš„æ—¥æœŸï¼ˆYYYY-MM-DDæ ¼å¼ï¼‰
                    const resignDate = r.resignDate || resignDateFormat;
                    console.log(`å¤„ç†: ${r.name}, åŸç¦»èŒæ—¥æœŸ: ${r.resignDate || 'æ— '}, æ–°ç¦»èŒæ—¥æœŸ: ${resignDate}`);
                    return {...r, checkOutDate: checkoutDate, checkOutReason: reason, resignDate: resignDate};
                }
                return r;
            });

            localStorage.setItem('dormRecords', JSON.stringify(records));
            console.log('=== æ•°æ®å·²ä¿å­˜åˆ°localStorage ===');
            
            selectedIds.clear();
            updateBatchActions();
            renderTable();
            renderCheckoutTable(); // åŒæ—¶æ›´æ–°é€€å®¿äººå‘˜è¡¨æ ¼
            closeBatchCheckout();
            alert(`æ‰¹é‡é€€å®¿æˆåŠŸ! å…± ${count} äºº`);
        }

        function toggleSelectAllCheckout() {
            const selectAll = document.getElementById('selectAllCheckout').checked;
            const checkoutRecords = records.filter(r => r.checkOutDate);
            const search = document.getElementById('searchCheckout').value.toLowerCase();
            const filtered = checkoutRecords.filter(r => 
                r.name.toLowerCase().includes(search) || 
                r.idCard.includes(search) || 
                r.phone.includes(search)
            );
            
            if (selectAll) {
                filtered.forEach(r => selectedCheckoutIds.add(r.id));
            } else {
                selectedCheckoutIds.clear();
            }
            updateBatchActionsCheckout();
            renderCheckoutTable();
        }

        function toggleSelectCheckout(id) {
            if (selectedCheckoutIds.has(id)) {
                selectedCheckoutIds.delete(id);
            } else {
                selectedCheckoutIds.add(id);
            }
            updateBatchActionsCheckout();
            renderCheckoutTable();
        }

        function updateBatchActionsCheckout() {
            const count = selectedCheckoutIds.size;
            document.getElementById('selectedCountCheckout').textContent = count;
            
            // æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤ºæ‰¹é‡æ“ä½œæŒ‰é’®
            const batchActionsDiv = document.getElementById('batchActionsCheckout');
            if (count > 0) {
                batchActionsDiv.style.display = 'flex';
                // å¦‚æœæ˜¯viewerï¼Œéšè—æ‰¹é‡åˆ é™¤æŒ‰é’®
                if (currentUser.role === 'viewer') {
                    batchActionsDiv.innerHTML = `
                        <span class="selected-count">å·²é€‰æ‹© <span id="selectedCountCheckout">${count}</span> æ¡</span>
                        <button class="btn btn-secondary" onclick="clearSelectionCheckout()">å–æ¶ˆé€‰æ‹©</button>
                        <span style="color:#999;margin-left:10px;">ä»…æŸ¥çœ‹æƒé™</span>
                    `;
                } else {
                    batchActionsDiv.innerHTML = `
                        <span class="selected-count">å·²é€‰æ‹© <span id="selectedCountCheckout">${count}</span> æ¡</span>
                        <button class="btn btn-danger" onclick="batchDeleteCheckout()">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
                        <button class="btn btn-secondary" onclick="clearSelectionCheckout()">å–æ¶ˆé€‰æ‹©</button>
                    `;
                }
            } else {
                batchActionsDiv.style.display = 'none';
            }
            
            const checkoutRecords = records.filter(r => r.checkOutDate);
            const search = document.getElementById('searchCheckout').value.toLowerCase();
            const filtered = checkoutRecords.filter(r => 
                r.name.toLowerCase().includes(search) || 
                r.idCard.includes(search) || 
                r.phone.includes(search)
            );
            
            const allSelected = filtered.length > 0 && filtered.every(r => selectedCheckoutIds.has(r.id));
            document.getElementById('selectAllCheckout').checked = allSelected;
        }

        function clearSelectionCheckout() {
            selectedCheckoutIds.clear();
            updateBatchActionsCheckout();
            renderCheckoutTable();
        }

        function batchDeleteCheckout() {
            // æ£€æŸ¥vieweræƒé™
            if (currentUser.role === 'viewer') {
                alert('æ‚¨æ²¡æœ‰æƒé™æ‰¹é‡åˆ é™¤é€€å®¿äººå‘˜');
                return;
            }
            
            if (selectedCheckoutIds.size === 0) return;
            
            if (confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedCheckoutIds.size} æ¡é€€å®¿è®°å½•å—?åˆ é™¤åæ— æ³•æ¢å¤!`)) {
                records = records.filter(r => !selectedCheckoutIds.has(r.id));
                localStorage.setItem('dormRecords', JSON.stringify(records));
                selectedCheckoutIds.clear();
                updateBatchActionsCheckout();
                renderCheckoutTable();
                alert('æ‰¹é‡åˆ é™¤æˆåŠŸ!');
            }
        }

        function validateIdCard() {
            const id = document.getElementById('idCard').value.toUpperCase();
            document.getElementById('idCard').value = id;
            const err = document.getElementById('idError');
            const suc = document.getElementById('idSuccess');
            err.classList.add('hidden');
            suc.classList.add('hidden');

            if (id.length !== 18) {
                // æ¸…ç©ºæ€§åˆ«ã€å¹´é¾„ä¿¡æ¯
                if (id.length === 0) {
                    document.getElementById('gender').value = '';
                    document.getElementById('birthDate').value = '';
                    document.getElementById('age').value = '';
                }
                return;
            }

            if (!/^\d{17}[\dX]$/.test(id)) {
                err.textContent = 'èº«ä»½è¯å·æ ¼å¼é”™è¯¯';
                err.classList.remove('hidden');
                return;
            }

            const weights = [7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2];
            const codes = ['1','0','X','9','8','7','6','5','4','3','2'];
            let sum = 0;
            for (let i = 0; i < 17; i++) sum += parseInt(id[i]) * weights[i];
            if (id[17] !== codes[sum % 11]) {
                err.textContent = 'èº«ä»½è¯å·æ ¡éªŒç é”™è¯¯';
                err.classList.remove('hidden');
                return;
            }

            // å…ˆæå–æ€§åˆ«ã€å‡ºç”Ÿæ—¥æœŸå’Œå¹´é¾„ä¿¡æ¯
            const gender = parseInt(id[16]) % 2 === 1 ? 'ç”·' : 'å¥³';
            const year = parseInt(id.substring(6, 10));
            const month = id.substring(10, 12);
            const day = id.substring(12, 14);
            const birthDate = `${year}-${month}-${day}`;
            const age = new Date().getFullYear() - year;
            
            // è‡ªåŠ¨å¡«å……æ€§åˆ«ã€å‡ºç”Ÿæ—¥æœŸå’Œå¹´é¾„
            document.getElementById('gender').value = gender;
            document.getElementById('birthDate').value = birthDate;
            document.getElementById('age').value = age;

            // æ£€æŸ¥è¯¥èº«ä»½è¯å·çš„å†å²è®°å½•ï¼ˆåŒ…æ‹¬å·²é€€å®¿çš„ï¼‰
            const historyRecords = records.filter(r => r.idCard === id && r.id !== editingId);
            const checkoutRecords = historyRecords.filter(r => r.checkOutDate);
            
            // å¦‚æœæœ‰ç¦»èŒå†å²ï¼Œè‡ªåŠ¨åœ¨å¤‡æ³¨ä¸­æ·»åŠ ä¿¡æ¯
            if (checkoutRecords.length > 0) {
                let historyText = `ã€ç¦»èŒå†å²ã€‘æ›¾ç¦»èŒ${checkoutRecords.length}æ¬¡ï¼š`;
                checkoutRecords.forEach((record, index) => {
                    const resignDate = record.resignDate || record.checkOutDate || 'æœªè®°å½•';
                    const checkoutReason = record.checkOutReason ? ` (åŸå› ï¼š${record.checkOutReason})` : '';
                    historyText += `\n  ${index + 1}. ç¦»èŒæ—¥æœŸï¼š${resignDate}${checkoutReason}`;
                });
                
                // è·å–å½“å‰å¤‡æ³¨å†…å®¹
                const currentNotes = document.getElementById('notes').value.trim();
                
                // ç§»é™¤æ—§çš„ç¦»èŒå†å²ä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                let userNotes = currentNotes;
                if (currentNotes.includes('ã€ç¦»èŒå†å²ã€‘')) {
                    // æå–ç”¨æˆ·æ‰‹åŠ¨å¡«å†™çš„éƒ¨åˆ†ï¼ˆç¦»èŒå†å²ä¹‹åçš„å†…å®¹ï¼‰
                    const parts = currentNotes.split('ã€ç¦»èŒå†å²ã€‘');
                    if (parts.length > 1) {
                        const afterHistory = parts[1];
                        const nextSection = afterHistory.split(/\n\n[^\n]/);
                        if (nextSection.length > 1) {
                            // æ‰¾åˆ°ç¦»èŒå†å²åé¢çš„ç¬¬ä¸€ä¸ªåŒæ¢è¡Œï¼Œé‚£ä¹‹åçš„æ˜¯ç”¨æˆ·å¤‡æ³¨
                            const match = afterHistory.match(/\n\n(.+)/s);
                            userNotes = match ? match[1].trim() : '';
                        } else {
                            userNotes = '';
                        }
                    } else {
                        userNotes = parts[0].trim();
                    }
                }
                
                // ç»„åˆæ–°çš„å¤‡æ³¨å†…å®¹
                if (userNotes) {
                    document.getElementById('notes').value = historyText + '\n\n' + userNotes;
                } else {
                    document.getElementById('notes').value = historyText;
                }
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰åœ¨èŒè®°å½•ï¼ˆæœªé€€å®¿çš„ï¼‰
            const activeRecords = historyRecords.filter(r => !r.checkOutDate);
            if (activeRecords.length > 0) {
                err.textContent = 'è¯¥èº«ä»½è¯å·å·²ç™»è®°ï¼ˆå½“å‰åœ¨èŒï¼‰';
                err.classList.remove('hidden');
                return;
            }

            suc.textContent = checkoutRecords.length > 0 ? 
                `âœ“ éªŒè¯é€šè¿‡ï¼ˆæ£€æµ‹åˆ°${checkoutRecords.length}æ¬¡ç¦»èŒè®°å½•ï¼Œå·²è‡ªåŠ¨æ·»åŠ åˆ°å¤‡æ³¨ï¼‰` : 
                'âœ“ éªŒè¯é€šè¿‡';
            suc.classList.remove('hidden');
        }

        function handleSubmit(e) {
            e.preventDefault();
            
            // æƒé™æ£€æŸ¥
            if (currentUser && currentUser.role !== 'admin') {
                alert('åªæœ‰ç®¡ç†å‘˜æ‰èƒ½æ·»åŠ æˆ–ç¼–è¾‘äººå‘˜');
                return;
            }
            
            const data = {
                id: editingId || Date.now(),
                name: document.getElementById('name').value,
                idCard: document.getElementById('idCard').value,
                gender: document.getElementById('gender').value,
                birthDate: document.getElementById('birthDate').value,
                age: document.getElementById('age').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                ethnicity: document.getElementById('ethnicity').value,
                sourceUnit: document.getElementById('sourceUnit').value,
                department: document.getElementById('department').value,
                building: document.getElementById('building').value,
                room: document.getElementById('room').value,
                bed: document.getElementById('bed').value,
                checkInDate: document.getElementById('checkInDate').value,
                emergencyContact: document.getElementById('emergencyContact').value,
                emergencyPhone: document.getElementById('emergencyPhone').value,
                resignDate: document.getElementById('resignDate').value,
                handover: document.getElementById('handover').value,
                notes: document.getElementById('notes').value,
                recordTime: new Date().toLocaleString()
            };

            if (editingId) {
                records = records.map(r => r.id === editingId ? data : r);
                alert('ä¿®æ”¹æˆåŠŸ!');
            } else {
                records.push(data);
                alert('ä¿å­˜æˆåŠŸ!');
            }

            localStorage.setItem('dormRecords', JSON.stringify(records));
            resetForm();
        }

        function resetForm() {
            document.querySelector('form').reset();
            document.getElementById('gender').value = '';
            document.getElementById('birthDate').value = '';
            document.getElementById('age').value = '';
            document.getElementById('idError').classList.add('hidden');
            document.getElementById('idSuccess').classList.add('hidden');
            document.getElementById('cancelBtn').classList.add('hidden');
            document.getElementById('formTitle').textContent = 'æ–°å¢äººå‘˜ç™»è®°';
            editingId = null;
            
            // æ¢å¤è¡¨å•å­—æ®µçš„å¯ç”¨çŠ¶æ€å’Œæäº¤æŒ‰é’®æ˜¾ç¤º
            const formInputs = document.querySelectorAll('#registerForm input, #registerForm select, #registerForm textarea');
            formInputs.forEach(input => input.disabled = false);
            document.getElementById('submitBtn').style.display = 'inline-block';
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const search = document.getElementById('search').value.toLowerCase();
            const dormFilter = document.getElementById('dormFilter').value;
            const activeRecords = records.filter(r => !r.checkOutDate);
            
            let filtered = activeRecords.filter(r => 
                r.name.toLowerCase().includes(search) || 
                r.idCard.includes(search) || 
                r.phone.includes(search)
            );
            
            // åº”ç”¨å®¿èˆç­›é€‰
            if (dormFilter) {
                filtered = filtered.filter(r => {
                    const dormKey = `${r.building || ''}-${r.room || ''}`;
                    return dormKey === dormFilter;
                });
            }

            tbody.innerHTML = filtered.map((r, i) => `
                <tr>
                    <td>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" ${selectedIds.has(r.id) ? 'checked' : ''} onchange="toggleSelect(${r.id})">
                        </div>
                    </td>
                    <td>${i + 1}</td>
                    <td>${r.name}</td>
                    <td>${r.gender}</td>
                    <td>${r.age}</td>
                    <td>${r.phone}</td>
                    <td>${r.department || '-'}</td>
                    <td>${r.building || '-'}-${r.room || '-'}-${r.bed || '-'}</td>
                    <td>${r.checkInDate || '-'}</td>
                    <td>
                        ${currentUser.role === 'admin' ? `
                            <button class="btn btn-info" onclick="editRecord(${r.id})">ç¼–è¾‘</button>
                            <button class="btn btn-warning" onclick="checkout(${r.id})">é€€å®¿</button>
                            <button class="btn btn-danger" onclick="deleteRecord(${r.id})">åˆ é™¤</button>
                        ` : `
                            <button class="btn btn-info" onclick="editRecord(${r.id})">æŸ¥çœ‹</button>
                            <span style="color:#999;font-size:12px;">ä»…æŸ¥çœ‹æƒé™</span>
                        `}
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="10" style="text-align:center;padding:30px;color:#999;">æš‚æ— åœ¨ä½äººå‘˜</td></tr>';
            
            updateBatchActions();
        }

        function updateDormFilterOptions() {
            const dormFilter = document.getElementById('dormFilter');
            const activeRecords = records.filter(r => !r.checkOutDate);
            
            // è·å–æ‰€æœ‰å”¯ä¸€çš„å®¿èˆç»„åˆ
            const dormSet = new Set();
            activeRecords.forEach(r => {
                if (r.building && r.room) {
                    dormSet.add(`${r.building}-${r.room}`);
                }
            });
            
            // æŒ‰æ¥¼æ ‹å’Œæˆ¿é—´å·æ’åº
            const dormList = Array.from(dormSet).sort((a, b) => {
                const [buildingA, roomA] = a.split('-');
                const [buildingB, roomB] = b.split('-');
                if (buildingA !== buildingB) {
                    return buildingA.localeCompare(buildingB);
                }
                return parseInt(roomA) - parseInt(roomB);
            });
            
            // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
            const currentValue = dormFilter.value;
            
            // é‡æ–°ç”Ÿæˆé€‰é¡¹
            dormFilter.innerHTML = '<option value="">å…¨éƒ¨å®¿èˆ</option>';
            
            // æŒ‰æ¥¼æ ‹åˆ†ç»„
            const buildingGroups = {};
            dormList.forEach(dorm => {
                const [building, room] = dorm.split('-');
                if (!buildingGroups[building]) {
                    buildingGroups[building] = [];
                }
                buildingGroups[building].push(room);
            });
            
            // ç”Ÿæˆåˆ†ç»„çš„é€‰é¡¹
            Object.keys(buildingGroups).sort().forEach(building => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = building;
                
                buildingGroups[building].forEach(room => {
                    const option = document.createElement('option');
                    const dormKey = `${building}-${room}`;
                    option.value = dormKey;
                    
                    // ç»Ÿè®¡è¯¥å®¿èˆçš„äººæ•°
                    const count = activeRecords.filter(r => 
                        r.building === building && r.room === room
                    ).length;
                    
                    option.textContent = `${room}å·æˆ¿ (${count}äºº)`;
                    optgroup.appendChild(option);
                });
                
                dormFilter.appendChild(optgroup);
            });
            
            // æ¢å¤ä¹‹å‰çš„é€‰ä¸­å€¼ï¼ˆå¦‚æœè¿˜å­˜åœ¨ï¼‰
            if (dormList.includes(currentValue)) {
                dormFilter.value = currentValue;
            }
        }

        function renderCheckoutTable() {
            const tbody = document.getElementById('checkoutTableBody');
            const search = document.getElementById('searchCheckout').value.toLowerCase();
            const checkoutRecords = records.filter(r => r.checkOutDate);
            const filtered = checkoutRecords.filter(r => 
                r.name.toLowerCase().includes(search) || 
                r.idCard.includes(search) || 
                r.phone.includes(search)
            );

            tbody.innerHTML = filtered.map((r, i) => `
                <tr>
                    <td>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" ${selectedCheckoutIds.has(r.id) ? 'checked' : ''} onchange="toggleSelectCheckout(${r.id})">
                        </div>
                    </td>
                    <td>${i + 1}</td>
                    <td>${r.name}</td>
                    <td>${r.gender}</td>
                    <td>${r.phone}</td>
                    <td>${r.department || '-'}</td>
                    <td>${r.building || '-'}-${r.room || '-'}-${r.bed || '-'}</td>
                    <td>${r.checkInDate || '-'}</td>
                    <td>${r.checkOutDate || '-'}</td>
                    <td>${r.resignDate || '-'}</td>
                    <td>${r.handover || '-'}</td>
                    <td>${r.checkOutReason || '-'}</td>
                    <td>
                        <button class="btn btn-info" onclick="editRecord(${r.id})">æŸ¥çœ‹</button>
                        ${currentUser.role === 'admin' ? `
                            <button class="btn btn-danger" onclick="deleteRecord(${r.id})">åˆ é™¤</button>
                        ` : `
                            <span style="color:#999;font-size:12px;">ä»…æŸ¥çœ‹æƒé™</span>
                        `}
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="13" style="text-align:center;padding:30px;color:#999;">æš‚æ— é€€å®¿äººå‘˜</td></tr>';
            
            updateBatchActionsCheckout();
        }

        function filterCheckoutRecords() {
            renderCheckoutTable();
        }

        function filterRecords() {
            renderTable();
        }

        function editRecord(id) {
            const record = records.find(r => r.id === id);
            editingId = id;
            Object.keys(record).forEach(key => {
                const el = document.getElementById(key);
                if (el) el.value = record[key] || '';
            });
            
            // å…ˆè®¾ç½®æ¥¼æ ‹ï¼Œç„¶åæ›´æ–°æˆ¿é—´é€‰é¡¹
            if (record.building) {
                document.getElementById('building').value = record.building;
                updateRoomOptions();
                // è®¾ç½®æˆ¿é—´å·
                if (record.room) {
                    document.getElementById('room').value = record.room;
                }
            }
            
            // æ ¹æ®ç”¨æˆ·è§’è‰²è®¾ç½®æ ‡é¢˜å’Œè¡¨å•çŠ¶æ€
            if (currentUser.role === 'viewer') {
                document.getElementById('formTitle').textContent = 'æŸ¥çœ‹äººå‘˜ä¿¡æ¯ï¼ˆåªè¯»ï¼‰';
                // ç¦ç”¨æ‰€æœ‰è¡¨å•å­—æ®µ
                const formInputs = document.querySelectorAll('#personForm input, #personForm select, #personForm textarea');
                formInputs.forEach(input => input.disabled = true);
                // éšè—æäº¤æŒ‰é’®
                document.getElementById('submitBtn').style.display = 'none';
            } else {
                document.getElementById('formTitle').textContent = 'ç¼–è¾‘äººå‘˜ä¿¡æ¯';
                // å¯ç”¨æ‰€æœ‰è¡¨å•å­—æ®µ
                const formInputs = document.querySelectorAll('#personForm input, #personForm select, #personForm textarea');
                formInputs.forEach(input => input.disabled = false);
                // æ˜¾ç¤ºæäº¤æŒ‰é’®
                document.getElementById('submitBtn').style.display = 'inline-block';
            }
            
            document.getElementById('cancelBtn').classList.remove('hidden');
            switchTab('register');
        }

        function updateRoomOptions() {
            const buildingElement = document.getElementById('building');
            const roomSelect = document.getElementById('room');
            
            if (!buildingElement || !roomSelect) {
                return; // å…ƒç´ ä¸å­˜åœ¨æ—¶ç›´æ¥è¿”å›
            }
            
            const building = buildingElement.value;
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            roomSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æˆ¿é—´</option>';
            
            if (!building) {
                roomSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©æ¥¼æ ‹</option>';
                return;
            }
            
            // è·å–è¯¥æ¥¼æ ‹çš„æ‰€æœ‰æˆ¿é—´
            const buildingRooms = rooms.filter(r => r.building === building);
            
            if (buildingRooms.length === 0) {
                roomSelect.innerHTML = '<option value="">è¯¥æ¥¼æ ‹æš‚æ— æˆ¿é—´é…ç½®</option>';
                return;
            }
            
            // æŒ‰æˆ¿é—´å·æ’åº
            buildingRooms.sort((a, b) => {
                const numA = parseInt(a.room) || 0;
                const numB = parseInt(b.room) || 0;
                return numA - numB;
            });
            
            // æ·»åŠ æˆ¿é—´é€‰é¡¹
            buildingRooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room.room;
                option.textContent = `${room.room}å·æˆ¿ (${room.beds}åºŠä½)`;
                roomSelect.appendChild(option);
            });
        }

        function cancelEdit() {
            resetForm();
        }

        function deleteRecord(id) {
            // æ£€æŸ¥vieweræƒé™
            if (currentUser.role === 'viewer') {
                alert('æ‚¨æ²¡æœ‰æƒé™åˆ é™¤è®°å½•');
                return;
            }
            
            if (confirm('ç¡®å®šåˆ é™¤è¯¥è®°å½•å—?åˆ é™¤åæ— æ³•æ¢å¤!')) {
                records = records.filter(r => r.id !== id);
                localStorage.setItem('dormRecords', JSON.stringify(records));
                renderTable();
                renderCheckoutTable();
                alert('åˆ é™¤æˆåŠŸ!');
            }
        }

        function checkout(id) {
            // æ£€æŸ¥vieweræƒé™
            if (currentUser.role === 'viewer') {
                alert('æ‚¨æ²¡æœ‰æƒé™æ“ä½œé€€å®¿');
                return;
            }
            
            const reason = prompt('è¯·è¾“å…¥é€€å®¿åŸå› :');
            if (reason) {
                const checkoutDate = new Date().toLocaleDateString();
                
                // è·å–å½“å‰æ—¥æœŸçš„YYYY-MM-DDæ ¼å¼ï¼ˆç”¨äºç¦»èŒæ—¥æœŸå­—æ®µï¼‰
                const today = new Date();
                const resignDateFormat = today.getFullYear() + '-' + 
                                        String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                                        String(today.getDate()).padStart(2, '0');
                
                records = records.map(r => {
                    if (r.id === id) {
                        // å¦‚æœæ²¡æœ‰ç¦»èŒæ—¥æœŸï¼Œè‡ªåŠ¨è®¾ç½®ä¸ºä»Šå¤©çš„æ—¥æœŸï¼ˆYYYY-MM-DDæ ¼å¼ï¼‰
                        const resignDate = r.resignDate || resignDateFormat;
                        console.log(`å•ä¸ªé€€å®¿: ${r.name}, åŸç¦»èŒæ—¥æœŸ: ${r.resignDate || 'æ— '}, æ–°ç¦»èŒæ—¥æœŸ: ${resignDate}`);
                        return {...r, checkOutDate: checkoutDate, checkOutReason: reason, resignDate: resignDate};
                    }
                    return r;
                });
                
                localStorage.setItem('dormRecords', JSON.stringify(records));
                renderTable();
                renderCheckoutTable(); // åŒæ—¶æ›´æ–°é€€å®¿äººå‘˜è¡¨æ ¼
                alert('é€€å®¿ç™»è®°æˆåŠŸ!');
            }
        }

        function renderStats() {
            const active = records.filter(r => !r.checkOutDate);
            const buildings = [...new Set(records.map(r => r.building).filter(Boolean))];
            
            // è®¡ç®—æ€»æˆ¿é—´æ•°å’Œæ€»åºŠä½æ•°
            const totalRooms = rooms.length;
            const totalBeds = rooms.reduce((sum, room) => sum + (parseInt(room.beds) || 0), 0);
            
            // åˆ†åˆ«è®¡ç®—æ™®é€šæˆ¿é—´å’Œç®¡ç†äººå‘˜æˆ¿é—´çš„åºŠä½
            let totalBedsNormal = 0;
            let totalBedsManager = 0;
            
            rooms.forEach(room => {
                const beds = parseInt(room.beds) || 0;
                const isManagerRoom = (room.room && room.room.toString().includes('ç®¡ç†')) || 
                                     (room.notes && room.notes.includes('ç®¡ç†'));
                if (isManagerRoom) {
                    totalBedsManager += beds;
                } else {
                    totalBedsNormal += beds;
                }
            });
            
            // è®¡ç®—å·²å…¥ä½åºŠä½æ•°ï¼ˆåŒºåˆ†æ™®é€šå’Œç®¡ç†äººå‘˜ï¼‰
            let occupiedBedsNormal = 0;
            let occupiedBedsManager = 0;
            
            active.forEach(r => {
                if (!r.building || !r.room || !r.bed) return;
                
                // æŸ¥æ‰¾å¯¹åº”çš„æˆ¿é—´é…ç½®
                const room = rooms.find(rm => rm.building === r.building && rm.room === r.room);
                if (room) {
                    const isManagerRoom = (room.room && room.room.toString().includes('ç®¡ç†')) || 
                                         (room.notes && room.notes.includes('ç®¡ç†'));
                    if (isManagerRoom) {
                        occupiedBedsManager++;
                    } else {
                        occupiedBedsNormal++;
                    }
                } else {
                    // å¦‚æœæ‰¾ä¸åˆ°æˆ¿é—´é…ç½®ï¼Œé»˜è®¤å½’ä¸ºæ™®é€šæˆ¿é—´
                    occupiedBedsNormal++;
                }
            });
            
            const occupiedBedsCount = occupiedBedsNormal + occupiedBedsManager;
            const availableBedsNormal = totalBedsNormal - occupiedBedsNormal;
            const availableBedsManager = totalBedsManager - occupiedBedsManager;
            const availableBedsCount = availableBedsNormal + availableBedsManager;
            
            document.getElementById('total').textContent = records.length;
            document.getElementById('active').textContent = active.length;
            document.getElementById('checkout').textContent = records.length - active.length;
            document.getElementById('buildings').textContent = buildings.length;
            
            document.getElementById('totalRooms').textContent = totalRooms;
            document.getElementById('totalBeds').textContent = totalBeds;
            document.getElementById('occupiedBeds').textContent = occupiedBedsCount;
            document.getElementById('availableBeds').textContent = availableBedsCount;
            
            // æ›´æ–°ç»†åˆ†ç»Ÿè®¡
            document.getElementById('occupiedBedsNormal').textContent = occupiedBedsNormal;
            document.getElementById('occupiedBedsManager').textContent = occupiedBedsManager;
            document.getElementById('availableBedsNormal').textContent = availableBedsNormal;
            document.getElementById('availableBedsManager').textContent = availableBedsManager;
        }

        function renderRoomTypeStats() {
            const container = document.getElementById('roomTypeStatsContainer');
            const activeRecords = records.filter(r => !r.checkOutDate);
            
            // æŒ‰åºŠä½æ•°åˆ†ç±»æˆ¿é—´ï¼ˆåˆ†ä¸ºæ™®é€šæˆ¿é—´å’Œç®¡ç†äººå‘˜æˆ¿é—´ï¼‰
            const roomTypeStats = {};
            const managerRoomTypeStats = {};
            
            rooms.forEach(room => {
                const beds = parseInt(room.beds) || 0;
                let typeName = '';
                
                if (beds === 1) {
                    typeName = 'å•äººé—´';
                } else if (beds === 2) {
                    typeName = 'åŒäººé—´';
                } else if (beds === 3) {
                    typeName = 'ä¸‰äººé—´';
                } else if (beds === 4) {
                    typeName = 'å››äººé—´';
                } else if (beds >= 5) {
                    typeName = `${beds}äººé—´`;
                } else {
                    typeName = 'æœªé…ç½®';
                }
                
                // åˆ¤æ–­æ˜¯å¦ä¸ºç®¡ç†äººå‘˜æˆ¿é—´ï¼ˆæˆ¿é—´å·æˆ–å¤‡æ³¨åŒ…å«"ç®¡ç†"ï¼‰
                const isManagerRoom = (room.room && room.room.toString().includes('ç®¡ç†')) || 
                                     (room.notes && room.notes.includes('ç®¡ç†'));
                
                const targetStats = isManagerRoom ? managerRoomTypeStats : roomTypeStats;
                
                if (!targetStats[typeName]) {
                    targetStats[typeName] = {
                        count: 0,
                        totalBeds: 0,
                        occupiedBeds: 0,
                        fullyOccupied: 0,
                        beds: beds
                    };
                }
                
                targetStats[typeName].count++;
                targetStats[typeName].totalBeds += beds;
            });
            
            // ç»Ÿè®¡æ¯ä¸ªæˆ¿é—´çš„å…¥ä½æƒ…å†µ
            const roomOccupancy = {};
            activeRecords.forEach(r => {
                if (!r.building || !r.room || !r.bed) return;
                const key = `${r.building}-${r.room}`;
                roomOccupancy[key] = (roomOccupancy[key] || 0) + 1;
            });
            
            // è®¡ç®—å·²å…¥ä½åºŠä½å’Œä½æ»¡çš„æˆ¿é—´æ•°
            rooms.forEach(room => {
                const key = `${room.building}-${room.room}`;
                const occupied = roomOccupancy[key] || 0;
                const beds = parseInt(room.beds) || 0;
                
                let typeName = '';
                if (beds === 1) typeName = 'å•äººé—´';
                else if (beds === 2) typeName = 'åŒäººé—´';
                else if (beds === 3) typeName = 'ä¸‰äººé—´';
                else if (beds === 4) typeName = 'å››äººé—´';
                else if (beds >= 5) typeName = `${beds}äººé—´`;
                else typeName = 'æœªé…ç½®';
                
                // åˆ¤æ–­æ˜¯å¦ä¸ºç®¡ç†äººå‘˜æˆ¿é—´
                const isManagerRoom = (room.room && room.room.toString().includes('ç®¡ç†')) || 
                                     (room.notes && room.notes.includes('ç®¡ç†'));
                
                const targetStats = isManagerRoom ? managerRoomTypeStats : roomTypeStats;
                
                if (targetStats[typeName]) {
                    targetStats[typeName].occupiedBeds += occupied;
                    if (occupied >= beds && beds > 0) {
                        targetStats[typeName].fullyOccupied++;
                    }
                }
            });
            
            // ç”ŸæˆHTML - æ–°çš„å¡ç‰‡é£æ ¼
            let html = '';
            
            // æ™®é€šæˆ¿å‹ç»Ÿè®¡
            // è®¡ç®—æ™®é€šå®¿èˆçš„æ±‡æ€»æ•°æ®
            let normalTotalBeds = 0;
            let normalOccupiedBeds = 0;
            Object.keys(roomTypeStats).forEach(typeName => {
                normalTotalBeds += roomTypeStats[typeName].totalBeds;
                normalOccupiedBeds += roomTypeStats[typeName].occupiedBeds;
            });
            const normalAvailableBeds = normalTotalBeds - normalOccupiedBeds;
            const normalPercentage = normalTotalBeds > 0 ? (normalOccupiedBeds / normalTotalBeds * 100).toFixed(0) : 0;
            
            html += `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 8px 8px 0 0; font-size: 18px; font-weight: bold; margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                <span>æ™®é€šå®¿èˆ</span>
                <span style="font-size: 14px; opacity: 0.9;">
                    ${normalTotalBeds} æ€»åºŠä½ | ${normalOccupiedBeds} å·²å…¥ä½ | ${normalAvailableBeds} å‰©ä½™ | ${normalPercentage}% å…¥ä½ç‡
                </span>
            </div>`;
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; padding: 20px; background: #f5f5f5; border-radius: 0 0 8px 8px; margin-bottom: 20px;">';
            
            // æŒ‰åºŠä½æ•°æ’åº
            const sortedTypes = Object.keys(roomTypeStats).sort((a, b) => {
                return roomTypeStats[a].beds - roomTypeStats[b].beds;
            });
            
            sortedTypes.forEach(typeName => {
                const stat = roomTypeStats[typeName];
                const availableBeds = stat.totalBeds - stat.occupiedBeds;
                const percentage = stat.totalBeds > 0 ? (stat.occupiedBeds / stat.totalBeds * 100).toFixed(0) : 0;
                
                // ç¡®å®šçŠ¶æ€å’Œé¢œè‰²
                let statusClass = 'empty';
                let statusBadge = 'ç©ºæˆ¿';
                let borderColor = '#4CAF50';
                let bgColor = '#e8f5e9';
                
                if (percentage >= 100) {
                    statusClass = 'full';
                    statusBadge = 'å·²æ»¡';
                    borderColor = '#f44336';
                    bgColor = '#ffebee';
                } else if (percentage >= 50) {
                    statusClass = 'partial';
                    statusBadge = 'éƒ¨åˆ†';
                    borderColor = '#FF9800';
                    bgColor = '#fff3e0';
                }
                
                html += `
                    <div style="background: white; border-radius: 8px; padding: 15px; border: 2px solid ${borderColor}; background: ${bgColor}; position: relative;">
                        <div style="position: absolute; top: 10px; right: 10px; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; color: white; background: ${borderColor};">${statusBadge}</div>
                        <div style="font-size: 20px; font-weight: bold; color: #333; margin-bottom: 10px;">${typeName}</div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                            æˆ¿é—´æ•°: <strong style="color: #333;">${stat.count}</strong> é—´
                        </div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                            æ€»åºŠä½: <strong style="color: #333;">${stat.totalBeds}</strong> å¼ 
                        </div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                            å·²å…¥ä½: <strong style="color: #f44336;">${stat.occupiedBeds}</strong> å¼ 
                        </div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                            ç©ºåºŠä½: <strong style="color: #4CAF50;">${availableBeds}</strong> å¼ 
                        </div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                            ä½æ»¡æˆ¿é—´: <strong style="color: #FF9800;">${stat.fullyOccupied}</strong> é—´
                        </div>
                        <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-top: 10px;">
                            <div style="height: 100%; background: linear-gradient(90deg, #4CAF50, #2196F3); width: ${percentage}%;"></div>
                        </div>
                        <div style="text-align: right; font-size: 12px; color: #666; margin-top: 5px;">åºŠä½ä½¿ç”¨ç‡: ${percentage}%</div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // ç®¡ç†äººå‘˜æˆ¿å‹ç»Ÿè®¡
            const sortedManagerTypes = Object.keys(managerRoomTypeStats).sort((a, b) => {
                return managerRoomTypeStats[a].beds - managerRoomTypeStats[b].beds;
            });
            
            if (sortedManagerTypes.length > 0) {
                // è®¡ç®—ç®¡ç†äººå‘˜å®¿èˆçš„æ±‡æ€»æ•°æ®
                let managerTotalBeds = 0;
                let managerOccupiedBeds = 0;
                Object.keys(managerRoomTypeStats).forEach(typeName => {
                    managerTotalBeds += managerRoomTypeStats[typeName].totalBeds;
                    managerOccupiedBeds += managerRoomTypeStats[typeName].occupiedBeds;
                });
                const managerAvailableBeds = managerTotalBeds - managerOccupiedBeds;
                const managerPercentage = managerTotalBeds > 0 ? (managerOccupiedBeds / managerTotalBeds * 100).toFixed(0) : 0;
                
                html += `<div style="background: linear-gradient(135deg, #9C27B0 0%, #E1BEE7 100%); color: white; padding: 15px 20px; border-radius: 8px 8px 0 0; font-size: 18px; font-weight: bold; margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <span>ç®¡ç†äººå‘˜å®¿èˆ</span>
                    <span style="font-size: 14px; opacity: 0.9;">
                        ${managerTotalBeds} æ€»åºŠä½ | ${managerOccupiedBeds} å·²å…¥ä½ | ${managerAvailableBeds} å‰©ä½™ | ${managerPercentage}% å…¥ä½ç‡
                    </span>
                </div>`;
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; padding: 20px; background: #f5f5f5; border-radius: 0 0 8px 8px; margin-bottom: 20px;">';
                
                sortedManagerTypes.forEach(typeName => {
                    const stat = managerRoomTypeStats[typeName];
                    const availableBeds = stat.totalBeds - stat.occupiedBeds;
                    const percentage = stat.totalBeds > 0 ? (stat.occupiedBeds / stat.totalBeds * 100).toFixed(0) : 0;
                    
                    // ç¡®å®šçŠ¶æ€å’Œé¢œè‰²
                    let statusClass = 'empty';
                    let statusBadge = 'ç©ºæˆ¿';
                    let borderColor = '#4CAF50';
                    let bgColor = '#f3e5f5';
                    
                    if (percentage >= 100) {
                        statusClass = 'full';
                        statusBadge = 'å·²æ»¡';
                        borderColor = '#9C27B0';
                        bgColor = '#f3e5f5';
                    } else if (percentage >= 50) {
                        statusClass = 'partial';
                        statusBadge = 'éƒ¨åˆ†';
                        borderColor = '#BA68C8';
                        bgColor = '#f3e5f5';
                    }
                    
                    html += `
                        <div style="background: white; border-radius: 8px; padding: 15px; border: 2px solid ${borderColor}; background: ${bgColor}; position: relative;">
                            <div style="position: absolute; top: 10px; right: 10px; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; color: white; background: ${borderColor};">${statusBadge}</div>
                            <div style="font-size: 20px; font-weight: bold; color: #333; margin-bottom: 10px;">${typeName} <span style="font-size: 12px; color: #9C27B0;">(ç®¡ç†)</span></div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                æˆ¿é—´æ•°: <strong style="color: #333;">${stat.count}</strong> é—´
                            </div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                æ€»åºŠä½: <strong style="color: #333;">${stat.totalBeds}</strong> å¼ 
                            </div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                å·²å…¥ä½: <strong style="color: #9C27B0;">${stat.occupiedBeds}</strong> å¼ 
                            </div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                ç©ºåºŠä½: <strong style="color: #4CAF50;">${availableBeds}</strong> å¼ 
                            </div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                                ä½æ»¡æˆ¿é—´: <strong style="color: #9C27B0;">${stat.fullyOccupied}</strong> é—´
                            </div>
                            <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-top: 10px;">
                                <div style="height: 100%; background: linear-gradient(90deg, #9C27B0, #E1BEE7); width: ${percentage}%;"></div>
                            </div>
                            <div style="text-align: right; font-size: 12px; color: #666; margin-top: 5px;">åºŠä½ä½¿ç”¨ç‡: ${percentage}%</div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            if (sortedTypes.length === 0 && sortedManagerTypes.length === 0) {
                html = '<p style="text-align:center;color:#999;padding:30px;">æš‚æ— æˆ¿å‹æ•°æ®,è¯·å…ˆåœ¨"æˆ¿é—´ç®¡ç†"ä¸­æ·»åŠ æˆ¿é—´é…ç½®</p>';
            }
            
            container.innerHTML = html;
        }

        function renderBedStats() {
            const container = document.getElementById('bedStatsContainer');
            const activeRecords = records.filter(r => !r.checkOutDate);
            
            // ä½¿ç”¨æˆ¿é—´é…ç½®æ•°æ®
            const buildingStats = {};
            
            // é¦–å…ˆä»æˆ¿é—´é…ç½®ä¸­åˆå§‹åŒ–æ•°æ®
            rooms.forEach(room => {
                if (!buildingStats[room.building]) {
                    buildingStats[room.building] = {};
                }
                buildingStats[room.building][room.room] = {
                    totalBeds: parseInt(room.beds) || 0,
                    occupiedBeds: 0,
                    notes: room.notes || ''
                };
            });
            
            // ç„¶åç»Ÿè®¡å®é™…å…¥ä½æƒ…å†µ
            activeRecords.forEach(r => {
                if (!r.building || !r.room || !r.bed) return;
                
                if (!buildingStats[r.building]) {
                    buildingStats[r.building] = {};
                }
                
                if (!buildingStats[r.building][r.room]) {
                    // å¦‚æœæˆ¿é—´é…ç½®ä¸­æ²¡æœ‰è¿™ä¸ªæˆ¿é—´ï¼ŒåŠ¨æ€åˆ›å»º
                    buildingStats[r.building][r.room] = {
                        totalBeds: 0,
                        occupiedBeds: 0,
                        notes: 'æœªé…ç½®'
                    };
                }
                
                buildingStats[r.building][r.room].occupiedBeds++;
                
                // å¦‚æœå®é™…å…¥ä½è¶…è¿‡é…ç½®çš„åºŠä½æ•°ï¼Œè‡ªåŠ¨æ›´æ–°æ€»åºŠä½æ•°
                const currentOccupied = buildingStats[r.building][r.room].occupiedBeds;
                const currentTotal = buildingStats[r.building][r.room].totalBeds;
                if (currentOccupied > currentTotal) {
                    buildingStats[r.building][r.room].totalBeds = currentOccupied;
                }
            });
            
            // ç”ŸæˆHTML - å¹³é¢å›¾å¡ç‰‡é£æ ¼
            let html = '';
            
            Object.keys(buildingStats).sort().forEach(building => {
                const roomsData = buildingStats[building];
                let buildingTotal = 0;
                let buildingOccupied = 0;
                let buildingAvailable = 0;
                
                // å…ˆè®¡ç®—æ±‡æ€»æ•°æ®
                Object.keys(roomsData).forEach(room => {
                    const roomData = roomsData[room];
                    buildingTotal += roomData.totalBeds;
                    buildingOccupied += roomData.occupiedBeds;
                });
                buildingAvailable = buildingTotal - buildingOccupied;
                const buildingPercentage = buildingTotal > 0 ? (buildingOccupied / buildingTotal * 100).toFixed(0) : 0;
                
                // æ¥¼æ ‹æ ‡é¢˜å’Œæ±‡æ€»
                html += `
                    <div style="margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 8px 8px 0 0; font-size: 18px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
                            <span>${building}</span>
                            <span style="font-size: 14px; opacity: 0.9;">
                                ${buildingTotal} æ€»åºŠä½ | ${buildingOccupied} å·²å…¥ä½ | ${buildingAvailable} å‰©ä½™ | ${buildingPercentage}% å…¥ä½ç‡
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; padding: 20px; background: #f5f5f5; border-radius: 0 0 8px 8px;">
                `;
                
                // ç”Ÿæˆæˆ¿é—´å¡ç‰‡
                Object.keys(roomsData).sort((a, b) => {
                    if (building === 'åŠå…¬ä¸‰æ¥¼') {
                        // åŠå…¬ä¸‰æ¥¼ç‰¹æ®Šæ’åºï¼šåŒ—ä¾§æˆ¿é—´ä»å°åˆ°å¤§ï¼Œå—ä¾§æˆ¿é—´ä»å°åˆ°å¤§
                        const isNorthA = a.includes('åŒ—');
                        const isNorthB = b.includes('åŒ—');
                        const numA = parseInt(a.match(/\d+/)?.[0]) || 0;
                        const numB = parseInt(b.match(/\d+/)?.[0]) || 0;
                        
                        // å¦‚æœéƒ½æ˜¯åŒ—ä¾§æˆ–éƒ½æ˜¯å—ä¾§ï¼ŒæŒ‰ç…§ä»å°åˆ°å¤§æ’åº
                        if (isNorthA && isNorthB) {
                            return numA - numB; // åŒ—ä¾§ï¼šä»å°åˆ°å¤§
                        } else if (!isNorthA && !isNorthB) {
                            return numA - numB; // å—ä¾§ï¼šä»å°åˆ°å¤§
                        } else {
                            // åŒ—ä¾§æ’åœ¨å‰é¢
                            return isNorthA ? -1 : 1;
                        }
                    } else {
                        // å…¶ä»–æ¥¼æ ‹æŒ‰ä»å°åˆ°å¤§æ’åº
                        const numA = parseInt(a) || 0;
                        const numB = parseInt(b) || 0;
                        return numA - numB;
                    }
                }).forEach(room => {
                    const roomData = roomsData[room];
                    const total = roomData.totalBeds;
                    const occupied = roomData.occupiedBeds;
                    const available = total - occupied;
                    const percentage = total > 0 ? (occupied / total * 100).toFixed(0) : 0;
                    
                    // ç¡®å®šæˆ¿é—´çŠ¶æ€
                    let status = 'empty';
                    let statusText = 'ç©ºæˆ¿';
                    let statusBadge = 'ç©ºæˆ¿';
                    let borderColor = '#4CAF50';
                    let bgColor = '#e8f5e9';
                    
                    if (occupied >= total && total > 0) {
                        status = 'full';
                        statusText = 'å·²æ»¡';
                        statusBadge = 'å·²æ»¡';
                        borderColor = '#f44336';
                        bgColor = '#ffebee';
                    } else if (occupied > 0) {
                        status = 'partial';
                        statusText = 'éƒ¨åˆ†å…¥ä½';
                        statusBadge = 'éƒ¨åˆ†';
                        borderColor = '#FF9800';
                        bgColor = '#fff3e0';
                    }
                    
                    html += `
                        <div style="background: white; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.3s; border: 2px solid ${borderColor}; background: ${bgColor}; position: relative;" 
                             onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)';"
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                             onclick="showRoomDetail('${building}', '${room}')">
                            <div style="position: absolute; top: 10px; right: 10px; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; color: white; background: ${borderColor};">${statusBadge}</div>
                            <div style="font-size: 20px; font-weight: bold; color: #333; margin-bottom: 10px;">${room}å·æˆ¿</div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 8px;">${statusText}</div>
                            <div style="font-size: 12px; color: #999;">
                                å·²å…¥ä½: <strong style="color: #f44336;">${occupied}</strong> / 
                                æ€»åºŠä½: <strong>${total}</strong>
                            </div>
                            ${roomData.notes && roomData.notes !== 'æœªé…ç½®' ? `<div style="font-size: 11px; color: #999; margin-top: 5px;">${roomData.notes}</div>` : ''}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<p style="text-align:center;color:#999;padding:30px;">æš‚æ— åºŠä½æ•°æ®,è¯·å…ˆåœ¨"æˆ¿é—´ç®¡ç†"ä¸­æ·»åŠ æˆ¿é—´é…ç½®</p>';
            }
            
            container.innerHTML = html;
        }

        // è‡ªåŠ¨è°ƒæ•´Excelåˆ—å®½çš„è¾…åŠ©å‡½æ•°
        function autoFitColumns(worksheet) {
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            const colWidths = [];
            
            // éå†æ¯ä¸€åˆ—
            for (let C = range.s.c; C <= range.e.c; ++C) {
                let maxWidth = 10; // æœ€å°å®½åº¦
                
                // éå†è¯¥åˆ—çš„æ‰€æœ‰è¡Œ
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                    const cell = worksheet[cellAddress];
                    
                    if (cell && cell.v) {
                        const cellValue = cell.v.toString();
                        // è®¡ç®—å­—ç¬¦å®½åº¦ï¼ˆä¸­æ–‡å­—ç¬¦ç®—2ä¸ªå®½åº¦ï¼Œè‹±æ–‡ç®—1ä¸ªï¼‰
                        let width = 0;
                        for (let i = 0; i < cellValue.length; i++) {
                            const charCode = cellValue.charCodeAt(i);
                            // ä¸­æ–‡å­—ç¬¦èŒƒå›´
                            if (charCode >= 0x4e00 && charCode <= 0x9fa5) {
                                width += 2.2; // ä¸­æ–‡å­—ç¬¦
                            } else {
                                width += 1.1; // è‹±æ–‡ã€æ•°å­—ç­‰
                            }
                        }
                        maxWidth = Math.max(maxWidth, width);
                    }
                }
                
                // è®¾ç½®åˆ—å®½ï¼Œæœ€å¤§ä¸è¶…è¿‡50
                colWidths.push({ wch: Math.min(maxWidth, 50) });
            }
            
            worksheet['!cols'] = colWidths;
        }

        function exportExcel() {
            if (currentUser.role !== 'admin') {
                alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥å¯¼å‡ºæ•°æ®');
                return;
            }
            const wb = XLSX.utils.book_new();
            
            // 1. åœ¨èŒäººå‘˜
            const activeRecords = records.filter(r => !r.checkOutDate);
            if (activeRecords.length > 0) {
                const ws1 = XLSX.utils.json_to_sheet(activeRecords.map((r, i) => ({
                    åºå·: i + 1,
                    å§“å: r.name,
                    èº«ä»½è¯å·: r.idCard,
                    æ€§åˆ«: r.gender,
                    å‡ºç”Ÿæ—¥æœŸ: r.birthDate,
                    å¹´é¾„: r.age,
                    ç”µè¯: r.phone,
                    åœ°å€: r.address,
                    æ°‘æ—: r.ethnicity,
                    æ¥æºå•ä½: r.sourceUnit,
                    éƒ¨é—¨: r.department,
                    æ¥¼æ ‹: r.building,
                    æˆ¿é—´: r.room,
                    åºŠä½: r.bed,
                    å…¥ä½æ—¥æœŸ: r.checkInDate,
                    ç´§æ€¥è”ç³»äºº: r.emergencyContact,
                    ç´§æ€¥ç”µè¯: r.emergencyPhone,
                    ç¦»èŒæ—¥æœŸ: r.resignDate,
                    äº¤å‰²æ‰‹ç»­: r.handover,
                    å¤‡æ³¨: r.notes,
                    ç™»è®°æ—¶é—´: r.recordTime
                })));
                autoFitColumns(ws1);
                // è®¾ç½®å†»ç»“é¦–è¡Œ
                ws1['!freeze'] = { xSplit: 0, ySplit: 1 };
                XLSX.utils.book_append_sheet(wb, ws1, 'åœ¨èŒäººå‘˜');
            }
            
            // 2. é€€å®¿äººå‘˜
            const checkoutRecords = records.filter(r => r.checkOutDate);
            if (checkoutRecords.length > 0) {
                const ws2 = XLSX.utils.json_to_sheet(checkoutRecords.map((r, i) => ({
                    åºå·: i + 1,
                    å§“å: r.name,
                    èº«ä»½è¯å·: r.idCard,
                    æ€§åˆ«: r.gender,
                    å‡ºç”Ÿæ—¥æœŸ: r.birthDate,
                    å¹´é¾„: r.age,
                    ç”µè¯: r.phone,
                    åœ°å€: r.address,
                    æ°‘æ—: r.ethnicity,
                    æ¥æºå•ä½: r.sourceUnit,
                    éƒ¨é—¨: r.department,
                    æ¥¼æ ‹: r.building,
                    æˆ¿é—´: r.room,
                    åºŠä½: r.bed,
                    å…¥ä½æ—¥æœŸ: r.checkInDate,
                    é€€å®¿æ—¥æœŸ: r.checkOutDate,
                    é€€å®¿åŸå› : r.checkOutReason,
                    ç¦»èŒæ—¥æœŸ: r.resignDate,
                    äº¤å‰²æ‰‹ç»­: r.handover,
                    ç´§æ€¥è”ç³»äºº: r.emergencyContact,
                    ç´§æ€¥ç”µè¯: r.emergencyPhone,
                    å¤‡æ³¨: r.notes,
                    ç™»è®°æ—¶é—´: r.recordTime
                })));
                autoFitColumns(ws2);
                // è®¾ç½®å†»ç»“é¦–è¡Œ
                ws2['!freeze'] = { xSplit: 0, ySplit: 1 };
                XLSX.utils.book_append_sheet(wb, ws2, 'é€€å®¿äººå‘˜');
            }
            
            // 3. æˆ¿é—´ç®¡ç†
            if (rooms.length > 0) {
                const ws3 = XLSX.utils.json_to_sheet(rooms.map((r, i) => ({
                    åºå·: i + 1,
                    æ¥¼æ ‹: r.building,
                    æˆ¿é—´å·: r.room,
                    åºŠä½æ•°: r.beds,
                    å¤‡æ³¨: r.notes || ''
                })));
                autoFitColumns(ws3);
                // è®¾ç½®å†»ç»“é¦–è¡Œ
                ws3['!freeze'] = { xSplit: 0, ySplit: 1 };
                XLSX.utils.book_append_sheet(wb, ws3, 'æˆ¿é—´ç®¡ç†');
            }
            
            if (activeRecords.length === 0 && checkoutRecords.length === 0 && rooms.length === 0) {
                return alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
            }
            
            XLSX.writeFile(wb, 'ä½å®¿äººå‘˜ç®¡ç†_' + new Date().toLocaleDateString('zh-CN').replace(/\//g, '-') + '.xlsx');
        }

        function showImport() {
            if (currentUser.role !== 'admin') {
                alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥å¯¼å…¥æ•°æ®');
                return;
            }
            document.getElementById('importModal').classList.add('active');
        }

        function closeImport() {
            document.getElementById('importModal').classList.remove('active');
        }

        function exportCheckoutExcel() {
            if (currentUser.role !== 'admin') {
                alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥å¯¼å‡ºæ•°æ®');
                return;
            }
            const checkoutRecords = records.filter(r => r.checkOutDate);
            
            if (checkoutRecords.length === 0) {
                alert('æš‚æ— é€€å®¿äººå‘˜æ•°æ®');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(checkoutRecords.map((r, i) => ({
                åºå·: i + 1,
                å§“å: r.name,
                èº«ä»½è¯å·: r.idCard,
                æ€§åˆ«: r.gender,
                å‡ºç”Ÿæ—¥æœŸ: r.birthDate,
                å¹´é¾„: r.age,
                ç”µè¯: r.phone,
                åœ°å€: r.address,
                æ°‘æ—: r.ethnicity,
                æ¥æºå•ä½: r.sourceUnit,
                éƒ¨é—¨: r.department,
                åŸæ¥¼æ ‹: r.building,
                åŸæˆ¿é—´: r.room,
                åŸåºŠä½: r.bed,
                å…¥ä½æ—¥æœŸ: r.checkInDate,
                é€€å®¿æ—¥æœŸ: r.checkOutDate,
                é€€å®¿åŸå› : r.checkOutReason,
                ç¦»èŒæ—¥æœŸ: r.resignDate,
                äº¤å‰²æ‰‹ç»­: r.handover,
                ç´§æ€¥è”ç³»äºº: r.emergencyContact,
                ç´§æ€¥ç”µè¯: r.emergencyPhone,
                å¤‡æ³¨: r.notes,
                ç™»è®°æ—¶é—´: r.recordTime
            })));
            
            autoFitColumns(ws); // è‡ªåŠ¨è°ƒæ•´åˆ—å®½
            // è®¾ç½®å†»ç»“é¦–è¡Œ
            ws['!freeze'] = { xSplit: 0, ySplit: 1 };
            XLSX.utils.book_append_sheet(wb, ws, 'é€€å®¿äººå‘˜');
            XLSX.writeFile(wb, 'é€€å®¿äººå‘˜ç™»è®°è¡¨_' + new Date().toLocaleDateString('zh-CN').replace(/\//g, '-') + '.xlsx');
        }

        function showImportCheckout() {
            if (currentUser.role !== 'admin') {
                alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥å¯¼å…¥æ•°æ®');
                return;
            }
            document.getElementById('importCheckoutModal').classList.add('active');
        }

        function closeImportCheckout() {
            document.getElementById('importCheckoutModal').classList.remove('active');
        }

        function handleImportCheckout(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, {type: 'array'});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws, {raw: false, defval: ''});
                    
                    if (json.length === 0) {
                        alert('Excelæ–‡ä»¶ä¸ºç©º!');
                        return;
                    }
                    
                    let success = 0;
                    let error = 0;
                    let errorDetails = [];
                    
                    const formatDate = (dateValue) => {
                        if (!dateValue || dateValue === '') return '';
                        
                        let date;
                        if (typeof dateValue === 'string') {
                            dateValue = dateValue.trim();
                            
                            if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(dateValue)) {
                                date = new Date(dateValue);
                            }
                            else if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(dateValue)) {
                                date = new Date(dateValue.replace(/\//g, '-'));
                            }
                            else if (/^\d{4}\.\d{1,2}\.\d{1,2}$/.test(dateValue)) {
                                const parts = dateValue.split('.');
                                date = new Date(`${parts[0]}-${parts[1]}-${parts[2]}`);
                            }
                            else if (/^\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥?$/.test(dateValue)) {
                                const matches = dateValue.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})/);
                                if (matches) {
                                    date = new Date(matches[1], matches[2] - 1, matches[3]);
                                }
                            }
                            else {
                                date = new Date(dateValue);
                            }
                        }
                        else if (dateValue instanceof Date) {
                            date = dateValue;
                        }
                        
                        if (!date || isNaN(date.getTime())) {
                            return dateValue;
                        }
                        
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        
                        return `${year}-${month}-${day}`;
                    }
                    
                    json.forEach((row, index) => {
                        const getName = (names) => {
                            for (let name of names) {
                                const value = row[name];
                                if (value !== undefined && value !== null && value !== '') {
                                    return value;
                                }
                            }
                            return '';
                        };
                        
                        let idCard = getName([
                            'èº«ä»½è¯å·', 'èº«ä»½è¯å·ç ', 'èº«ä»½è¯', 'ID', 'idCard', 
                            'è¯ä»¶å·', 'è¯ä»¶å·ç ', 'èº«ä»½è¯ å·ç ', 'èº«ä»½è¯ å·',
                            'ID Card', 'IdCard', 'IDCARD', 'èº«ä»½è¯ä»¶å·ç '
                        ]);
                        
                        if (idCard) {
                            idCard = String(idCard);
                            idCard = idCard.replace(/[\s\n\r\t]/g, '');
                            idCard = idCard.toUpperCase();
                            
                            if (idCard.includes('E+') || idCard.includes('e+')) {
                                try {
                                    const num = parseFloat(idCard);
                                    idCard = num.toFixed(0);
                                } catch (err) {
                                    idCard = '';
                                }
                            }
                        }
                        
                        // é€€å®¿äººå‘˜å¯¼å…¥å…è®¸èº«ä»½è¯å·é‡å¤ï¼Œå·²ç§»é™¤é‡å¤æ£€æŸ¥
                        
                        let gender = getName(['æ€§åˆ«', 'gender', 'ç”·å¥³']) || '';
                        let age = getName(['å¹´é¾„', 'age'])?.toString() || '';
                        let birthDate = getName(['å‡ºç”Ÿæ—¥æœŸ', 'ç”Ÿæ—¥', 'birthDate', 'å‡ºç”Ÿ']) || '';
                        
                        if (idCard && idCard.length === 18 && /^\d{17}[\dX]$/.test(idCard)) {
                            const genderCode = parseInt(idCard.charAt(16));
                            gender = genderCode % 2 === 1 ? 'ç”·' : 'å¥³';
                            const year = parseInt(idCard.substring(6, 10));
                            const month = idCard.substring(10, 12);
                            const day = idCard.substring(12, 14);
                            birthDate = `${year}-${month}-${day}`;
                            age = (new Date().getFullYear() - year).toString();
                        }
                        
                        let phone = getName(['ç”µè¯', 'è”ç³»ç”µè¯', 'æ‰‹æœºå·', 'phone', 'æ‰‹æœº', 'è”ç³»æ–¹å¼']);
                        if (phone) {
                            phone = String(phone).replace(/[\s\n\r\t]/g, '');
                        }
                        
                        const checkOutDate = formatDate(getName(['é€€å®¿æ—¥æœŸ', 'é€€å®¿æ—¶é—´', 'checkOutDate', 'é€€å®¿']));
                        
                        // å¦‚æœæ²¡æœ‰é€€å®¿æ—¥æœŸï¼Œè·³è¿‡è¿™æ¡è®°å½•
                        if (!checkOutDate) {
                            error++;
                            if (errorDetails.length < 5) {
                                errorDetails.push(`ç¬¬${index + 2}è¡Œ:ç¼ºå°‘é€€å®¿æ—¥æœŸ`);
                            }
                            return;
                        }
                        
                        records.push({
                            id: Date.now() + Math.random(),
                            name: getName(['å§“å', 'å‘˜å·¥å§“å', 'name', 'åå­—']) || '',
                            idCard: idCard || '',
                            gender: gender,
                            birthDate: birthDate,
                            age: age,
                            phone: phone || '',
                            address: getName(['åœ°å€', 'å®¶åº­åœ°å€', 'address', 'ä½å€']) || '',
                            ethnicity: getName(['æ°‘æ—', 'ethnicity']) || '',
                            sourceUnit: getName(['æ¥æºå•ä½', 'åŸå•ä½', 'sourceUnit', 'å•ä½']) || '',
                            department: getName(['éƒ¨é—¨', 'å…¥èŒéƒ¨é—¨', 'æ‰€å±éƒ¨é—¨', 'department']) || '',
                            building: getName(['æ¥¼æ ‹', 'å®¿èˆæ¥¼æ ‹', 'åŸæ¥¼æ ‹', 'building', 'å®¿èˆ']) || '',
                            room: getName(['æˆ¿é—´', 'æˆ¿é—´å·', 'åŸæˆ¿é—´', 'room', 'æˆ¿å·'])?.toString() || '',
                            bed: getName(['åºŠä½', 'åºŠä½å·', 'åŸåºŠä½', 'bed', 'åºŠå·'])?.toString() || '',
                            checkInDate: formatDate(getName(['å…¥ä½æ—¥æœŸ', 'å…¥ä½æ—¶é—´', 'checkInDate', 'å…¥ä½'])),
                            checkOutDate: checkOutDate,
                            checkOutReason: getName(['é€€å®¿åŸå› ', 'åŸå› ', 'checkOutReason', 'é€€æˆ¿åŸå› ']) || '',
                            emergencyContact: getName(['ç´§æ€¥è”ç³»äºº', 'è”ç³»äºº', 'emergencyContact', 'å®¶å±']) || '',
                            emergencyPhone: getName(['ç´§æ€¥è”ç³»ç”µè¯', 'ç´§æ€¥ç”µè¯', 'emergencyPhone', 'å®¶å±ç”µè¯'])?.toString() || '',
                            resignDate: formatDate(getName(['ç¦»èŒæ—¥æœŸ', 'ç¦»èŒæ—¶é—´', 'resignDate', 'ç¦»èŒ'])),
                            handover: getName(['äº¤å‰²æ‰‹ç»­', 'äº¤æ¥çŠ¶æ€', 'handover', 'äº¤æ¥']) || '',
                            notes: getName(['å¤‡æ³¨', 'è¯´æ˜', 'notes', 'å¤‡æ³¨è¯´æ˜']) || '',
                            recordTime: new Date().toLocaleString('zh-CN')
                        });
                        success++;
                    });
                    
                    localStorage.setItem('dormRecords', JSON.stringify(records));
                    renderCheckoutTable();
                    closeImportCheckout();
                    
                    let message = `å¯¼å…¥å®Œæˆ!\næˆåŠŸ: ${success} æ¡\nå¤±è´¥: ${error} æ¡`;
                    if (errorDetails.length > 0) {
                        message += '\n\né”™è¯¯è¯¦æƒ…:\n' + errorDetails.join('\n');
                        if (error > errorDetails.length) {
                            message += `\n...è¿˜æœ‰ ${error - errorDetails.length} æ¡é”™è¯¯`;
                        }
                    }
                    alert(message);
                } catch (err) {
                    alert('æ–‡ä»¶è§£æå¤±è´¥: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function handleImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, {type: 'array', cellText: false, cellDates: true});
                    
                    // æ£€æŸ¥å·¥ä½œç°¿ä¸­çš„sheetæ•°é‡
                    const sheetNames = wb.SheetNames;
                    console.log('æ£€æµ‹åˆ°çš„Sheet:', sheetNames);
                    
                    // ç»Ÿè®¡ä¿¡æ¯
                    let totalSuccess = 0;
                    let totalError = 0;
                    let importSummary = [];
                    
                    // å¤„ç†åœ¨èŒäººå‘˜sheetï¼ˆå¯èƒ½çš„åç§°ï¼šåœ¨èŒäººå‘˜ã€äººå‘˜è¯¦ç»†ä¿¡æ¯ã€Sheet1ç­‰ï¼‰
                    const activeSheetNames = ['åœ¨èŒäººå‘˜', 'äººå‘˜è¯¦ç»†ä¿¡æ¯', 'åœ¨ä½äººå‘˜', 'äººå‘˜åˆ—è¡¨'];
                    const activeSheet = sheetNames.find(name => activeSheetNames.some(n => name.includes(n))) || sheetNames[0];
                    
                    if (activeSheet && wb.Sheets[activeSheet]) {
                        const result = importActivePersonnel(wb.Sheets[activeSheet], activeSheet);
                        totalSuccess += result.success;
                        totalError += result.error;
                        importSummary.push(`ğŸ“‹ ${activeSheet}: æˆåŠŸ${result.success}æ¡, å¤±è´¥${result.error}æ¡`);
                    }
                    
                    // å¤„ç†é€€å®¿äººå‘˜sheet
                    const checkoutSheetNames = ['é€€å®¿äººå‘˜', 'é€€å®¿', 'ç¦»èŒäººå‘˜'];
                    const checkoutSheet = sheetNames.find(name => checkoutSheetNames.some(n => name.includes(n)));
                    
                    if (checkoutSheet && wb.Sheets[checkoutSheet]) {
                        const result = importCheckoutPersonnel(wb.Sheets[checkoutSheet], checkoutSheet);
                        totalSuccess += result.success;
                        totalError += result.error;
                        importSummary.push(`ğŸ“‹ ${checkoutSheet}: æˆåŠŸ${result.success}æ¡, å¤±è´¥${result.error}æ¡`);
                    }
                    
                    // å¤„ç†æˆ¿é—´é…ç½®sheet
                    const roomSheetNames = ['æˆ¿é—´ç®¡ç†', 'æˆ¿é—´é…ç½®', 'æˆ¿é—´', 'å®¿èˆé…ç½®'];
                    const roomSheet = sheetNames.find(name => roomSheetNames.some(n => name.includes(n)));
                    
                    if (roomSheet && wb.Sheets[roomSheet]) {
                        const result = importRooms(wb.Sheets[roomSheet], roomSheet);
                        totalSuccess += result.success;
                        totalError += result.error;
                        importSummary.push(`ğŸ“‹ ${roomSheet}: æˆåŠŸ${result.success}æ¡, å¤±è´¥${result.error}æ¡`);
                    }
                    
                    // æ˜¾ç¤ºå¯¼å…¥ç»“æœ
                    let message = `ğŸ‰ æ‰¹é‡å¯¼å…¥å®Œæˆ!\n\n`;
                    message += `æ€»è®¡: æˆåŠŸ${totalSuccess}æ¡, å¤±è´¥${totalError}æ¡\n\n`;
                    message += `è¯¦ç»†ä¿¡æ¯:\n${importSummary.join('\n')}`;
                    
                    alert(message);
                    
                    // åˆ·æ–°ç•Œé¢
                    filterRecords();
                    renderRooms();
                    closeImport();
                    
                } catch (err) {
                    console.error('å¯¼å…¥é”™è¯¯:', err);
                    alert('å¯¼å…¥å¤±è´¥: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // å¯¼å…¥åœ¨èŒäººå‘˜
        function importActivePersonnel(ws, sheetName) {
            const json = XLSX.utils.sheet_to_json(ws, {raw: false, defval: ''});
            
            if (json.length === 0) {
                return { success: 0, error: 0 };
            }
            
            let success = 0;
            let error = 0;
            
            function formatDate(dateValue) {
                if (!dateValue) return '';
                
                if (typeof dateValue === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
                    return dateValue;
                }
                
                let date;
                
                if (typeof dateValue === 'number') {
                    date = new Date((dateValue - 25569) * 86400 * 1000);
                }
                else if (typeof dateValue === 'string') {
                    dateValue = dateValue.trim();
                    
                    if (/^\d{4}[/-]\d{1,2}[/-]\d{1,2}$/.test(dateValue)) {
                        const parts = dateValue.split(/[/-]/);
                        date = new Date(parts[0], parts[1] - 1, parts[2]);
                    }
                    else if (/^\d{1,2}[/-]\d{1,2}[/-]\d{4}$/.test(dateValue)) {
                        const parts = dateValue.split(/[/-]/);
                        date = new Date(parts[2], parts[1] - 1, parts[0]);
                    }
                    else if (/^\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥?$/.test(dateValue)) {
                        const matches = dateValue.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})/);
                        if (matches) {
                            date = new Date(matches[1], matches[2] - 1, matches[3]);
                        }
                    }
                    else {
                        date = new Date(dateValue);
                    }
                }
                else if (dateValue instanceof Date) {
                    date = dateValue;
                }
                
                if (!date || isNaN(date.getTime())) {
                    return dateValue;
                }
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                
                return `${year}-${month}-${day}`;
            }
            
            json.forEach((row, index) => {
                const getName = (names) => {
                    for (let name of names) {
                        const value = row[name];
                        if (value !== undefined && value !== null && value !== '') {
                            return value;
                        }
                    }
                    return '';
                };
                
                let idCard = getName([
                    'èº«ä»½è¯å·', 'èº«ä»½è¯å·ç ', 'èº«ä»½è¯', 'ID', 'idCard', 
                    'è¯ä»¶å·', 'è¯ä»¶å·ç ', 'èº«ä»½è¯ å·ç ', 'èº«ä»½è¯ å·',
                    'ID Card', 'IdCard', 'IDCARD', 'èº«ä»½è¯ä»¶å·ç '
                ]);
                
                if (idCard) {
                    idCard = String(idCard);
                    idCard = idCard.replace(/[\s\n\r\t]/g, '');
                    idCard = idCard.toUpperCase();
                    
                    if (idCard.includes('E+') || idCard.includes('e+')) {
                        try {
                            const num = parseFloat(idCard);
                            idCard = num.toFixed(0);
                        } catch (err) {
                            idCard = '';
                        }
                    }
                }
                
                let gender = getName(['æ€§åˆ«', 'gender', 'ç”·å¥³']) || '';
                let age = getName(['å¹´é¾„', 'age'])?.toString() || '';
                let birthDate = getName(['å‡ºç”Ÿæ—¥æœŸ', 'ç”Ÿæ—¥', 'birthDate', 'å‡ºç”Ÿ']) || '';
                
                if (idCard && idCard.length === 18 && /^\d{17}[\dX]$/.test(idCard)) {
                    const genderCode = parseInt(idCard.charAt(16));
                    gender = genderCode % 2 === 1 ? 'ç”·' : 'å¥³';
                    const year = parseInt(idCard.substring(6, 10));
                    const month = idCard.substring(10, 12);
                    const day = idCard.substring(12, 14);
                    birthDate = `${year}-${month}-${day}`;
                    age = (new Date().getFullYear() - year).toString();
                }
                
                let phone = getName(['ç”µè¯', 'è”ç³»ç”µè¯', 'æ‰‹æœºå·', 'phone', 'æ‰‹æœº', 'è”ç³»æ–¹å¼']);
                if (phone) {
                    phone = String(phone).replace(/[\s\n\r\t]/g, '');
                }
                
                records.push({
                    id: Date.now() + Math.random(),
                    name: getName(['å§“å', 'å‘˜å·¥å§“å', 'name', 'åå­—']) || '',
                    idCard: idCard || '',
                    gender: gender,
                    birthDate: birthDate,
                    age: age,
                    phone: phone || '',
                    address: getName(['åœ°å€', 'å®¶åº­åœ°å€', 'address', 'ä½å€']) || '',
                    ethnicity: getName(['æ°‘æ—', 'ethnicity']) || '',
                    sourceUnit: getName(['æ¥æºå•ä½', 'åŸå•ä½', 'sourceUnit', 'å•ä½']) || '',
                    department: getName(['éƒ¨é—¨', 'å…¥èŒéƒ¨é—¨', 'æ‰€å±éƒ¨é—¨', 'department']) || '',
                    building: getName(['æ¥¼æ ‹', 'å®¿èˆæ¥¼æ ‹', 'æ¥¼å±‚', 'building', 'å®¿èˆ']) || '',
                    room: getName(['æˆ¿é—´', 'æˆ¿é—´å·', 'room', 'æˆ¿å·'])?.toString() || '',
                    bed: getName(['åºŠä½', 'åºŠä½å·', 'bed', 'åºŠå·'])?.toString() || '',
                    checkInDate: formatDate(getName(['å…¥ä½æ—¥æœŸ', 'å…¥ä½æ—¶é—´', 'checkInDate', 'å…¥ä½'])),
                    emergencyContact: getName(['ç´§æ€¥è”ç³»äºº', 'è”ç³»äºº', 'emergencyContact', 'å®¶å±']) || '',
                    emergencyPhone: getName(['ç´§æ€¥è”ç³»ç”µè¯', 'ç´§æ€¥ç”µè¯', 'emergencyPhone', 'å®¶å±ç”µè¯'])?.toString() || '',
                    resignDate: formatDate(getName(['ç¦»èŒæ—¥æœŸ', 'ç¦»èŒæ—¶é—´', 'resignDate', 'ç¦»èŒ'])),
                    handover: getName(['äº¤å‰²æ‰‹ç»­', 'äº¤æ¥çŠ¶æ€', 'handover', 'äº¤æ¥']) || '',
                    notes: getName(['å¤‡æ³¨', 'è¯´æ˜', 'notes', 'å¤‡æ³¨è¯´æ˜']) || '',
                    recordTime: new Date().toLocaleString()
                });
                success++;
            });
            
            localStorage.setItem('dormRecords', JSON.stringify(records));
            return { success, error };
        }
        
        // å¯¼å…¥é€€å®¿äººå‘˜
        function importCheckoutPersonnel(ws, sheetName) {
            const json = XLSX.utils.sheet_to_json(ws, {raw: false, defval: ''});
            
            if (json.length === 0) {
                return { success: 0, error: 0 };
            }
            
            let success = 0;
            let error = 0;
            
            function formatDate(dateValue) {
                if (!dateValue) return '';
                
                if (typeof dateValue === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
                    return dateValue;
                }
                
                let date;
                
                if (typeof dateValue === 'number') {
                    date = new Date((dateValue - 25569) * 86400 * 1000);
                }
                else if (typeof dateValue === 'string') {
                    dateValue = dateValue.trim();
                    
                    if (/^\d{4}[/-]\d{1,2}[/-]\d{1,2}$/.test(dateValue)) {
                        const parts = dateValue.split(/[/-]/);
                        date = new Date(parts[0], parts[1] - 1, parts[2]);
                    }
                    else {
                        date = new Date(dateValue);
                    }
                }
                else if (dateValue instanceof Date) {
                    date = dateValue;
                }
                
                if (!date || isNaN(date.getTime())) {
                    return dateValue;
                }
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                
                return `${year}-${month}-${day}`;
            }
            
            json.forEach((row, index) => {
                const getName = (names) => {
                    for (let name of names) {
                        const value = row[name];
                        if (value !== undefined && value !== null && value !== '') {
                            return value;
                        }
                    }
                    return '';
                };
                
                let idCard = getName(['èº«ä»½è¯å·', 'èº«ä»½è¯å·ç ', 'èº«ä»½è¯', 'ID', 'idCard']);
                if (idCard) {
                    idCard = String(idCard).replace(/[\s\n\r\t]/g, '').toUpperCase();
                }
                
                let phone = getName(['ç”µè¯', 'è”ç³»ç”µè¯', 'æ‰‹æœºå·', 'phone']);
                if (phone) {
                    phone = String(phone).replace(/[\s\n\r\t]/g, '');
                }
                
                records.push({
                    id: Date.now() + Math.random(),
                    name: getName(['å§“å', 'name']) || '',
                    idCard: idCard || '',
                    gender: getName(['æ€§åˆ«', 'gender']) || '',
                    birthDate: getName(['å‡ºç”Ÿæ—¥æœŸ', 'birthDate']) || '',
                    age: getName(['å¹´é¾„', 'age'])?.toString() || '',
                    phone: phone || '',
                    address: getName(['åœ°å€', 'address']) || '',
                    ethnicity: getName(['æ°‘æ—', 'ethnicity']) || '',
                    sourceUnit: getName(['æ¥æºå•ä½', 'sourceUnit']) || '',
                    department: getName(['éƒ¨é—¨', 'department']) || '',
                    building: getName(['æ¥¼æ ‹', 'åŸæ¥¼æ ‹', 'building']) || '',
                    room: getName(['æˆ¿é—´', 'åŸæˆ¿é—´', 'room'])?.toString() || '',
                    bed: getName(['åºŠä½', 'åŸåºŠä½', 'bed'])?.toString() || '',
                    checkInDate: formatDate(getName(['å…¥ä½æ—¥æœŸ', 'checkInDate'])),
                    checkOutDate: formatDate(getName(['é€€å®¿æ—¥æœŸ', 'checkOutDate'])),
                    checkOutReason: getName(['é€€å®¿åŸå› ', 'checkOutReason']) || '',
                    resignDate: formatDate(getName(['ç¦»èŒæ—¥æœŸ', 'resignDate'])),
                    handover: getName(['äº¤å‰²æ‰‹ç»­', 'handover']) || '',
                    emergencyContact: getName(['ç´§æ€¥è”ç³»äºº', 'emergencyContact']) || '',
                    emergencyPhone: getName(['ç´§æ€¥ç”µè¯', 'emergencyPhone'])?.toString() || '',
                    notes: getName(['å¤‡æ³¨', 'notes']) || '',
                    recordTime: new Date().toLocaleString()
                });
                success++;
            });
            
            localStorage.setItem('dormRecords', JSON.stringify(records));
            return { success, error };
        }
        
        // å¯¼å…¥æˆ¿é—´é…ç½®
        function importRooms(ws, sheetName) {
            const json = XLSX.utils.sheet_to_json(ws, {raw: false, defval: ''});
            
            if (json.length === 0) {
                return { success: 0, error: 0 };
            }
            
            let success = 0;
            let error = 0;
            
            json.forEach((row, index) => {
                const getName = (names) => {
                    for (let name of names) {
                        const value = row[name];
                        if (value !== undefined && value !== null && value !== '') {
                            return value;
                        }
                    }
                    return '';
                };
                
                const building = getName(['æ¥¼æ ‹', 'building']);
                const room = getName(['æˆ¿é—´å·', 'æˆ¿é—´', 'room']);
                const beds = parseInt(getName(['åºŠä½æ•°', 'åºŠä½', 'beds'])) || 0;
                const notes = getName(['å¤‡æ³¨', 'notes']) || '';
                
                if (!building || !room || beds <= 0) {
                    error++;
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const existing = rooms.find(r => r.building === building && r.room === room);
                if (existing) {
                    // æ›´æ–°ç°æœ‰æˆ¿é—´
                    existing.beds = beds;
                    existing.notes = notes;
                    success++;
                } else {
                    // æ·»åŠ æ–°æˆ¿é—´
                    rooms.push({
                        id: Date.now() + Math.random(),
                        building,
                        room,
                        beds,
                        notes
                    });
                    success++;
                }
            });
            
            localStorage.setItem('dormRooms', JSON.stringify(rooms));
            return { success, error };
        }
        
        // ä¿ç•™åŸæœ‰çš„å•sheetå¯¼å…¥åŠŸèƒ½ä½œä¸ºå¤‡ç”¨
        function handleImportOld(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, {type: 'array', cellText: false, cellDates: true});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws, {raw: false, defval: ''});
                    
                    if (json.length === 0) {
                        alert('Excelæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®!');
                        return;
                    }
                    
                    // å•sheetå¯¼å…¥é€»è¾‘ï¼ˆå¤‡ç”¨ï¼‰
                    alert('æ£€æµ‹åˆ°å•ä¸ªSheetï¼Œå»ºè®®ä½¿ç”¨å¯¼å‡ºçš„å¤šSheetæ ¼å¼Excel');
                    
                } catch (err) {
                    alert('âŒ æ–‡ä»¶è§£æå¤±è´¥:' + err.message);
                    console.error('å¯¼å…¥é”™è¯¯:', err);
                }
            };
            reader.readAsArrayBuffer(file);
            e.target.value = '';
        }

        // æˆ¿é—´ç®¡ç†åŠŸèƒ½
        function renderRooms() {
            const container = document.getElementById('roomsContainer');
            const isAdmin = currentUser.role === 'admin';
            
            // æŒ‰æ¥¼æ ‹åˆ†ç»„
            const buildingGroups = {};
            rooms.forEach(room => {
                if (!buildingGroups[room.building]) {
                    buildingGroups[room.building] = [];
                }
                buildingGroups[room.building].push(room);
            });
            
            let html = '';
            
            Object.keys(buildingGroups).sort().forEach(building => {
                const buildingRooms = buildingGroups[building];
                const totalBeds = buildingRooms.reduce((sum, r) => sum + (parseInt(r.beds) || 0), 0);
                
                html += `
                    <div class="building-section">
                        <h3>${building} (${buildingRooms.length} ä¸ªæˆ¿é—´, ${totalBeds} å¼ åºŠä½)</h3>
                        <table>
                            <thead>
                                <tr>
                                    ${isAdmin ? `<th style="width:50px;">
                                        <div class="checkbox-wrapper">
                                            <input type="checkbox" class="select-all-rooms" onchange="toggleSelectAllRooms('${building}')">
                                        </div>
                                    </th>` : ''}
                                    <th>åºå·</th>
                                    <th>æˆ¿é—´å·</th>
                                    <th>åºŠä½æ•°</th>
                                    <th>å¤‡æ³¨</th>
                                    ${isAdmin ? '<th>æ“ä½œ</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${buildingRooms.sort((a, b) => {
                                    const numA = parseInt(a.room) || 0;
                                    const numB = parseInt(b.room) || 0;
                                    return numA - numB;
                                }).map((room, i) => `
                                    <tr>
                                        ${isAdmin ? `<td>
                                            <div class="checkbox-wrapper">
                                                <input type="checkbox" class="room-checkbox" data-id="${room.id}" onchange="updateRoomSelection()">
                                            </div>
                                        </td>` : ''}
                                        <td>${i + 1}</td>
                                        <td>${room.room}</td>
                                        <td>${room.beds}</td>
                                        <td>${room.notes || '-'}</td>
                                        ${isAdmin ? `<td>
                                            <button class="btn btn-info" onclick="editRoom(${room.id})">ç¼–è¾‘</button>
                                            <button class="btn btn-danger" onclick="deleteRoom(${room.id})">åˆ é™¤</button>
                                        </td>` : ''}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<p style="text-align:center;color:#999;padding:30px;">æš‚æ— æˆ¿é—´é…ç½®,è¯·ç‚¹å‡»"æ·»åŠ æˆ¿é—´"æŒ‰é’®å¼€å§‹é…ç½®</p>';
            }
            
            container.innerHTML = html;
        }

        function showAddRoom() {
            if (currentUser.role !== 'admin') {
                alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ·»åŠ æˆ¿é—´');
                return;
            }
            editingRoomId = null;
            document.getElementById('roomModalTitle').textContent = 'æ·»åŠ æˆ¿é—´';
            document.getElementById('roomBuilding').value = '';
            document.getElementById('roomNumber').value = '';
            document.getElementById('roomBeds').value = '';
            document.getElementById('roomNotes').value = '';
            document.getElementById('roomModal').classList.add('active');
        }

        function editRoom(id) {
            if (currentUser.role !== 'admin') {
                alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥ç¼–è¾‘æˆ¿é—´');
                return;
            }
            const room = rooms.find(r => r.id === id);
            if (!room) return;
            
            editingRoomId = id;
            document.getElementById('roomModalTitle').textContent = 'ç¼–è¾‘æˆ¿é—´';
            document.getElementById('roomBuilding').value = room.building;
            document.getElementById('roomNumber').value = room.room;
            document.getElementById('roomBeds').value = room.beds;
            document.getElementById('roomNotes').value = room.notes || '';
            document.getElementById('roomModal').classList.add('active');
        }

        function saveRoom(e) {
            e.preventDefault();
            
            if (currentUser.role !== 'admin') {
                alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥ä¿å­˜æˆ¿é—´ä¿¡æ¯');
                return;
            }
            
            const data = {
                id: editingRoomId || Date.now(),
                building: document.getElementById('roomBuilding').value,
                room: document.getElementById('roomNumber').value,
                beds: parseInt(document.getElementById('roomBeds').value) || 0,
                notes: document.getElementById('roomNotes').value
            };
            
            // æ£€æŸ¥æ˜¯å¦é‡å¤
            const isDuplicate = rooms.some(r => 
                r.building === data.building && 
                r.room === data.room && 
                r.id !== editingRoomId
            );
            
            if (isDuplicate) {
                alert('è¯¥æ¥¼æ ‹çš„æˆ¿é—´å·å·²å­˜åœ¨!');
                return;
            }
            
            if (editingRoomId) {
                rooms = rooms.map(r => r.id === editingRoomId ? data : r);
                alert('ä¿®æ”¹æˆåŠŸ!');
            } else {
                rooms.push(data);
                alert('æ·»åŠ æˆåŠŸ!');
            }
            
            localStorage.setItem('dormRooms', JSON.stringify(rooms));
            closeRoomModal();
            renderRooms();
        }

        function closeRoomModal() {
            document.getElementById('roomModal').classList.remove('active');
        }

        function deleteRoom(id) {
            if (currentUser.role !== 'admin') {
                alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤æˆ¿é—´');
                return;
            }
            if (confirm('ç¡®å®šåˆ é™¤è¯¥æˆ¿é—´é…ç½®å—?')) {
                rooms = rooms.filter(r => r.id !== id);
                localStorage.setItem('dormRooms', JSON.stringify(rooms));
                renderRooms();
                alert('åˆ é™¤æˆåŠŸ!');
            }
        }

        function exportRoomsExcel() {
            if (currentUser.role !== 'admin') {
                alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥å¯¼å‡ºæ•°æ®');
                return;
            }
            if (rooms.length === 0) {
                alert('æš‚æ— æˆ¿é—´é…ç½®æ•°æ®');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(rooms.map((r, i) => ({
                åºå·: i + 1,
                æ¥¼æ ‹: r.building,
                æˆ¿é—´å·: r.room,
                åºŠä½æ•°: r.beds,
                å¤‡æ³¨: r.notes || ''
            })));
            
            autoFitColumns(ws); // è‡ªåŠ¨è°ƒæ•´åˆ—å®½
            // è®¾ç½®å†»ç»“é¦–è¡Œ
            ws['!freeze'] = { xSplit: 0, ySplit: 1 };
            XLSX.utils.book_append_sheet(wb, ws, 'æˆ¿é—´é…ç½®');
            XLSX.writeFile(wb, 'æˆ¿é—´é…ç½®_' + new Date().toLocaleDateString('zh-CN').replace(/\//g, '-') + '.xlsx');
        }

        function importRoomsExcel() {
            if (currentUser.role !== 'admin') {
                alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥å¯¼å…¥æˆ¿é—´æ•°æ®');
                return;
            }
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const wb = XLSX.read(data, {type: 'array'});
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(ws, {raw: false, defval: ''});
                        
                        if (json.length === 0) {
                            alert('Excelæ–‡ä»¶ä¸ºç©º!');
                            return;
                        }
                        
                        let success = 0;
                        let error = 0;
                        
                        json.forEach((row, index) => {
                            const building = row['æ¥¼æ ‹'] || row['building'] || '';
                            const room = row['æˆ¿é—´å·'] || row['æˆ¿é—´'] || row['room'] || '';
                            const beds = parseInt(row['åºŠä½æ•°'] || row['åºŠä½'] || row['beds']) || 0;
                            const notes = row['å¤‡æ³¨'] || row['notes'] || '';
                            
                            if (!building || !room || beds <= 0) {
                                error++;
                                return;
                            }
                            
                            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                            const existing = rooms.find(r => r.building === building && r.room === room);
                            if (existing) {
                                error++;
                                return;
                            }
                            
                            rooms.push({
                                id: Date.now() + Math.random(),
                                building,
                                room,
                                beds,
                                notes
                            });
                            success++;
                        });
                        
                        localStorage.setItem('dormRooms', JSON.stringify(rooms));
                        renderRooms();
                        alert(`å¯¼å…¥å®Œæˆ!\næˆåŠŸ: ${success} æ¡\nå¤±è´¥: ${error} æ¡`);
                    } catch (err) {
                        alert('æ–‡ä»¶è§£æå¤±è´¥: ' + err.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            };
            input.click();
        }

        // æˆ¿é—´æ‰¹é‡åˆ é™¤ç›¸å…³å‡½æ•°
        function updateRoomSelection() {
            const checkboxes = document.querySelectorAll('.room-checkbox:checked');
            const count = checkboxes.length;
            
            if (count > 0) {
                document.getElementById('batchActionsRooms').style.display = 'flex';
                document.getElementById('selectedCountRooms').textContent = count;
            } else {
                document.getElementById('batchActionsRooms').style.display = 'none';
            }
            
            // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
            document.querySelectorAll('.select-all-rooms').forEach(selectAll => {
                const section = selectAll.closest('.building-section');
                if (!section) return;
                
                const building = section.querySelector('h3').textContent.split(' ')[0];
                const buildingCheckboxes = Array.from(section.querySelectorAll('.room-checkbox'));
                const buildingChecked = buildingCheckboxes.filter(cb => cb.checked);
                
                selectAll.checked = buildingCheckboxes.length > 0 && buildingCheckboxes.length === buildingChecked.length;
                selectAll.indeterminate = buildingChecked.length > 0 && buildingChecked.length < buildingCheckboxes.length;
            });
        }

        function toggleSelectAllRooms(building) {
            const buildingSections = document.querySelectorAll('.building-section');
            buildingSections.forEach(section => {
                const header = section.querySelector('h3');
                if (header && header.textContent.includes(building)) {
                    const selectAll = section.querySelector('.select-all-rooms');
                    const checkboxes = section.querySelectorAll('.room-checkbox');
                    checkboxes.forEach(cb => cb.checked = selectAll.checked);
                }
            });
            updateRoomSelection();
        }

        function clearSelectionRooms() {
            document.querySelectorAll('.room-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.select-all-rooms').forEach(cb => cb.checked = false);
            updateRoomSelection();
        }

        function batchDeleteRooms() {
            if (currentUser.role !== 'admin') {
                alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ‰¹é‡åˆ é™¤æˆ¿é—´');
                return;
            }
            const checkboxes = document.querySelectorAll('.room-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æˆ¿é—´');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${checkboxes.length} ä¸ªæˆ¿é—´å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }
            
            // è·å–è¦åˆ é™¤çš„IDï¼Œç¡®ä¿ç±»å‹ä¸€è‡´
            const idsToDelete = Array.from(checkboxes).map(cb => {
                const id = cb.dataset.id;
                // å°è¯•è½¬æ¢ä¸ºæ•°å­—ï¼Œå¦‚æœå¤±è´¥åˆ™ä¿æŒåŸæ ·
                const numId = Number(id);
                return isNaN(numId) ? id : numId;
            });
            
            console.log('åˆ é™¤å‰æˆ¿é—´æ•°:', rooms.length);
            console.log('è¦åˆ é™¤çš„IDs:', idsToDelete);
            console.log('ç°æœ‰æˆ¿é—´IDs:', rooms.map(r => r.id));
            
            // è¿‡æ»¤æ‰è¦åˆ é™¤çš„æˆ¿é—´
            const originalLength = rooms.length;
            rooms = rooms.filter(r => !idsToDelete.includes(r.id));
            
            console.log('åˆ é™¤åæˆ¿é—´æ•°:', rooms.length);
            console.log('å®é™…åˆ é™¤æ•°:', originalLength - rooms.length);
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('dormRooms', JSON.stringify(rooms));
            
            // é‡æ–°æ¸²æŸ“
            renderRooms();
            updateRoomSelection();
            
            alert(`æˆåŠŸåˆ é™¤ ${originalLength - rooms.length} ä¸ªæˆ¿é—´`);
        }

        // ========== å®¿èˆå¹³é¢å›¾ç›¸å…³å‡½æ•° ==========
        function renderFloorPlan() {
            const container = document.getElementById('floorplanContainer');
            const activeRecords = records.filter(r => !r.checkOutDate);
            
            if (rooms.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">æš‚æ— æˆ¿é—´é…ç½®ï¼Œè¯·å…ˆåœ¨"æˆ¿é—´ç®¡ç†"ä¸­æ·»åŠ æˆ¿é—´</p>';
                return;
            }
            
            // æŒ‰æ¥¼æ ‹åˆ†ç»„
            const buildingGroups = {};
            rooms.forEach(room => {
                if (!buildingGroups[room.building]) {
                    buildingGroups[room.building] = [];
                }
                buildingGroups[room.building].push(room);
            });
            
            // ç»Ÿè®¡æ¯ä¸ªæˆ¿é—´çš„å…¥ä½æƒ…å†µ
            const roomOccupancy = {};
            activeRecords.forEach(r => {
                if (!r.building || !r.room) return;
                const key = `${r.building}-${r.room}`;
                if (!roomOccupancy[key]) {
                    roomOccupancy[key] = [];
                }
                roomOccupancy[key].push(r);
            });
            
            let html = '';
            
            // éå†æ¯ä¸ªæ¥¼æ ‹
            Object.keys(buildingGroups).sort().forEach(building => {
                const buildingRooms = buildingGroups[building];
                
                // è®¡ç®—å½“å‰æ¥¼æ ‹çš„ç»Ÿè®¡æ•°æ®
                let buildingTotalBeds = 0;
                let buildingOccupiedBeds = 0;
                
                buildingRooms.forEach(room => {
                    const totalBeds = parseInt(room.beds) || 0;
                    buildingTotalBeds += totalBeds;
                    const key = `${room.building}-${room.room}`;
                    const occupants = roomOccupancy[key] || [];
                    buildingOccupiedBeds += occupants.length;
                });
                
                const buildingAvailableBeds = buildingTotalBeds - buildingOccupiedBeds;
                const buildingOccupancyRate = buildingTotalBeds > 0 
                    ? Math.round((buildingOccupiedBeds / buildingTotalBeds) * 100) 
                    : 0;
                
                html += `
                    <div class="floorplan-building">
                        <div class="floorplan-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${building}</span>
                            <span style="font-size: 16px; font-weight: normal; display: flex; gap: 30px;">
                                <span><strong style="color: #e3f2fd; margin-right: 5px;">${buildingTotalBeds}</strong>æ€»åºŠä½</span>
                                <span><strong style="color: #ffcdd2; margin-right: 5px;">${buildingOccupiedBeds}</strong>å·²å…¥ä½</span>
                                <span><strong style="color: #c8e6c9; margin-right: 5px;">${buildingAvailableBeds}</strong>å‰©ä½™</span>
                                <span><strong style="color: #ffe0b2; margin-right: 5px;">${buildingOccupancyRate}%</strong>å…¥ä½ç‡</span>
                            </span>
                        </div>
                `;
                
                // ç‰¹æ®Šå¤„ç†åŠå…¬ä¸‰æ¥¼ï¼šæŒ‰åŒ—/å—åˆ†ç»„
                if (building === 'åŠå…¬ä¸‰æ¥¼') {
                    // åˆ†ç»„æˆ¿é—´
                    const northRooms = buildingRooms.filter(room => room.room.includes('åŒ—'));
                    const southRooms = buildingRooms.filter(room => room.room.includes('å—'));
                    
                    // æ’åºå‡½æ•°ï¼šæå–æ•°å­—éƒ¨åˆ†è¿›è¡Œæ’åº
                    const sortByNumber = (a, b) => {
                        const numA = parseInt(a.room.match(/\d+/)?.[0]) || 0;
                        const numB = parseInt(b.room.match(/\d+/)?.[0]) || 0;
                        return numA - numB;
                    };
                    
                    northRooms.sort(sortByNumber);
                    southRooms.sort(sortByNumber);
                    
                    // åŒ—ä¾§æˆ¿é—´
                    if (northRooms.length > 0) {
                        html += `<div style="padding: 10px 20px; background: #f5f5f5;"><strong>åŒ—ä¾§</strong></div>`;
                        html += `<div class="floorplan-rooms">`;
                        northRooms.forEach(room => {
                            html += generateRoomCard(room, roomOccupancy);
                        });
                        html += `</div>`;
                    }
                    
                    // å—ä¾§æˆ¿é—´
                    if (southRooms.length > 0) {
                        html += `<div style="padding: 10px 20px; background: #f5f5f5;"><strong>å—ä¾§</strong></div>`;
                        html += `<div class="floorplan-rooms">`;
                        southRooms.forEach(room => {
                            html += generateRoomCard(room, roomOccupancy);
                        });
                        html += `</div>`;
                    }
                } else {
                    // å…¶ä»–æ¥¼æ ‹ï¼šæ­£å¸¸æ’åºæ˜¾ç¤º
                    html += `<div class="floorplan-rooms">`;
                    buildingRooms.sort((a, b) => {
                        const numA = parseInt(a.room) || 0;
                        const numB = parseInt(b.room) || 0;
                        return numA - numB;
                    }).forEach(room => {
                        html += generateRoomCard(room, roomOccupancy);
                    });
                    html += `</div>`;
                }
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }
        
        // ç”Ÿæˆæˆ¿é—´å¡ç‰‡çš„è¾…åŠ©å‡½æ•°
        function generateRoomCard(room, roomOccupancy) {
            const key = `${room.building}-${room.room}`;
            const occupants = roomOccupancy[key] || [];
            const totalBeds = parseInt(room.beds) || 0;
            const occupiedBeds = occupants.length;
            
            // ç¡®å®šæˆ¿é—´çŠ¶æ€
            let status = 'empty';
            let statusText = 'ç©ºæˆ¿';
            let statusBadge = 'ç©ºæˆ¿';
            
            if (occupiedBeds >= totalBeds && totalBeds > 0) {
                status = 'full';
                statusText = 'å·²æ»¡';
                statusBadge = 'å·²æ»¡';
            } else if (occupiedBeds > 0) {
                status = 'partial';
                statusText = 'éƒ¨åˆ†å…¥ä½';
                statusBadge = 'éƒ¨åˆ†';
            }
            
            return `
                <div class="room-card ${status}" onclick="showRoomDetail('${room.building}', '${room.room}')">
                    <div class="room-badge ${status}">${statusBadge}</div>
                    <div class="room-number">${room.room}å·æˆ¿</div>
                    <div class="room-status">${statusText}</div>
                    <div class="room-beds">
                        å·²å…¥ä½: <strong style="color:#f44336;">${occupiedBeds}</strong> / 
                        æ€»åºŠä½: <strong>${totalBeds}</strong>
                    </div>
                    ${room.notes ? `<div style="font-size:11px;color:#999;margin-top:5px;">${room.notes}</div>` : ''}
                </div>
            `;
        }

        function showRoomDetail(building, roomNumber) {
            const room = rooms.find(r => r.building === building && r.room === roomNumber);
            if (!room) {
                alert('æˆ¿é—´ä¿¡æ¯ä¸å­˜åœ¨');
                return;
            }
            
            const activeRecords = records.filter(r => !r.checkOutDate);
            const occupants = activeRecords.filter(r => r.building === building && r.room === roomNumber);
            const totalBeds = parseInt(room.beds) || 0;
            const occupiedBeds = occupants.length;
            const availableBeds = totalBeds - occupiedBeds;
            
            // è·å–æ‰€æœ‰å·²å ç”¨çš„åºŠä½å·
            const occupiedBedNumbers = new Set(occupants.map(r => r.bed).filter(Boolean));
            
            // ç”ŸæˆåºŠä½å¯è§†åŒ–
            let bedVisualHtml = '<div class="bed-visual">';
            for (let i = 1; i <= totalBeds; i++) {
                const isOccupied = occupiedBedNumbers.has(i.toString()) || occupiedBedNumbers.has(i);
                const occupant = occupants.find(r => r.bed == i);
                
                if (isOccupied && occupant) {
                    bedVisualHtml += `
                        <div class="bed-item occupied" title="${occupant.name}">
                            ${i}å·åºŠ<br>
                            <small>${occupant.name}</small>
                        </div>
                    `;
                } else {
                    bedVisualHtml += `
                        <div class="bed-item empty">
                            ${i}å·åºŠ<br>
                            <small>ç©ºé—²</small>
                        </div>
                    `;
                }
            }
            bedVisualHtml += '</div>';
            
            // ç”Ÿæˆå…¥ä½äººå‘˜åˆ—è¡¨
            let residentsHtml = '';
            if (occupants.length > 0) {
                residentsHtml = '<div class="resident-list">';
                residentsHtml += '<h4 style="margin-bottom:10px;">å…¥ä½äººå‘˜ï¼š</h4>';
                
                occupants.forEach(person => {
                    residentsHtml += `
                        <div class="resident-item">
                            <div class="resident-name">${person.name} - ${person.bed}å·åºŠ</div>
                            <div class="resident-info">
                                <span>æ€§åˆ«: ${person.gender}</span>
                                <span>å¹´é¾„: ${person.age}</span>
                                <span>ç”µè¯: ${person.phone}</span>
                                ${person.department ? `<span>éƒ¨é—¨: ${person.department}</span>` : ''}
                                ${person.checkInDate ? `<span>å…¥ä½æ—¥æœŸ: ${person.checkInDate}</span>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                residentsHtml += '</div>';
            } else {
                residentsHtml = '<p style="text-align:center;color:#999;padding:20px;background:#f5f5f5;border-radius:6px;">è¯¥æˆ¿é—´æš‚æ— å…¥ä½äººå‘˜</p>';
            }
            
            const content = `
                <div style="background:#f5f5f5;padding:15px;border-radius:6px;margin-bottom:15px;">
                    <div style="display:flex;justify-content:space-around;text-align:center;">
                        <div>
                            <div style="font-size:20px;font-weight:bold;color:#2196F3;">${totalBeds}</div>
                            <div style="color:#666;font-size:13px;">æ€»åºŠä½</div>
                        </div>
                        <div>
                            <div style="font-size:20px;font-weight:bold;color:#f44336;">${occupiedBeds}</div>
                            <div style="color:#666;font-size:13px;">å·²å…¥ä½</div>
                        </div>
                        <div>
                            <div style="font-size:20px;font-weight:bold;color:#4CAF50;">${availableBeds}</div>
                            <div style="color:#666;font-size:13px;">å‰©ä½™</div>
                        </div>
                    </div>
                </div>
                
                <h4 style="margin:15px 0 10px 0;">åºŠä½åˆ†å¸ƒï¼š</h4>
                ${bedVisualHtml}
                
                ${residentsHtml}
            `;
            
            document.getElementById('roomDetailTitle').textContent = `${building} - ${roomNumber}å·æˆ¿`;
            document.getElementById('roomDetailContent').innerHTML = content;
            document.getElementById('roomDetailModal').classList.add('active');
        }

        function closeRoomDetail() {
            document.getElementById('roomDetailModal').classList.remove('active');
        }

        // ========== åˆå§‹åŒ– ==========
        window.onload = async function() {
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            const savedUser = localStorage.getItem('currentUser');
            
            // å¦‚æœå·²ç™»å½•ï¼Œç›´æ¥æ˜¾ç¤ºä¸»åº”ç”¨ï¼Œä¸éœ€è¦å…¶ä»–æ£€æŸ¥
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    // å¼‚æ­¥åŠ è½½ç”¨æˆ·æ•°æ®ï¼ˆä¸é˜»å¡ç™»å½•ï¼‰
                    loadUsersFromGitHub().catch(err => console.error('åŠ è½½äº‘ç«¯æ•°æ®å¤±è´¥:', err));
                    showMainApp();
                    return;
                } catch (error) {
                    console.error('è§£æç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                    localStorage.removeItem('currentUser');
                }
            }
            
            // æœªç™»å½•ï¼šä¼˜å…ˆä»GitHubåŠ è½½ç”¨æˆ·æ•°æ®
            await loadUsersFromGitHub();
            
            // æ£€æŸ¥æ˜¯å¦é¦–æ¬¡ä½¿ç”¨ï¼ˆåªæœ‰åœ¨æœ¬åœ°å’Œäº‘ç«¯éƒ½æ²¡æœ‰ç”¨æˆ·æ•°æ®æ—¶æ‰æç¤ºï¼‰
            const needSetup = checkFirstTimeUse();
            
            // å¦‚æœä¸éœ€è¦è®¾ç½®ï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢
            if (!needSetup) {
                showLoginScreen();
            }
        };
    </script>
</body>
</html>